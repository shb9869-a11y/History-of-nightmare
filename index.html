<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Audience Overlay — Dual Preload Ninja</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:"Courier New",monospace}
  #view{position:fixed;inset:0;width:100%;height:100%;display:block;z-index:0}
  .ninja{position:fixed;inset:0;width:100%;height:100%;border:0;pointer-events:none;opacity:0;transition:opacity .35s ease}
  .ninja.show{opacity:1}
  .controls{position:fixed;right:16px;bottom:16px;z-index:100;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .uiBtn{background:#000;color:#fff;border:1px solid #333;padding:.5em .9em;cursor:pointer}
  .readout{color:#aaa;background:#000;border:1px dashed #333;padding:.3em .6em}
  .status{position:fixed;left:16px;bottom:16px;z-index:100;color:#aaa;background:#000;border:1px dashed #333;padding:.3em .6em}
</style>
</head>
<body>
  <!-- 관객 카메라 캔버스(배경) -->
  <canvas id="view"></canvas>

  <!-- 이중 프리로드: 활성 A / 대기 B -->
  <iframe id="ninjaA" class="ninja" allow="autoplay; fullscreen; camera; microphone" referrerpolicy="no-referrer"></iframe>
  <iframe id="ninjaB" class="ninja" allow="autoplay; fullscreen; camera; microphone" referrerpolicy="no-referrer"></iframe>

  <div class="controls">
    <button class="uiBtn" id="toggleOverlay">Overlay OFF</button>
    <button class="uiBtn" id="reconnect">Force Reconnect</button>
    <span class="readout" id="readout">idle</span>
  </div>
  <div class="status" id="status">standby</div>

<script>
(()=>{
// ===== 설정 =====
const ROOM_ID = "YOURROOMID"; // ← 여기만 네 룸 아이디로
const base = `https://vdo.ninja/?view=${encodeURIComponent(ROOM_ID)}&clean&autostart&noaudio&codec=vp8&solo`;
const freshUrl = () => `${base}&ts=${Date.now()}`; // 캐시/세션 우회

// ===== 요소 =====
const view = document.getElementById('view');
const vctx = view.getContext('2d', {alpha:false});
const ninjaA = document.getElementById('ninjaA');
const ninjaB = document.getElementById('ninjaB');
const btnToggle = document.getElementById('toggleOverlay');
const btnReconnect = document.getElementById('reconnect');
const readout = document.getElementById('readout');
const statusEl = document.getElementById('status');

// ===== 배경 카메라 =====
const cam = document.createElement('video');
cam.autoplay = true; cam.muted = true; cam.playsInline = true;

function fit(){
  const dpr = devicePixelRatio || 1;
  view.width = innerWidth*dpr; view.height = innerHeight*dpr;
  vctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener('resize', fit);

async function startCamera(){
  const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
  cam.srcObject = s; await cam.play().catch(()=>{});
}

function drawLoop(){
  requestAnimationFrame(drawLoop);
  fit();
  const W = view.width/(devicePixelRatio||1), H = view.height/(devicePixelRatio||1);
  vctx.clearRect(0,0,W,H);
  if (cam.readyState>=2){
    const vw=cam.videoWidth, vh=cam.videoHeight;
    if(vw&&vh){
      const sc=Math.max(W/vw,H/vh);
      const dw=vw*sc, dh=vh*sc, dx=(W-dw)/2, dy=(H-dh)/2;
      vctx.drawImage(cam,dx,dy,dw,dh);
    }
  }
}

// ===== 이중 프리로드 로직 =====
let active = 'A';           // 현재 보여주는 쪽
let overlayOn = false;      // 표시 상태
let aLoadedAt = 0, bLoadedAt = 0;

function setStatus(s){ statusEl.textContent = s; }

function loadInto(iframe, markLoaded){
  readout.textContent = 'connecting…';
  iframe.src = freshUrl();
  iframe.onload = () => {
    markLoaded(Date.now());
    readout.textContent = 'connected';
  };
}

// 처음 로드: A는 활성용, B는 대기용
function initialPreload(){
  loadInto(ninjaA, t=>aLoadedAt=t);
  // 2초 후 B도 미리 붙임(서버 부담 완화)
  setTimeout(()=> loadInto(ninjaB, t=>bLoadedAt=t), 2000);
}
initialPreload();

function show(iframe){ iframe.classList.add('show'); }
function hide(iframe){ iframe.classList.remove('show'); }

// 활성 표시/숨김
function setOverlay(on){
  overlayOn = on;
  btnToggle.textContent = overlayOn ? 'Overlay ON' : 'Overlay OFF';
  if (overlayOn){
    if (active==='A'){ show(ninjaA); hide(ninjaB); setStatus('visible: A'); }
    else             { show(ninjaB); hide(ninjaA); setStatus('visible: B'); }
  } else {
    hide(ninjaA); hide(ninjaB);
    setStatus('hidden (connected)');
  }
}

// 활성 끊김 감지 → 즉시 스왑 + 백그라운드 재프리로드
function failover(){
  if (active==='A'){
    active='B'; show(ninjaB); hide(ninjaA); setStatus('failover → B');
    // A를 다시 프리로드
    setTimeout(()=>loadInto(ninjaA, t=>aLoadedAt=t), 500);
  }else{
    active='A'; show(ninjaA); hide(ninjaB); setStatus('failover → A');
    setTimeout(()=>loadInto(ninjaB, t=>bLoadedAt=t), 500);
  }
}

// 1) 사용자가 강제 재연결 누르면: 현재 보이는 쪽은 유지, 반대편을 갱신
btnReconnect.addEventListener('click', ()=>{
  readout.textContent='force reconnect…';
  if (active==='A') loadInto(ninjaB, t=>bLoadedAt=t);
  else              loadInto(ninjaA, t=>aLoadedAt=t);
  // 3초 후 예비가 붙었을 것으로 가정하고 스왑
  setTimeout(()=>{ if(overlayOn) failover(); }, 3000);
});

// 2) 표시 중인 쪽이 ‘오래됨’(2분↑) 감지 → 먼저 예비 갱신하고 스왑
setInterval(()=>{
  if (!overlayOn) return;
  const now = Date.now();
  const age = (active==='A') ? (now - aLoadedAt) : (now - bLoadedAt);
  if (age > 120000){ // 2분 지난 세션은 새로고침
    readout.textContent='refreshing…';
    if (active==='A') loadInto(ninjaB, t=>bLoadedAt=t);
    else              loadInto(ninjaA, t=>aLoadedAt=t);
    setTimeout(()=>{ if(overlayOn) failover(); }, 2000);
  }
}, 15000);

// 3) 페이지가 다시 보일 때(모바일 절전 복귀 등) 예비 갱신
document.addEventListener('visibilitychange', ()=>{
  if (document.visibilityState==='visible' && overlayOn){
    if (active==='A') loadInto(ninjaB, t=>bLoadedAt=t);
    else              loadInto(ninjaA, t=>aLoadedAt=t);
  }
});

// 토글 버튼
btnToggle.addEventListener('click', ()=> setOverlay(!overlayOn));

// ===== 시작: 카메라 허용 후 바로 ON =====
(async ()=>{
  try{
     await startCamera();
     drawLoop();
     setOverlay(true);
  }catch(e){
     readout.textContent='camera perm needed';
     alert('카메라 권한을 허용해 주세요.');
  }
})();
})();
</script>
</body>
</html>
