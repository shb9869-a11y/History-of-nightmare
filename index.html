<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>History of Nightmare — 50/50 Cam + Rez</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  html,body{
    margin:0;height:100%;background:#000;overflow:hidden;
    -webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;
  }

  /* 관객 카메라 */
  #view{
    position:fixed;left:0;top:0;width:100%;height:100%;
    display:block;z-index:0;
  }

  /* 레졸룸(VDO.Ninja) */
  #ninjaOverlay{
    position:fixed;left:50%;top:50%;
    width:100%;height:100%;
    transform:translate(-50%,-50%);
    border:0;z-index:10;pointer-events:none;opacity:0;
    transition:opacity .35s ease;background:transparent;
    image-rendering:auto;will-change:opacity;
  }

  /* 확대/축소 컨트롤 */
  .zoomDock{
    position:fixed;right:16px;bottom:16px;
    z-index:120;display:flex;gap:10px;align-items:center;
    background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.2);
    border-radius:9999px;padding:4px 8px;backdrop-filter:blur(5px);
  }
  .zoomBtn{
    background:transparent;border:none;color:#fff;cursor:pointer;user-select:none;
    font-family:"Courier New",monospace;font-size:16px;line-height:1;padding:2px 6px;
    opacity:.9;
  }
  .zoomBtn:active{opacity:1}
  .zoomLabel{color:#fff;opacity:.7;font:13px "Courier New",monospace;}

  /* 중앙 오버레이 */
  #overlay{
    position:fixed;inset:0;z-index:200;
    display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.65);
    font-family:"Courier New",monospace;color:#fff;text-align:center;
  }
  #overlayContent{
    position:absolute;left:50%;top:50%;
    transform:translate(-50%,-50%);
  }
  .msgBtn, .msg{
    font-size:clamp(14px, 2.5vmin, 20px);
    letter-spacing:.03em;
    padding:.5em 1em;
    background:rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.25);
    color:#fff;display:inline-block;
  }
  .msgBtn{cursor:pointer;}
  .fadeOut{animation:fadeOut .8s ease forwards;}
  @keyframes fadeOut{to{opacity:0;visibility:hidden}}
</style>
</head>
<body>
<canvas id="view"></canvas>
<iframe id="ninjaOverlay" allow="autoplay;fullscreen;camera;microphone" referrerpolicy="no-referrer"></iframe>

<div class="zoomDock">
  <button class="zoomBtn" id="btnZoomOut">−</button>
  <span class="zoomLabel">Zoom</span>
  <button class="zoomBtn" id="btnZoomIn">＋</button>
</div>

<div id="overlay">
  <div id="overlayContent">
    <button id="btnStart" class="msgBtn">PRESS HERE TO START</button>
  </div>
</div>

<script>
(()=>{

const CONFIG={ROOM_ID:"YOURROOMID",BLEND:0.5,PROC_SCALE:0.5};

const ninja=document.getElementById("ninjaOverlay");
const view=document.getElementById("view");
const vctx=view.getContext("2d",{alpha:false});
const overlay=document.getElementById("overlay");
const overlayContent=document.getElementById("overlayContent");

let CAM_ZOOM=1.0;
const btnZoomIn=document.getElementById("btnZoomIn");
const btnZoomOut=document.getElementById("btnZoomOut");

function setOverlay(on){ninja.style.opacity=on?CONFIG.BLEND:0;}
ninja.src=`https://vdo.ninja/?view=${encodeURIComponent(CONFIG.ROOM_ID)}&clean&autostart&noaudio&codec=vp8&solo&transparent=1`;

const cam=document.createElement("video");cam.autoplay=true;cam.muted=true;cam.playsInline=true;
const proc=document.createElement("canvas");const pctx=proc.getContext("2d",{willReadFrequently:true});

async function startCamera(){
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
  cam.srcObject=s;await cam.play().catch(()=>{});
}

function fitCamera(){
  const w=window.innerWidth,h=window.innerHeight;
  view.width=w;view.height=h;
  proc.width=w*CONFIG.PROC_SCALE;proc.height=h*CONFIG.PROC_SCALE;
}

let loopOn=false;
function loop(){
  requestAnimationFrame(loop);
  const W=view.width,H=view.height;
  const PW=proc.width,PH=proc.height;
  pctx.clearRect(0,0,PW,PH);
  if(cam.readyState>=2){
    const vw=cam.videoWidth,vh=cam.videoHeight;
    const sc=Math.max(PW/vw,PH/vh)*CAM_ZOOM;
    const dw=vw*sc,dh=vh*sc,dx=(PW-dw)/2,dy=(PH-dh)/2;
    pctx.drawImage(cam,dx,dy,dw,dh);
    const img=pctx.getImageData(0,0,PW,PH),d=img.data;
    for(let i=0;i<d.length;i+=4){const g=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])|0;d[i]=d[i+1]=d[i+2]=g;}
    pctx.putImageData(img,0,0);
  }
  vctx.clearRect(0,0,W,H);
  const cover=Math.max(W/PW,H/PH);
  const dw2=PW*cover,dh2=PH*cover,dx2=(W-dw2)/2,dy2=(H-dh2)/2;
  vctx.drawImage(proc,dx2,dy2,dw2,dh2);
}

window.addEventListener("resize",fitCamera);
window.addEventListener("orientationchange",()=>setTimeout(fitCamera,100));

function beep(){
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const osc=ctx.createOscillator(),g=ctx.createGain();
  osc.type='square';osc.frequency.value=880;
  osc.connect(g).connect(ctx.destination);
  g.gain.setValueAtTime(0.2,ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.1);
  osc.start();osc.stop(ctx.currentTime+0.1);
}

document.getElementById("btnStart").addEventListener("click",async()=>{
  beep();
  await startCamera();fitCamera();
  if(!loopOn){loopOn=true;loop();}
  setOverlay(true);

  overlayContent.innerHTML='<button id="btnWelcome" class="msgBtn">WELCOME TO HISTORY OF NIGHTMARE</button>';
  document.getElementById("btnWelcome").addEventListener("click",()=>{
    beep();
    overlayContent.innerHTML='<div class="msg">SHOW WILL BEGIN SOON</div>';
    setTimeout(()=>{
      overlayContent.innerHTML='<div class="msg">PLEASE CAPTURING THE MOMENT</div>';
      setTimeout(()=>{
        overlayContent.classList.add("fadeOut");
        setTimeout(()=>overlay.style.display="none",800);
      },3000);
    },3000);
  });
});

function clamp(v,min,max){return Math.max(min,Math.min(max,v));}
btnZoomIn.addEventListener("click",()=>{beep();CAM_ZOOM=clamp(CAM_ZOOM+0.1,0.8,2.0);});
btnZoomOut.addEventListener("click",()=>{beep();CAM_ZOOM=clamp(CAM_ZOOM-0.1,0.8,2.0);});

fitCamera();

})();
</script>
</body>
</html>
