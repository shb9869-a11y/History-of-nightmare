<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>카메라 캡쳐 & 업로드 테스트</title>
<style>
  :root{
    --bg:#000;
    --fg:#f5f5f5;
    --accent:#d0d0d0;
  }
  html,body{
    margin:0;
    padding:0;
    width:100%;
    height:100%;
    background:var(--bg);
    color:var(--fg);
    font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;
  }
  body{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    padding:16px;
    box-sizing:border-box;
    gap:12px;
  }
  h1{
    font-size:16px;
    margin:0 0 4px;
    text-align:center;
  }
  #videoWrap{
    position:relative;
    width:100%;
    max-width:640px;
    background:#222;
    overflow:hidden;
    border:1px solid #444;
    border-radius:8px;
  }
  video,canvas{
    display:block;
    width:100%;
    height:auto;
  }
  #controls{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:center;
  }
  button{
    padding:8px 16px;
    border:none;
    background:#333;
    color:var(--fg);
    border-radius:4px;
    font-size:14px;
  }
  button:active{
    background:#555;
  }
  #msg{
    font-size:12px;
    white-space:pre-line;
    text-align:center;
    color:#ccc;
    min-height:32px;
  }
  #preview{
    width:100%;
    max-width:640px;
    border:1px dashed #444;
    display:none;
  }
</style>
</head>
<body>
  <h1>카메라 캡쳐 & 업로드 테스트</h1>

  <div id="videoWrap">
    <video id="video" playsinline autoplay muted></video>
  </div>

  <div id="controls">
    <button id="startCamBtn" type="button">카메라 켜기</button>
    <button id="captureBtn" type="button" disabled>CAPTURE & UPLOAD</button>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>
  <img id="preview" alt="캡쳐 프리뷰"/>

  <div id="msg"></div>

<script>
(() => {
  // ★ 공연장마다 IP만 바꿔주면 되는 부분 ★
  const UPLOAD_SERVER = 'http://172.16.71.122:4000';

  const startCamBtn = document.getElementById('startCamBtn');
  const captureBtn  = document.getElementById('captureBtn');
  const video       = document.getElementById('video');
  const canvas      = document.getElementById('canvas');
  const preview     = document.getElementById('preview');
  const msg         = document.getElementById('msg');

  let stream = null;

  function log(text){
    console.log(text);
    msg.textContent = text;
  }

  async function startCamera(){
    log('카메라 요청 중...');
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      log('이 브라우저에서는 getUserMedia를 지원하지 않습니다.');
      return;
    }

    try{
      // 여기서만 카메라 권한 요청 (유저 버튼 클릭 안에서만)
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'environment' },
          width: { ideal: 1280 },
          height:{ ideal: 720 }
        },
        audio: false
      });

      video.srcObject = stream;
      captureBtn.disabled = false;
      log('카메라 스트림이 시작되었습니다.\n캡쳐 & 업로드 버튼을 눌러보세요.');

    }catch(e){
      console.error(e);
      log(
        '카메라를 열 수 없습니다.\n\n' +
        '에러: ' + (e.name || '') + ' - ' + (e.message || '') + '\n\n' +
        '※ 브라우저 주소창 오른쪽 자물쇠/ⓘ 버튼 → 사이트 설정에서\n' +
        '   카메라가 차단(block)으로 되어 있지 않은지 확인해 주세요.'
      );
    }
  }

  async function captureAndUpload(){
    if(!stream){
      log('먼저 카메라를 켜 주세요.');
      return;
    }
    if(!video.videoWidth || !video.videoHeight){
      log('비디오 메타데이터를 아직 읽는 중입니다. 잠시 후 다시 시도해 주세요.');
      return;
    }

    const w = video.videoWidth;
    const h = video.videoHeight;
    canvas.width  = w;
    canvas.height = h;

    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);

    // 프리뷰용
    canvas.toBlob(blob => {
      if(!blob) return;
      const url = URL.createObjectURL(blob);
      preview.src = url;
      preview.style.display = 'block';
    }, 'image/jpeg', 0.9);

    log('이미지 캡쳐 완료. 업로드 중...');

    try{
      const blob = await new Promise(resolve => {
        canvas.toBlob(b => resolve(b), 'image/jpeg', 0.9);
      });

      if(!blob){
        log('캡쳐 Blob 생성에 실패했습니다.');
        return;
      }

      const formData = new FormData();
      formData.append('image', blob, 'camera_capture_'+Date.now()+'.jpg');

      const res = await fetch(UPLOAD_SERVER + '/upload', {
        method:'POST',
        body: formData
      });

      if(!res.ok){
        throw new Error('HTTP ' + res.status + ' ' + res.statusText);
      }

      const data = await res.json().catch(() => ({}));
      console.log('업로드 응답:', data);
      if(data && data.success && data.url){
        log('업로드 완료!\n서버 경로: ' + data.url);
      }else{
        log('업로드는 되었지만, 서버 응답 형식이 예상과 다릅니다.\n콘솔 로그를 확인해 주세요.');
      }

    }catch(e){
      console.error(e);
      log(
        '업로드 중 오류가 발생했습니다.\n\n' +
        '에러: ' + (e.message || e.toString())
      );
    }
  }

  startCamBtn.addEventListener('click', startCamera);
  captureBtn.addEventListener('click', captureAndUpload);

  window.addEventListener('beforeunload', () => {
    if(stream){
      stream.getTracks().forEach(t => t.stop());
    }
  });
})();
</script>
</body>
</html>