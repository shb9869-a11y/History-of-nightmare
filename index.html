<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>LIMEN – Relational Micro Detection</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>

<style>
html,body{margin:0;height:100%;background:#000;overflow:hidden;}
video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
video{filter:grayscale(1) contrast(1.2);}
#ui{position:fixed;top:12px;left:12px;color:#fff;font-size:12px;z-index:10}
</style>
</head>

<body>
<video id="v" autoplay playsinline muted></video>
<canvas id="c"></canvas>
<div id="ui">LIMEN / 관계적 프레임</div>

<script>
(async()=>{
const v=document.getElementById("v");
const c=document.getElementById("c");
const x=c.getContext("2d");

const LIMEN=["Mom","Hometown","Son Duk-Geum","GrandFather","Ocean"];
const COLORS={
  "Mom":[255,120,120],
  "Hometown":[120,255,180],
  "Son Duk-Geum":[255,255,120],
  "GrandFather":[180,180,255],
  "Ocean":[120,180,255]
};

const assets={
  "Mom":"assets/mom.jpg",
  "Hometown":"assets/hometown.jpg",
  "Son Duk-Geum":"assets/son-duk-geum.jpg",
  "GrandFather":"assets/grandfather.jpg",
  "Ocean":"assets/ocean.jpg"
};

const imgs={};
for(const k in assets){
  imgs[k]=new Image();
  imgs[k].src=assets[k];
}

const stream=await navigator.mediaDevices.getUserMedia({
  video:{facingMode:"environment",width:1280,height:720},audio:false
});
v.srcObject=stream;
await v.play();

const model=await cocoSsd.load({base:"lite_mobilenet_v2"});

function resize(){
  c.width=v.videoWidth;
  c.height=v.videoHeight;
}
window.onresize=resize;

function shuffle(a){
  return a.slice().sort(()=>Math.random()-0.5);
}

function microBox(seed){
  const s=20+Math.random()*40;
  return {
    x:Math.random()*(c.width-s),
    y:Math.random()*(c.height-s),
    w:s,h:s,
    vx:(Math.random()-.5)*0.6,
    vy:(Math.random()-.5)*0.6,
    seed
  };
}

let nodes=[];

function buildRelationalFrame(){
  nodes=[];
  const labels=shuffle(LIMEN).slice(0,3); // ✅ 항상 3개 이상, 서로 다름
  labels.forEach((l,i)=>{
    const b=microBox(i);
    nodes.push({...b,label:l});
  });
}

function update(){
  x.clearRect(0,0,c.width,c.height);

  // drift
  nodes.forEach(n=>{
    n.x+=n.vx;n.y+=n.vy;
    if(n.x<0||n.x+n.w>c.width) n.vx*=-1;
    if(n.y<0||n.y+n.h>c.height) n.vy*=-1;
  });

  // links
  for(let i=0;i<nodes.length;i++){
    for(let j=i+1;j<nodes.length;j++){
      const a=nodes[i],b=nodes[j];
      x.strokeStyle="rgba(255,255,255,.35)";
      x.beginPath();
      x.moveTo(a.x+a.w/2,a.y+a.h/2);
      x.lineTo(b.x+b.w/2,b.y+b.h/2);
      x.stroke();
    }
  }

  // nodes
  nodes.forEach(n=>{
    const col=COLORS[n.label];
    x.save();
    x.beginPath();
    x.rect(n.x,n.y,n.w,n.h);
    x.clip();
    const img=imgs[n.label];
    if(img.complete){
      x.drawImage(img,n.x-10,n.y-10,n.w+20,n.h+20);
    }
    x.restore();
    x.strokeStyle=`rgba(${col[0]},${col[1]},${col[2]},.95)`;
    x.strokeRect(n.x,n.y,n.w,n.h);
  });
}

let last=0;
async function loop(t){
  if(t-last>900){ // 약 1초마다 프레임 의미 재해석
    buildRelationalFrame();
    last=t;
  }
  update();
  requestAnimationFrame(loop);
}

resize();
buildRelationalFrame();
loop(0);

})();
</script>
</body>
</html>
