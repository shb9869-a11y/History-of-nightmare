<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>History of Nightmare â€” PWA + Rez 70% + Proscenium</title>

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --vwpx: 100vw;   /* JSê°€ ì‹¤ì œ í”½ì…€ê°’ ì£¼ì… (iOS A2HS 100vh ë²„ê·¸ ëŒ€ì‘) */
    --vhpx: 100vh;

    --gap: 32px;
    --line-color: rgba(255,255,255,.9);
    --line-w: 1px; --line-r: 2px;

    --cam-zoom: 1; /* í™•ëŒ€/ì¶•ì†Œ (1 = ê¸°ë³¸) */
  }
  @media (orientation:landscape){ :root{ --gap: 24px; } }

  html,body{
    margin:0;height:100%;background:#000;overflow:hidden;
    -webkit-touch-callout:none;-webkit-tap-highlight-color:transparent
  }

  /* ê´€ê° ì¹´ë©”ë¼(í‘ë°±) */
  #view{
    position:fixed;left:0;top:0;width:var(--vwpx);height:var(--vhpx);
    display:block;z-index:0
  }

  /* ë ˆì¡¸ë£¸(VDO.Ninja) â€” í•´ìƒë„ 70%ë¡œ ì¤„ì´ê³  í™”ë©´ì€ ê½‰ ì±„ì›€(ì‹œê°ì  í¬ê¸°ëŠ” ë™ì¼) */
  #ninjaOverlay{
    position:fixed;left:50%;top:50%;
    width:var(--vwpx);height:var(--vhpx); /* ì´ˆê¸°ê°’; JSì—ì„œ 70%ë¡œ ì¬ì„¤ì • */
    transform:translate(-50%,-50%) scale(1);transform-origin:50% 50%;
    border:0;z-index:10;pointer-events:none;opacity:0;
    transition:opacity .35s ease;background:transparent;
    image-rendering:auto;will-change:transform
  }

  /* í”„ë¡œì‹œë‹ˆì—„(ì–‡ì€ ì„ ) â€” safe-area ë°˜ì˜ */
  .proscenium{
    position:fixed;
    left:calc(var(--gap) + env(safe-area-inset-left));
    right:calc(var(--gap) + env(safe-area-inset-right));
    top:calc(var(--gap) + env(safe-area-inset-top));
    bottom:calc(var(--gap) + env(safe-area-inset-bottom));
    border:var(--line-w) solid var(--line-color);
    border-radius:var(--line-r);
    box-sizing:border-box;z-index:90;pointer-events:none;transform:translateZ(0)
  }

  /* ì»¨íŠ¸ë¡¤: IN/OUT + í™•ëŒ€/ì¶•ì†Œ (ë¯¸ë‹ˆë©€: ë°°ê²½/í…Œë‘ë¦¬ ì œê±°) */
  .controls{
    position:fixed;right:calc(16px + env(safe-area-inset-right));
    bottom:calc(16px + env(safe-area-inset-bottom));
    z-index:100;display:flex;gap:10px;align-items:center
  }
  .ctrlBtn{
    background:transparent;border:none;color:#fff;cursor:pointer;user-select:none;
    font-family:"Courier New",monospace;font-size:14px;padding:4px 6px;
    opacity:.9
  }
  .ctrlBtn:active{opacity:1}
  .ctrlGroup{display:flex;gap:8px;align-items:center}

  /* ì‹œì‘ ì˜¤ë²„ë ˆì´ (ë²„íŠ¼/ë¬¸êµ¬ ì‹œí€€ìŠ¤ë§Œ) */
  #overlay{
    position:fixed;left:0;top:0;width:var(--vwpx);height:var(--vhpx);
    z-index:200;display:flex;align-items:center;justify-content:center;
    padding:20px;font-family:"Courier New",monospace;color:#fff;background:rgba(0,0,0,.7)
  }
  #overlayContent{line-height:1.7;text-align:center;transition:opacity .45s ease}
  .uiBtn{
    background:#000;color:#fff;border:1px solid #333;
    font-family:"Courier New",monospace;padding:.7em 1.4em;cursor:pointer;user-select:none
  }
  .bigMsg{
    font-size:clamp(18px, 4.5vmin, 36px); letter-spacing:.02em;
    background:rgba(0,0,0,.55); padding:.6em 1em; display:inline-block
  }
  .fadeOut{animation:fadeOut .8s ease forwards}
  @keyframes fadeOut{ to{opacity:0; visibility:hidden} }

  /* HTTPS ì•ˆë‚´(ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹¤íŒ¨ ì‹œ) */
  #httpsBlock{
    position:fixed;inset:0;z-index:300;display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.88);color:#fff;font-family:"Courier New",monospace;padding:20px;text-align:center
  }
  #httpsInner{max-width:560px}
  .kbd{display:inline-block;border:1px solid #888;padding:2px 6px;border-radius:4px;background:#111}

  /* ì§„ë‹¨ HUD (3íƒ­ í† ê¸€) */
  #diag{
    position:fixed;left:8px;bottom:8px;z-index:9999;
    background:rgba(0,0,0,.7);color:#0f0;font:12px/1.4 monospace;
    padding:8px;border:1px solid #0f0;border-radius:6px;display:none;white-space:pre
  }
</style>
</head>
<body>
  <!-- ê´€ê° ì¹´ë©”ë¼(í‘ë°±) -->
  <canvas id="view"></canvas>

  <!-- ë ˆì¡¸ë£¸(VDO.Ninja) -->
  <iframe id="ninjaOverlay"
          allow="autoplay; fullscreen; camera; microphone; clipboard-read; clipboard-write"
          allowtransparency="true" style="background:transparent" referrerpolicy="no-referrer"
          src="about:blank"></iframe>

  <!-- í”„ë¡œì‹œë‹ˆì—„ -->
  <div class="proscenium" aria-hidden="true"></div>

  <!-- ì»¨íŠ¸ë¡¤: IN/OUT + í™•ëŒ€/ì¶•ì†Œ -->
  <div class="controls">
    <div class="ctrlGroup">
      <button class="ctrlBtn" id="btnIn">IN</button>
      <button class="ctrlBtn" id="btnOut">OUT</button>
    </div>
    <div class="ctrlGroup" aria-label="zoom">
      <button class="ctrlBtn" id="btnZoomOut">âˆ’</button>
      <span style="opacity:.8">Zoom</span>
      <button class="ctrlBtn" id="btnZoomIn">ï¼‹</button>
    </div>
  </div>

  <!-- ì‹œì‘ ì˜¤ë²„ë ˆì´(ë¬¸êµ¬ ì‹œí€€ìŠ¤) -->
  <div id="overlay">
    <div id="overlayContent">
      <!-- 1ë‹¨ê³„: â€œPRESS HERE TO STARTâ€ -->
      <button id="welcomeBtn" class="uiBtn">PRESS HERE TO START</button>
    </div>
  </div>

  <!-- HTTPS ì•ˆë‚´(í•„ìš” ì‹œ) -->
  <div id="httpsBlock">
    <div id="httpsInner">
      <div style="font-size:18px;margin-bottom:10px"><b>ë³´ì•ˆ ì—°ê²°(HTTPS) í•„ìš”</b></div>
      <div style="opacity:.9">í™ˆ í™”ë©´ ì•±ì—ì„  HTTPì—ì„œ ì¹´ë©”ë¼/ë§ˆì´í¬ê°€ ì°¨ë‹¨ë¼ìš”.</div>
      <div style="margin:12px 0 8px">ì•„ë˜ ì£¼ì†Œë¡œ ìë™ ì´ë™í•˜ë„ë¡ ì„¤ì •í•˜ì„¸ìš”:</div>
      <div id="httpsUrlBox" class="kbd" style="user-select:all;display:inline-block;"></div>
      <div style="margin-top:12px">
        <button id="copyHttps" class="uiBtn">ì£¼ì†Œ ë³µì‚¬</button>
        <button id="openHttps" class="uiBtn">ì—´ê¸°</button>
      </div>
      <div style="opacity:.7;margin-top:10px;font-size:12px">
        (ì˜ˆ: <span class="kbd">cloudflared tunnel --url http://localhost:8001</span> ë˜ëŠ” <span class="kbd">ngrok http 8001</span> ë¡œ ë°›ì€ ì£¼ì†Œ)
      </div>
    </div>
  </div>

  <!-- ì§„ë‹¨ HUD -->
  <div id="diag"></div>

<script>
(()=> {
/* =======================
   0) êµ¬ì„± (ìˆ˜ì • í¬ì¸íŠ¸)
   ======================= */
const CONFIG = {
  ROOM_ID:      "YOURROOMID",         // â† VDO.Ninja ë£¸ ì•„ì´ë””
  HTTPS_ORIGIN: "",                   // â† ì˜ˆ: "https://abc123.ngrok-free.app"
  BLEND:        0.5,                  // ë ˆì¡¸ë£¸ ì˜¤ë²„ë ˆì´ ë¶ˆíˆ¬ëª…ë„(0~1)
  REZ_SCALE:    0.70                  // ğŸ”¥ ë ˆì¡¸ë£¸ ì‹¤ì œ ë Œë” í•´ìƒë„ ë¹„ìœ¨ (70% ìœ ì§€)
};

/* =======================
   1) HTTPS ê°•ì œ/ì•ˆë‚´
   ======================= */
const httpsBlock = document.getElementById('httpsBlock');
const httpsBox   = document.getElementById('httpsUrlBox');
const btnCopy    = document.getElementById('copyHttps');
const btnOpen    = document.getElementById('openHttps');

function shouldForceHttps(){
  const local = /^(localhost|127\.0\.0\.1)$/i.test(location.hostname);
  return !window.isSecureContext && !local;
}
function tryHttpsRedirect(){
  if (shouldForceHttps()) {
    if (CONFIG.HTTPS_ORIGIN){
      const target = new URL(location.href);
      const origin = CONFIG.HTTPS_ORIGIN.replace(/\/+$/,'');
      const redirectUrl = origin + target.pathname + target.search + target.hash;
      location.replace(redirectUrl);
      return true;
    } else {
      httpsBox.textContent = "(HTTPS ì£¼ì†Œë¥¼ ì„¤ì •í•˜ì„¸ìš”: CONFIG.HTTPS_ORIGIN)";
      httpsBlock.style.display = 'flex';
      return false;
    }
  }
  return false;
}
btnCopy?.addEventListener('click', async ()=>{
  if (!CONFIG.HTTPS_ORIGIN){ alert('CONFIG.HTTPS_ORIGINì´ ë¹„ì–´ìˆì–´ìš”.'); return; }
  try{ await navigator.clipboard.writeText(CONFIG.HTTPS_ORIGIN); alert('ë³µì‚¬ë¨'); }catch{ alert(CONFIG.HTTPS_ORIGIN); }
});
btnOpen?.addEventListener('click', ()=>{
  if (!CONFIG.HTTPS_ORIGIN){ alert('CONFIG.HTTPS_ORIGINì´ ë¹„ì–´ìˆì–´ìš”.'); return; }
  location.href = CONFIG.HTTPS_ORIGIN;
});
if (!tryHttpsRedirect() && shouldForceHttps()){ httpsBlock.style.display = 'flex'; }

/* =======================
   2) VDO.Ninja URL (íˆ¬ëª…/ì—¬ë°± ì œê±° + ì˜ìƒë§Œ ê½‰ ì°¨ê²Œ)
   ======================= */
const injectedCss = encodeURIComponent(`
  html,body{background:transparent!important;margin:0!important;overflow:hidden!important;}
  #container,.container{background:transparent!important;}
  video,canvas{
    position:fixed!important; inset:0!important;
    width:100vw!important; height:100vh!important;
    object-fit:fill!important; background:transparent!important;
  }
`);
const ninjaBase =
  `https://vdo.ninja/?view=${encodeURIComponent(CONFIG.ROOM_ID)}&clean&autostart&noaudio&codec=vp8&solo` +
  `&transparent=1&css=${injectedCss}`;
const ninjaUrl = ()=> `${ninjaBase}&ts=${Date.now()}`;

/* =======================
   3) ìš”ì†Œ ì°¸ì¡°
   ======================= */
const view = document.getElementById('view');
const vctx = view.getContext('2d',{alpha:false});
const ninja= document.getElementById('ninjaOverlay');
const btnIn= document.getElementById('btnIn');
const btnOut= document.getElementById('btnOut');
const btnZoomIn = document.getElementById('btnZoomIn');
const btnZoomOut= document.getElementById('btnZoomOut');
const overlayPanel  = document.getElementById('overlay');
const overlayContent= document.getElementById('overlayContent');
const diag          = document.getElementById('diag');

/* =======================
   4) ë·°í¬íŠ¸ ë³´ì • (iOS A2HS 100vh ë²„ê·¸ ì™„ì „ í•´ê²°)
   ======================= */
function setViewportVars(){
  const vv = window.visualViewport;
  const w  = Math.round((vv?.width  || window.innerWidth));
  const h  = Math.round((vv?.height || window.innerHeight));
  document.documentElement.style.setProperty('--vwpx', w + 'px');
  document.documentElement.style.setProperty('--vhpx', h + 'px');
}
setViewportVars();
window.addEventListener('resize', setViewportVars);
window.addEventListener('orientationchange', ()=>setTimeout(setViewportVars, 50));
if (window.visualViewport){
  visualViewport.addEventListener('resize', setViewportVars);
  visualViewport.addEventListener('scroll', setViewportVars);
}

/* =======================
   5) ì¹´ë©”ë¼(í‘ë°±) + í™•ëŒ€/ì¶•ì†Œ
   ======================= */
const cam  = document.createElement('video'); cam.autoplay=true; cam.muted=true; cam.playsInline=true;
const proc = document.createElement('canvas'); const pctx = proc.getContext('2d',{willReadFrequently:true});
const PROC_SCALE=0.60;
let CAM_ZOOM = 1.0; // JS ë ˆë²¨ í™•ëŒ€/ì¶•ì†Œ (ì „ì²´ í•©ì„± ì¤‘ ì¹´ë©”ë¼ ë ˆì´ì–´ ëŒ€ìƒìœ¼ë¡œ)

function fitCamera(){
  const dpr = devicePixelRatio||1;
  view.width = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--vwpx'))*dpr;
  view.height= parseInt(getComputedStyle(document.documentElement).getPropertyValue('--vhpx'))*dpr;
  vctx.setTransform(dpr,0,0,dpr,0,0);
  const cssW = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--vwpx'));
  const cssH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--vhpx'));
  const scale = matchMedia('(orientation:landscape)').matches? PROC_SCALE*0.9 : PROC_SCALE;
  proc.width  = Math.floor(cssW*scale);
  proc.height = Math.floor(cssH*scale);
}
async function startCamera(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    cam.srcObject=s; await cam.play().catch(()=>{});
  }catch(e){ console.warn('Camera start failed (possibly non-HTTPS):', e); }
}
let _loop=false;
function ensureLoop(){ if(_loop) return; _loop=true; loop(); }
function loop(){
  requestAnimationFrame(loop);
  const cssW = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--vwpx'));
  const cssH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--vhpx'));
  const W=cssW, H=cssH;
  const PW=proc.width, PH=proc.height;
  pctx.clearRect(0,0,PW,PH);
  if (cam.readyState>=2){
    const vw=cam.videoWidth, vh=cam.videoHeight;
    if(vw&&vh){
      // ì¹´ë©”ë¼ ë ˆì´ì–´ í™•ëŒ€/ì¶•ì†Œ ì ìš© (ì¤‘ì•™ í¬ë¡­)
      const baseSc=Math.max(PW/vw, PH/vh) * CAM_ZOOM;
      const dw=vw*baseSc, dh=vh*baseSc, dx=(PW-dw)/2, dy=(PH-dh)/2;
      pctx.drawImage(cam,dx,dy,dw,dh);
      const img=pctx.getImageData(0,0,PW,PH), d=img.data;
      for(let i=0;i<d.length;i+=4){ const g=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])|0; d[i]=d[i+1]=d[i+2]=g; }
      pctx.putImageData(img,0,0);
    }
  }
  vctx.clearRect(0,0,W,H);
  vctx.drawImage(proc,0,0,W,H);
}

/* =======================
   6) ì˜¤ë””ì˜¤/ì„¼ì„œ + ë²„íŠ¼ ë¶€ì €ìŒ + ë§ˆì´í¬ ê°ë„ â†‘
   ======================= */
let audioCtx=null, mixBus=null, motionGain=null, masterGain=null, panSetter=null, micStream=null;
const VOL_BASE=0.20, VOL_MAX_ADD=0.55, SMOOTH_TC=0.08, CTRL_SMOOTH_ALPHA=0.12, DEADZONE_VOL_DEG=5, DEADZONE_PAN_DEG=3, VOL_TILT_LIMIT=60, PAN_LIMIT_DEG=45;

function initAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  mixBus = audioCtx.createGain();

  let panOut = null;
  if(audioCtx.createStereoPanner){
    const sp = audioCtx.createStereoPanner();
    panSetter = v=>{ try{ sp.pan.setTargetAtTime(v,audioCtx.currentTime,0.08);}catch{ sp.pan.value=v; } };
    mixBus.connect(sp); panOut = sp;
  }else{
    const l=audioCtx.createGain(), r=audioCtx.createGain(), m=audioCtx.createChannelMerger(2);
    mixBus.connect(l); mixBus.connect(r); l.connect(m,0,0); r.connect(m,0,1); panOut=m;
    panSetter = p=>{ const x=Math.max(-1,Math.min(1,p||0)), th=(x+1)*0.25*Math.PI; l.gain.value=Math.cos(th); r.gain.value=Math.sin(th); };
  }
  motionGain = audioCtx.createGain(); motionGain.gain.value=VOL_BASE;
  masterGain = audioCtx.createGain(); masterGain.gain.value=1.0;
  panOut.connect(motionGain); motionGain.connect(masterGain); masterGain.connect(audioCtx.destination);
}

/* ë²„íŠ¼ ë¶€ì €ìŒ: ì§§ì€ ë¹„í”„ */
function beep(){
  try{
    if(!audioCtx) return;
    const now = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const g   = audioCtx.createGain();
    osc.type='square'; osc.frequency.value=880; // ë¶€ì € ëŠë‚Œ
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(0.25, now+0.005);
    g.gain.exponentialRampToValueAtTime(0.0008, now+0.09);
    osc.connect(g).connect(masterGain || audioCtx.destination);
    osc.start(now); osc.stop(now+0.1);
  }catch{}
}

async function startMic(){
  try{
    if(micStream) return;
    const s=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:true,autoGainControl:false},video:false});
    micStream=s; const src=audioCtx.createMediaStreamSource(s);

    /* ë§ˆì´í¬ ê°ë„ ìµœëŒ€ë¡œ: í”„ë¦¬ê²Œì¸ + ì•½í•œ HPF + ì»´í”„ + ë¦¬ë²„ë¸Œ */
    const preGain = audioCtx.createGain(); preGain.gain.value = 3.0;  // +9.5 dB ì •ë„
    const hpf=audioCtx.createBiquadFilter(); hpf.type='highpass'; hpf.frequency.value=120; // ì €ì—­ ì‚´ì§ë§Œ ì»·
    const notch=audioCtx.createBiquadFilter(); notch.type='notch'; notch.frequency.value=300; notch.Q.value=3.5;
    const comp=audioCtx.createDynamicsCompressor();
    comp.threshold.value=-26; comp.knee.value=6; comp.ratio.value=3.0;
    comp.attack.value=0.005; comp.release.value=0.12;

    const wet=audioCtx.createGain(); wet.gain.value=0.90; // ë¦¬ë²„ë¸Œ ë” í¬ê²Œ
    const dry=audioCtx.createGain(); dry.gain.value=0.20; // ë“œë¼ì´ë„ ì•½ê°„
    const convolver=audioCtx.createConvolver(); convolver.buffer=makeIR(2.6,2.4);

    src.connect(preGain).connect(hpf).connect(notch).connect(comp);
    const split=audioCtx.createGain(); comp.connect(split);
    split.connect(dry); split.connect(convolver).connect(wet);

    const bus=audioCtx.createGain();
    dry.connect(bus); wet.connect(bus);
    bus.connect(mixBus);
  }catch(e){ console.warn('Mic start failed (possibly non-HTTPS):', e); }
}
function makeIR(sec=2.6,decay=2.4){
  const rate=audioCtx.sampleRate,len=Math.floor(rate*sec),ir=audioCtx.createBuffer(2,len,rate);
  for(let c=0;c<2;c++){ const v=ir.getChannelData(c); for(let i=0;i<len;i++){ const t=i/len, env=Math.pow(1-t,decay); v[i]=(Math.random()*2-1)*env*0.55; } }
  return ir;
}
let sensorsReady=false, latestOri={beta:0,gamma:0}, smVol=VOL_BASE, smPan=0;
async function sensorPerm(){
  try{ if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){ const r=await DeviceOrientationEvent.requestPermission(); if(r==='granted') sensorsReady=true; } else sensorsReady=true; }catch{}
  try{ if(typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function'){ const r=await DeviceMotionEvent.requestPermission(); if(r==='granted') sensorsReady=true; } }catch{}
}
function initOrientation(){ addEventListener('deviceorientation',e=>{ latestOri.beta=e.beta??0; latestOri.gamma=e.gamma??0; },{passive:true}); }
function smooth(t,c,a=CTRL_SMOOTH_ALPHA){ return c+(t-c)*a; }
function ctlLoop(){
  requestAnimationFrame(ctlLoop);
  let pan=0, vol=VOL_BASE;
  if(sensorsReady){
    const ang=(screen.orientation?.angle)||0, beta=latestOri.beta||0, gamma=latestOri.gamma||0;
    const panTilt=(ang%180===0)? gamma : beta;
    const volTilt=(ang%180===0)? beta  : -gamma;
    pan = Math.max(-1,Math.min(1,(Math.abs(panTilt)<DEADZONE_PAN_DEG?0:panTilt/PAN_LIMIT_DEG)));
    const a = Math.max(0,(Math.abs(volTilt)-DEADZONE_VOL_DEG)/(VOL_TILT_LIMIT-DEADZONE_VOL_DEG));
    vol = VOL_BASE + VOL_MAX_ADD*a;
  }
  smPan=smooth(pan,smPan); smVol=smooth(vol,smVol);
  if(panSetter) panSetter(smPan);
  if(motionGain){ const now=audioCtx.currentTime; try{ motionGain.gain.setTargetAtTime(smVol,now,SMOOTH_TC);}catch{ motionGain.gain.value=smVol; } }
}

/* =======================
   7) Rezolume í•´ìƒë„ ìŠ¤ì¼€ì¼ ì ìš© (70% ê³ ì •)
   ======================= */
function applyRezScale(){
  const s = Math.max(0.2, Math.min(1, Number(CONFIG.REZ_SCALE)||1));
  ninja.style.width  = `calc(var(--vwpx) * ${s})`;
  ninja.style.height = `calc(var(--vhpx) * ${s})`;
  ninja.style.left   = '50%';
  ninja.style.top    = '50%';
  ninja.style.transform = `translate(-50%,-50%) scale(${1/s})`;
}

/* =======================
   8) Ninja ì˜¤ë²„ë ˆì´ (í”„ë¦¬ë¡œë“œ + IN/OUT + ëŠê¹€ ë³µêµ¬)
   ======================= */
(function preloadOverlay(){ ninja.src = ninjaUrl(); })();
function setOverlay(on){
  ninja.style.opacity = on ? String(CONFIG.BLEND) : '0';
  if (on && !ninja.contentWindow) ninja.src = ninjaUrl();
}
btnIn.addEventListener('click', ()=>{ beep(); setOverlay(true); });
btnOut.addEventListener('click',()=>{ beep(); setOverlay(false); });
setInterval(()=>{ if(ninja.style.opacity!=='0'){ ninja.src = ninjaUrl(); } }, 60000);

/* =======================
   9) ì‹œì‘ ì‹œí€€ìŠ¤
   -----------------------
   1) PRESS HERE TO START (ë²„íŠ¼)
      -> (í´ë¦­) ì´ˆê¸°í™” + 'WELCOME TO HISTORY OF NIGHTMARE'(ë²„íŠ¼) í‘œì‹œ
   2) WELCOME TO HISTORY OF NIGHTMARE (ë²„íŠ¼)
      -> (í´ë¦­) 'SHOW WILL BIGIN SOON' â†’ 3ì´ˆ ë’¤
               'PLEASE CAPTURING THE MOMENT' â†’ 3ì´ˆ ë’¤ í˜ì´ë“œì•„ì›ƒ
               + Ninja ì˜¤ë²„ë ˆì´ ON
   ======================= */
const welcomeBtn = document.getElementById('welcomeBtn');

welcomeBtn.addEventListener('click', async ()=>{
  beep();
  try{
    initAudio(); if(audioCtx.state==='suspended'){ await audioCtx.resume().catch(()=>{}); }
    await sensorPerm().catch(()=>{});
    await startMic().catch(()=>{});
    initOrientation(); ctlLoop();

    await startCamera(); fitCamera(); ensureLoop();
    applyRezScale();

    // ë‹¨ê³„2 í™”ë©´ êµ¬ì„±: 'WELCOME TO HISTORY OF NIGHTMARE' (ë²„íŠ¼)
    overlayContent.innerHTML =
      `<button id="btnWelcomeTitle" class="uiBtn">WELCOME TO HISTORY OF NIGHTMARE</button>`;
    document.getElementById('btnWelcomeTitle').addEventListener('click', ()=>{
      beep();
      // 'SHOW WILL BIGIN SOON'
      overlayContent.innerHTML = `<div class="bigMsg">SHOW WILL BIGIN SOON</div>`;
      // 3ì´ˆ í›„ 'PLEASE CAPTURING THE MOMENT'
      setTimeout(()=>{
        overlayContent.innerHTML = `<div class="bigMsg">PLEASE CAPTURING THE MOMENT</div>`;
        // 3ì´ˆ í›„ í˜ì´ë“œì•„ì›ƒ + ì˜¤ë²„ë ˆì´ ì œê±° + ë ˆì¡¸ë£¸ ON
        setTimeout(()=>{
          overlayContent.classList.add('fadeOut');
          setTimeout(()=>{ overlayPanel.style.display='none'; }, 820);
          setOverlay(true);
        }, 3000);
      }, 3000);
    });
  }catch(e){
    overlayContent.innerHTML = '<div class="bigMsg">ê¶Œí•œ í—ˆìš©ì´ í•„ìš”í•©ë‹ˆë‹¤</div>';
  }
});

/* =======================
   10) í™•ëŒ€/ì¶•ì†Œ ë²„íŠ¼
   ======================= */
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
btnZoomIn.addEventListener('click', ()=>{ beep(); CAM_ZOOM = clamp(CAM_ZOOM+0.1, 0.8, 2.0); });
btnZoomOut.addEventListener('click',()=>{ beep(); CAM_ZOOM = clamp(CAM_ZOOM-0.1, 0.8, 2.0); });

/* =======================
   11) ì§„ë‹¨ HUD (3íƒ­)
   ======================= */
(function(){
  let show=false,taps=0,last=0;
  addEventListener('touchend', ()=>{
    const now=Date.now(); if(now-last<400) taps++; else taps=1; last=now;
    if(taps>=3){ show=!show; diag.style.display=show?'block':'none'; if(show) probe(); }
  });
  async function probe(){
    const secure = window.isSecureContext;
    const a2hs = matchMedia('(display-mode: standalone)').matches;
    let cam='unknown', mic='unknown';
    try{ const ps=await navigator.permissions.query({name:'camera'}).catch(()=>null); cam=ps?ps.state:'n/a'; }catch{}
    try{ const ps=await navigator.permissions.query({name:'microphone'}).catch(()=>null); mic=ps?ps.state:'n/a'; }catch{}
    diag.textContent =
`secureContext: ${secure}
display-mode: ${a2hs?'standalone':'browser'}
viewport: ${innerWidth}x${innerHeight}
rez-scale: ${CONFIG.REZ_SCALE}
camera perm: ${cam}
microphone perm: ${mic}
time: ${new Date().toLocaleTimeString()}`;
    if(diag.style.display==='block') setTimeout(probe, 800);
  }
})();

/* =======================
   12) keep-alive & ì´ˆê¸° ìŠ¤ì¼€ì¼/í•
   ======================= */
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible'){
    if(audioCtx && audioCtx.state==='suspended'){ audioCtx.resume().catch(()=>{}); }
  }
});
applyRezScale();
fitCamera();

})();
</script>
</body>
</html>
