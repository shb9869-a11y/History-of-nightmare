<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>History of Nightmare — ACT 1 (final, stripped)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{
    --frame: 40px; --ui-gap: 8px;
    --fs-body: clamp(12px, 2.0vmin, 15px);
    --fs-strong: clamp(14px, 2.6vmin, 18px);
    --fs-small: clamp(11px, 1.7vmin, 13px);
    --pad-line: clamp(4px, 0.9vmin, 8px);
    --pad-btn-y: clamp(6px, 1.1vmin, 10px);
    --pad-btn-x: clamp(10px, 1.8vmin, 20px);
  }
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #view{position:fixed;inset:0;width:100%;height:100%;display:block;z-index:0}
  .frameBox{position:fixed;left:var(--frame);top:var(--frame);right:var(--frame);bottom:var(--frame);border:1px solid #000;pointer-events:none;z-index:50}

  /* VDO.Ninja 오버레이 iframe (겹치기 방식) */
  #ninjaOverlay{
    position:fixed; inset:0; width:100%; height:100%;
    border:0; z-index:10;
    opacity:0; transition:opacity .45s ease;
    pointer-events:none; /* UI는 통과 */
    display:block;
  }

  .uiBtn{background:#000;color:#fff;border:1px solid #333;font-size:var(--fs-strong);
    padding:var(--pad-btn-y) var(--pad-btn-x);font-family:"Courier New",monospace;white-space:nowrap;cursor:pointer;user-select:none}
  .uiBtn.small{font-size:var(--fs-small);padding:calc(var(--pad-btn-y)*0.6) calc(var(--pad-btn-x)*0.6)}

  .controls{position:fixed;right:calc(var(--frame) + var(--ui-gap));bottom:calc(var(--frame) + var(--ui-gap));
    z-index:100;display:flex;gap:6px;align-items:center}
  .readout{min-width:48px;text-align:center;opacity:.9;font-family:"Courier New",monospace;font-size:var(--fs-small)}

  #overlay{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;
    padding:20px;font-family:"Courier New",monospace;color:#fff;background:rgba(0,0,0,.6)}
  #overlayContent{line-height:1.7;font-size:var(--fs-body);
    max-width:min(74ch, calc(100vw - (var(--frame)*2)));
    text-align:center;transition:opacity .45s ease}
  .hidden{opacity:0}
  @media (orientation:landscape){ :root{ --frame: 32px; } }
  .tip{opacity:.7;font-size:var(--fs-small);margin-top:8px}
</style>
</head>
<body>
  <!-- 카메라를 그릴 캔버스 -->
  <canvas id="view"></canvas>

  <!-- VDO.Ninja 오버레이(겹치기) -->
  <iframe id="ninjaOverlay" allow="autoplay; camera; microphone; fullscreen"></iframe>

  <div class="frameBox" aria-hidden="true"></div>

  <div class="controls">
    <button class="uiBtn small" id="toggleOverlay">Overlay OFF</button>
    <button class="uiBtn small" id="zoomOut">–</button>
    <div class="readout"><span id="zoomVal">1.0×</span></div>
    <button class="uiBtn small" id="zoomIn">+</button>
  </div>

  <div id="overlay">
    <div id="overlayContent">
      <button id="welcomeBtn" class="uiBtn">Welcome to History of Nightmare</button>
      <div class="tip">버튼을 누르면 카메라 권한을 요청합니다.</div>
    </div>
  </div>

<script>
(() => {
  /* ========== 설정 ========== */
  const ROOM_ID = "ROOM_ID_HERE"; // ← 여기를 네 룸 아이디(예: DIALOGUE2025)로 변경
  const NINJA_URL = `https://vdo.ninja/?view=${encodeURIComponent(ROOM_ID)}&clean&autostart&noaudio`;

  /* ========== 요소 참조 ========== */
  const view = document.getElementById('view');
  const vctx = view.getContext('2d', { alpha:false });
  const ninja = document.getElementById('ninjaOverlay');
  const zoomVal = document.getElementById('zoomVal');
  const btnZoomIn = document.getElementById('zoomIn');
  const btnZoomOut = document.getElementById('zoomOut');
  const btnToggleOverlay = document.getElementById('toggleOverlay');
  const welcomeBtn = document.getElementById('welcomeBtn');
  const overlayPanel = document.getElementById('overlay');
  const overlayContent = document.getElementById('overlayContent');

  /* ========== 카메라 세팅 ========== */
  const cam = document.createElement('video');
  cam.autoplay = true; cam.muted = true; cam.playsInline = true;

  let ZOOM = 1.0, ZOOM_MIN = 0.5, ZOOM_MAX = 3.0, ZOOM_STEP = 0.1;
  const clamp = (v,min,max) => Math.max(min, Math.min(max, v));
  function updateZoom(){ zoomVal.textContent = ZOOM.toFixed(1) + '×'; }

  btnZoomIn.addEventListener('click', () => { ZOOM = clamp(ZOOM + ZOOM_STEP, ZOOM_MIN, ZOOM_MAX); updateZoom(); });
  btnZoomOut.addEventListener('click', () => { ZOOM = clamp(ZOOM - ZOOM_STEP, ZOOM_MIN, ZOOM_MAX); updateZoom(); });
  updateZoom();

  function fit(){
    const dpr = window.devicePixelRatio || 1;
    view.width = innerWidth * dpr;
    view.height = innerHeight * dpr;
    vctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener('resize', () => { fit(); });

  async function startCamera(){
    // iOS는 HTTPS 필요(로컬 테스트면 http에서 제한될 수 있음)
    // GitHub Pages 같은 HTTPS 호스팅 권장
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment' }, audio: false
    });
    cam.srcObject = stream;
    await cam.play().catch(()=>{});
  }

  function drawLoop(){
    requestAnimationFrame(drawLoop);
    fit();
    const W = view.width / (window.devicePixelRatio||1);
    const H = view.height / (window.devicePixelRatio||1);

    vctx.clearRect(0,0,W,H);
    if (cam.readyState >= 2) {
      const vw = cam.videoWidth, vh = cam.videoHeight;
      if (vw && vh){
        const scale = Math.max(W/vw, H/vh) * ZOOM;
        const dw = vw*scale, dh = vh*scale;
        const dx = (W - dw)/2, dy = (H - dh)/2;
        vctx.drawImage(cam, dx, dy, dw, dh);
      }
    }
  }

  /* ========== 오버레이(겹치기) ========== */
  let overlayOn = false;
  function setOverlay(on){
    overlayOn = on;
    if (on){
      ninja.src = NINJA_URL;
      ninja.style.opacity = '1';
    } else {
      ninja.style.opacity = '0';
      // 성능을 위해 잠시 뒤 src 비우기
      setTimeout(() => { if(!overlayOn) ninja.src = 'about:blank'; }, 500);
    }
    btnToggleOverlay.textContent = overlayOn ? 'Overlay ON' : 'Overlay OFF';
  }
  btnToggleOverlay.addEventListener('click', () => setOverlay(!overlayOn));

  /* ========== 시작 버튼 ========== */
  welcomeBtn.addEventListener('click', async () => {
    overlayContent.classList.add('hidden');
    try {
      await startCamera();
      setTimeout(() => { overlayPanel.style.display = 'none'; }, 450);
      setOverlay(true); // 시작 시 바로 켜기 (원하면 false로)
      drawLoop();
    } catch(e){
      overlayContent.classList.remove('hidden');
      overlayContent.innerHTML = '<div style="background:#000;padding:8px 10px;display:inline-block">카메라 권한이 필요합니다. 브라우저 설정에서 허용해 주세요.</div>';
    }
  });

  // 첫 로드 사이즈 맞춤
  fit();
})();
</script>
</body>
</html>
