<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>History of Nightmare â€” 50/50 Cam + Rez (Cover + Proscenium)</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{ --vwpx: 100vw; --vhpx: 100vh; }

  html,body{
    margin:0;height:100%;background:#000;overflow:hidden;
    -webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;
    font-family:"Courier New",monospace; /* âœ… í°íŠ¸ í†µì¼ */
  }

  /* ê´€ê° ì¹´ë©”ë¼ ìº”ë²„ìŠ¤ */
  #view{
    position:fixed;left:0;top:0;width:var(--vwpx);height:var(--vhpx);
    display:block;z-index:0;
  }

  /* ë ˆì¡¸ë£¸(VDO.Ninja) â€” í’€í™”ë©´, ì»¤ë²„, íˆ¬ëª… ë°°ê²½ */
  #ninjaOverlay{
    position:fixed;left:50%;top:50%;
    width:var(--vwpx);height:var(--vhpx);
    transform:translate(-50%,-50%);
    border:0;z-index:10;pointer-events:none;opacity:0;
    transition:opacity .35s ease;background:transparent;
    image-rendering:auto;will-change:opacity;
  }

  /* âœ… í”„ë¡œì‹œë‹ˆì—„: í°ìƒ‰ ì–‡ì€ ì‚¬ê°í˜• í…Œë‘ë¦¬ (safe-area ë°˜ì˜) */
  .proscenium{
    position:fixed;
    left:calc(16px + env(safe-area-inset-left));
    right:calc(16px + env(safe-area-inset-right));
    top:calc(16px + env(safe-area-inset-top));
    bottom:calc(16px + env(safe-area-inset-bottom));
    border:1px solid rgba(255,255,255,0.9);
    border-radius:2px;
    box-sizing:border-box;z-index:90;pointer-events:none;
  }

  /* í™•ëŒ€/ì¶•ì†Œ ì»¨íŠ¸ë¡¤ â€” í°íŠ¸/ìŠ¤íƒ€ì¼ í†µì¼ */
  .zoomDock{
    position:fixed;right:calc(14px + env(safe-area-inset-right));
    bottom:calc(14px + env(safe-area-inset-bottom));
    z-index:120;display:flex;gap:10px;align-items:center;
    background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.2);
    border-radius:9999px;padding:4px 8px;backdrop-filter:blur(5px);
  }
  .zoomBtn{
    background:transparent;border:1px solid rgba(255,255,255,.25);
    color:#fff;cursor:pointer;user-select:none;
    font-size:clamp(14px,2.4vmin,18px);letter-spacing:.03em;
    padding:.4em .8em;line-height:1;border-radius:8px;
  }
  .zoomLabel{color:#fff;opacity:.8;font-size:clamp(14px,2.2vmin,16px);letter-spacing:.03em}

  /* ì¤‘ì•™ ì˜¤ë²„ë ˆì´ â€” í°íŠ¸/í˜•ì‹ ì™„ì „ í†µì¼ */
  #overlay{
    position:fixed;inset:0;z-index:200;
    display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.65);
    color:#fff;text-align:center;
  }
  #overlayContent{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  }
  .msgBtn, .msg{
    font-size:clamp(14px,2.5vmin,20px);
    letter-spacing:.03em;
    padding:.6em 1.1em;
    background:rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.25);
    color:#fff;display:inline-block;
  }
  .msgBtn{cursor:pointer;}
  .fadeOut{animation:fadeOut .8s ease forwards;}
  @keyframes fadeOut{to{opacity:0;visibility:hidden}}
</style>
</head>
<body>
  <!-- ì¹´ë©”ë¼ -->
  <canvas id="view"></canvas>

  <!-- ë ˆì¡¸ë£¸ -->
  <iframe id="ninjaOverlay"
          allow="autoplay; fullscreen; camera; microphone; clipboard-read; clipboard-write"
          referrerpolicy="no-referrer"></iframe>

  <!-- í”„ë¡œì‹œë‹ˆì—„(ì–‡ì€ í° í…Œë‘ë¦¬) -->
  <div class="proscenium" aria-hidden="true"></div>

  <!-- í™•ëŒ€/ì¶•ì†Œ -->
  <div class="zoomDock" aria-label="zoom controls">
    <button class="zoomBtn" id="btnZoomOut" aria-label="zoom out">âˆ’</button>
    <span class="zoomLabel">Zoom</span>
    <button class="zoomBtn" id="btnZoomIn" aria-label="zoom in">ï¼‹</button>
  </div>

  <!-- ì‹œì‘ ì˜¤ë²„ë ˆì´ -->
  <div id="overlay">
    <div id="overlayContent">
      <button id="btnStart" class="msgBtn">PRESS HERE TO START</button>
    </div>
  </div>

<script>
(()=>{

/* =======================
   êµ¬ì„±
   ======================= */
const CONFIG={
  ROOM_ID:"YOURROOMID",  // â† VDO.Ninja ë£¸ ID
  BLEND:0.5,             // ë ˆì¡¸ë£¸ ì˜¤ë²„ë ˆì´ ë¶ˆíˆ¬ëª…ë„ (50%)
  PROC_SCALE:0.5         // ğŸ”¥ ì¹´ë©”ë¼ ì²˜ë¦¬ í•´ìƒë„(50%)
};

/* =======================
   VDO.Ninja (ì„¸ë¡œ/ê°€ë¡œ ëª¨ë‘ ì»¤ë²„)
   ======================= */
const injectedCss = encodeURIComponent(`
  html,body{background:transparent!important;margin:0!important;overflow:hidden!important;}
  #container,.container{background:transparent!important;}
  video,canvas{
    position:fixed!important; inset:0!important;
    width:100vw!important; height:100vh!important;
    object-fit:cover!important; background:transparent!important;
  }
`);
const ninja = document.getElementById("ninjaOverlay");
const ninjaBase =
  \`https://vdo.ninja/?view=\${encodeURIComponent(CONFIG.ROOM_ID)}&clean&autostart&noaudio&codec=vp8&solo&transparent=1&css=\${injectedCss}\`;
ninja.src = \`\${ninjaBase}&ts=\${Date.now()}\`;

function setOverlay(on){ ninja.style.opacity = on ? CONFIG.BLEND : 0; }

/* =======================
   ì¹´ë©”ë¼ íŒŒì´í”„ë¼ì¸ (í‘ë°± + COVER)
   ======================= */
const view = document.getElementById("view");
const vctx = view.getContext("2d",{alpha:false});
const cam  = document.createElement("video"); cam.autoplay=true; cam.muted=true; cam.playsInline=true;
const proc = document.createElement("canvas"); const pctx = proc.getContext("2d",{willReadFrequently:true});
let CAM_ZOOM=1.0;

function setViewportVars(){
  const vv=window.visualViewport;
  const w=Math.round(vv?.width||window.innerWidth);
  const h=Math.round(vv?.height||window.innerHeight);
  document.documentElement.style.setProperty("--vwpx", w+"px");
  document.documentElement.style.setProperty("--vhpx", h+"px");
}
function fitAll(){
  setViewportVars();
  const w=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--vwpx"));
  const h=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--vhpx"));
  view.width=w; view.height=h;
  proc.width=Math.max(2, Math.floor(w*CONFIG.PROC_SCALE));
  proc.height=Math.max(2, Math.floor(h*CONFIG.PROC_SCALE));
}
window.addEventListener("resize", fitAll);
window.addEventListener("orientationchange", ()=>setTimeout(fitAll, 60));
if (window.visualViewport){
  visualViewport.addEventListener("resize", fitAll);
  visualViewport.addEventListener("scroll", fitAll);
}
fitAll();

async function startCamera(){
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
  cam.srcObject=s; await cam.play().catch(()=>{});
}

let anim=false;
function ensureLoop(){ if(anim) return; anim=true; loop(); }
function loop(){
  requestAnimationFrame(loop);

  // 1) cam -> proc (cover + zoom + b/w)
  const PW=proc.width, PH=proc.height;
  pctx.clearRect(0,0,PW,PH);
  if (cam.readyState>=2){
    const vw=cam.videoWidth||0, vh=cam.videoHeight||0;
    if(vw&&vh){
      const sc=Math.max(PW/vw, PH/vh)*CAM_ZOOM;
      const dw=vw*sc, dh=vh*sc, dx=(PW-dw)/2, dy=(PH-dh)/2;
      pctx.drawImage(cam,dx,dy,dw,dh);
      const img=pctx.getImageData(0,0,PW,PH), d=img.data;
      for(let i=0;i<d.length;i+=4){
        const g=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])|0; d[i]=d[i+1]=d[i+2]=g;
      }
      pctx.putImageData(img,0,0);
    }
  }

  // 2) proc -> view (cover)
  const W=view.width, H=view.height;
  vctx.clearRect(0,0,W,H);
  const cover=Math.max(W/PW, H/PH);
  const dw2=PW*cover, dh2=PH*cover, dx2=(W-dw2)/2, dy2=(H-dh2)/2;
  vctx.drawImage(proc,dx2,dy2,dw2,dh2);
}

/* =======================
   ë¶€ì €ìŒ & ì¤Œ ë²„íŠ¼
   ======================= */
function beep(){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='square'; o.frequency.value=880;
    o.connect(g).connect(ctx.destination);
    g.gain.setValueAtTime(0.22, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.1);
    o.start(); o.stop(ctx.currentTime+0.1);
  }catch{}
}
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
document.getElementById("btnZoomIn").addEventListener("click", ()=>{ beep(); CAM_ZOOM = clamp(CAM_ZOOM+0.1, 0.8, 2.0); });
document.getElementById("btnZoomOut").addEventListener("click",()=>{ beep(); CAM_ZOOM = clamp(CAM_ZOOM-0.1, 0.8, 2.0); });

/* =======================
   ì‹œì‘ ì˜¤ë²„ë ˆì´ ì‹œí€€ìŠ¤ (í°íŠ¸/í˜•ì‹ ë™ì¼)
   ======================= */
const overlay = document.getElementById("overlay");
const overlayContent = document.getElementById("overlayContent");
document.getElementById("btnStart").addEventListener("click", async ()=>{
  beep();
  await startCamera(); fitAll(); ensureLoop();
  setOverlay(true); // ëˆ„ë¥´ìë§ˆì ë ˆì¡¸ë£¸ í‘œì‹œ

  // 2ë‹¨ê³„: íƒ€ì´í‹€
  overlayContent.innerHTML = '<button id="btnWelcome" class="msgBtn">WELCOME TO HISTORY OF NIGHTMARE</button>';
  document.getElementById("btnWelcome").addEventListener("click", ()=>{
    beep();
    overlayContent.innerHTML = '<div class="msg">SHOW WILL BEGIN SOON</div>';
    setTimeout(()=>{
      overlayContent.innerHTML = '<div class="msg">PLEASE CAPTURING THE MOMENT</div>';
      setTimeout(()=>{
        overlayContent.classList.add("fadeOut");
        setTimeout(()=>{ overlay.style.display="none"; }, 820);
      }, 3000);
    }, 3000);
  });
});

})();
</script>
</body>
</html>
