<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>History of Nightmare — PWA + Rez 65% + Proscenium</title>

<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#000000">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --vwpx:100vw; --vhpx:100vh;
    --gap:32px;
    --line-color:rgba(255,255,255,.9); --line-w:1px; --line-r:2px;
    --ff-ui:"Courier New", Courier, monospace;
    --stage-fs:clamp(14px,2vmax,22px);
    --sub-fs:clamp(11px,1.5vmax,16px);
    --body-fs:clamp(12px,1.7vmax,18px);
    --btn-pad-y:.45em; --btn-pad-x:1em; --btn-border:1px;
    --letter-space:.03em; --line-height:1.45;
  }
  @media (orientation:landscape){
    :root{ --gap:24px; }
  }
  html,body{
    margin:0;height:100%;background:#000;color:#fff;overflow:hidden;
    -webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;
    font-family:var(--ff-ui); line-height:var(--line-height);
    text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased;
  }
  *,*::before,*::after{ box-sizing:border-box; }
  button{ font:inherit;color:inherit;background:none;border:none;padding:0;margin:0;cursor:pointer; }

  /* Camera canvas */
  #view{ position:fixed;left:0;top:0;width:var(--vwpx);height:var(--vhpx);display:block;z-index:0; }

  /* VDO.Ninja overlay (Resolume feed) */
  #ninjaOverlay{
    position:fixed;left:50%;top:50%;width:var(--vwpx);height:var(--vhpx);
    transform:translate(-50%,-50%) scale(1);transform-origin:50% 50%;
    border:0;z-index:10;pointer-events:none;opacity:0;transition:opacity .35s ease;background:transparent;
  }

  /* Proscenium */
  .proscenium{
    position:fixed;
    left:calc(var(--gap) + env(safe-area-inset-left));
    right:calc(var(--gap) + env(safe-area-inset-right));
    top:calc(var(--gap) + env(safe-area-inset-top));
    bottom:calc(var(--gap) + env(safe-area-inset-bottom));
    border:var(--line-w) solid var(--line-color); border-radius:var(--line-r);
    z-index:90; pointer-events:none; transform:translateZ(0);
  }

  /* IN/OUT */
  .controls{ position:fixed;right:calc(16px + env(safe-area-inset-right));bottom:calc(16px + env(safe-area-inset-bottom));z-index:100;display:flex;gap:8px; }
  .uiBtn{ padding:.4em .8em; text-transform:uppercase; letter-spacing:var(--letter-space); }

  /* Overlay (intro flow) */
  #overlay{ position:fixed; inset:0; z-index:200; display:flex; align-items:center; justify-content:center; padding:20px; }
  #overlayContent{ text-align:center; transition:opacity .45s ease; display:flex; flex-direction:column; gap:12px; align-items:center; max-width:min(900px,92vw); }
  .hidden{ opacity:0 }

  .stageBtn{ display:none; padding:var(--btn-pad-y) var(--btn-pad-x); border:var(--btn-border) solid #fff; text-transform:uppercase; letter-spacing:var(--letter-space); font-size:var(--stage-fs); }
  .stageText{ font-size:var(--stage-fs); text-transform:uppercase; letter-spacing:var(--letter-space); }
  .subText{ font-size:var(--sub-fs); opacity:.95; }

  /* INTRO */
  #introWrap{ display:none; text-align:left; }
  #introWrap h2{ text-align:center; margin:6px 0 10px; letter-spacing:.06em; }
  #introWrap ol{ margin:0; padding-left:1.2em; font-size:var(--body-fs); }
  #introWrap li{ margin:.3em 0; line-height:1.55; }
  #introWrap .tips{ margin-top:10px; font-size:var(--body-fs); }
  #introWrap .tips li{ margin:.25em 0; }
  #sleepBtn{ margin-top:14px; }

  /* GOOD NIGHT message */
  #goodNight{ display:none; margin-top:8px; }
</style>
</head>
<body>
  <canvas id="view"></canvas>

  <iframe id="ninjaOverlay" allow="autoplay; fullscreen; camera; microphone; clipboard-read; clipboard-write"
          allowtransparency="true" referrerpolicy="no-referrer" src="about:blank"></iframe>

  <div class="proscenium" aria-hidden="true"></div>

  <div class="controls">
    <button class="uiBtn" id="btnIn">IN</button>
    <button class="uiBtn" id="btnOut">OUT</button>
  </div>

  <!-- Intro Overlay -->
  <div id="overlay">
    <div id="overlayContent">
      <!-- STEP 1 -->
      <div id="tapAnywhere" class="subText">화면을 가볍게 탭하여 <b>카메라 허용</b>을 진행해주세요</div>

      <!-- STEP 2 (Android) -->
      <button id="allowBtn" class="stageBtn" aria-label="Request camera permission">허용 버튼</button>
      <div id="allowSub" class="subText" style="display:none;">버튼을 눌러 브라우저의 카메라 권한 창을 띄우세요</div>

      <!-- STEP 3: Welcome -->
      <button id="welcomeBtn" class="stageBtn stageText" aria-label="Welcome">WELCOME TO HISTORY OF NIGHTMARE</button>
      <div id="welcomeSub" class="subText" style="display:none;">악몽의 역사에 오신 것을 환영합니다</div>

      <!-- STEP 4: INTRO + SLEEP -->
      <div id="introWrap">
        <h2 class="stageText">INTRODUCTION</h2>
        <ol>
          <li>안녕하세요. <b>크리에이티브 허브 모임</b>입니다. 공연 <b>《악몽의 역사》</b>에 와주셔서 감사합니다.</li>
          <li>이 작품은 연출가 <b>손희범</b>이 <b>2024년 11월 이후</b> 지속된 악몽의 <b>원인을 추적</b>하는 여정입니다.</li>
          <li>여러분은 이 앱을 활용해 전개되는 ‘악몽의 역사’를 함께 따라가는 <b>공동 발굴자</b>가 됩니다.</li>
          <li>본 공연은 <b>지정 좌석이 없습니다</b>. 자유롭게 이동하며 관람해 주세요.</li>
          <li>휴대폰으로 공간을 탐사하고, 곳곳의 <b>퍼포머</b>를 가까이에서 관찰할 수 있습니다.</li>
          <li>여러분이 촬영하는 영상 위에, 제작에 사용된 <b>리서치 자료·문서</b>와 <b>퍼포머의 과정</b>이 <b>실시간으로 투사</b>됩니다.</li>
        </ol>
        <ul class="tips">
          <li>휴대폰은 <b>가로 모드</b> 사용을 추천합니다.</li>
          <li>잠시 후 <b>비상벨이 세 번</b> 울립니다.</li>
          <li>세 번 울린 뒤 아래 <b>“PRESS&nbsp;HERE&nbsp;TO&nbsp;SLEEP”</b> 버튼을 눌러 <b>악몽 속으로 진입</b>하세요.</li>
        </ul>
        <button id="sleepBtn" class="stageBtn" aria-label="Press to sleep">PRESS&nbsp;HERE&nbsp;TO&nbsp;SLEEP</button>
      </div>

      <!-- GOOD NIGHT 메시지 -->
      <div id="goodNight" class="stageText">GOOD NIGHT. HAVE A NICE DREAM.</div>
    </div>
  </div>

<script>
/* ===== PWA: Service Worker ===== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js").catch(console.warn);
}

/* ===== Fullscreen ===== */
async function goFullscreen() {
  const el = document.documentElement;
  try {
    if (el.requestFullscreen) await
