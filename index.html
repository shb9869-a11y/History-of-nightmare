<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,interactive-widget=resizes-content">
<title>SLEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEP</title>
<link rel="stylesheet"
href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SLEEP">
<meta name="theme-color" content="#000000">
<style>
:root{
--appH: 100svh;
--frame: clamp(16px, 4vmin, 40px);
--ui-gap: 8px;
--fs-body: clamp(12px, 2.2vmin, 16px);
--fs-strong: clamp(14px, 2.8vmin, 20px);
--fs-small: clamp(11px, 1.8vmin, 14px);
--fs-name: clamp(14px,2.8vmin,20px);
--pad-btn-y: clamp(6px, 1.1vmin, 10px);
--pad-btn-x: clamp(10px, 1.8vmin, 20px);
--safe-t: env(safe-area-inset-top, 0px);
--safe-b: env(safe-area-inset-bottom, 0px);
--safe-l: env(safe-area-inset-left, 0px);
--safe-r: env(safe-area-inset-right, 0px);
--dialogue-offset-vh: 8vh;
--char-offset-vh: 16vh;
--accent: #f5f5f5;
}
html,body{
margin:0;
padding:0;
width:100%;
height:100%;
background:#000;
overflow:hidden;
touch-action:manipulation;
}
body{
font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans KR",sans-serif;
-webkit-user-select:none;
user-select:none;
-webkit-touch-callout:none;
color:var(--accent);
}
*{
-webkit-user-select:none;
user-select:none;
-webkit-touch-callout:none;
-webkit-tap-highlight-color: transparent;
box-sizing:border-box;
}
input, textarea{
-webkit-user-select:text;
user-select:text;
}
.fade{opacity:0; transition:opacity 1800ms ease}
.fade.show{opacity:1}
#view{
position:fixed;
left:0;
top:0;
width:100vw;
height:100vh;
display:block;
z-index:0;
filter:grayscale(1);
image-rendering: pixelated;
}
#fg{
position:fixed;
left:0;
top:0;
width:100vw;
height:100vh;
display:block;
z-index:40;
pointer-events:none;
}
/* mp4 ë¹„ë””ì˜¤ (í™”ë©´ì—ëŠ” ì•ˆ ë³´ì´ê²Œ) */
#layerVideo{
display:none;
}
#freezeLayer{
position:fixed;
inset:0;
z-index:500;
display:none;
}
.frameBox{
position:fixed;
left:calc(var(--frame) + var(--safe-l));
top:calc(var(--frame) + var(--safe-t));
right:calc(var(--frame) + var(--safe-r));
bottom:calc(var(--frame) + var(--safe-b));
border:2px solid rgba(245,245,245,.85);
pointer-events:none;
z-index:50;
}
.uiBtn{
background:transparent;
color:var(--accent);
border:none;
font-size:var(--fs-strong);
padding:var(--pad-btn-y) var(--pad-btn-x);
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
white-space:nowrap;
cursor:pointer;
user-select:none;
}
.uiBtn.small{
font-size:var(--fs-small);
padding:calc(var(--pad-btn-y)*0.6) calc(var(--pad-btn-x)*0.6);
}
.uiBtn.flat{
border:none;
background:transparent;
text-decoration:none;
}
.uiBtn[disabled]{
opacity:.35;
pointer-events:none;
filter:grayscale(1);
}
.hide{display:none !important;}
.controls{
position:fixed;
right:calc(var(--frame) + var(--ui-gap) + var(--safe-r));
bottom:calc(var(--frame) + var(--ui-gap) + var(--safe-b));
z-index:400;
display:flex;
gap:6px;
align-items:center;
opacity:0;
transition:opacity 1800ms ease;
}
.controls.show{opacity:1}
.readout{
min-width:48px;
text-align:center;
opacity:.9;
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
font-size:var(--fs-small);
color:var(--accent);
}
.btn-capture{
position:fixed;
left:calc(var(--frame) + var(--ui-gap) + var(--safe-l));
bottom:calc(var(--frame) + var(--ui-gap) + var(--safe-b));
z-index:450;
opacity:0;
transition:opacity 1800ms ease;
}
.btn-capture.show{opacity:1}
.sleep-status-text{
position:fixed;
left:calc(var(--frame) + var(--ui-gap) + var(--safe-l));
bottom:calc(var(--frame) + var(--ui-gap) + var(--safe-b) + 36px);
z-index:451;
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
font-size:var(--fs-small);
color:#f7f7f7;
text-shadow:0 0 4px rgba(0,0,0,0.8);
}
/* SKIP / RETURN (SKIPì€ ì™„ì „íˆ ìˆ¨ê¹€ ì²˜ë¦¬) */
.skip-btn{
position:fixed;
left:calc(var(--frame) + var(--ui-gap) + var(--safe-l));
top:calc(var(--frame) + var(--ui-gap) + var(--safe-t));
z-index:1001;
display:none !important;
}
/* ìƒˆ ëª©ì°¨ ë©”ë‰´ ë²„íŠ¼ */
.menu-btn{
position:fixed;
left:calc(var(--frame) + var(--ui-gap) + var(--safe-l));
top:calc(var(--frame) + var(--ui-gap) + var(--safe-t));
z-index:1002;
}
#runTimer{
position:fixed;
right:calc(var(--frame) + var(--ui-gap) + var(--safe-r));
top:calc(var(--frame) + var(--ui-gap) + var(--safe-t));
z-index:460;
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
font-size:var(--fs-strong);
color:var(--accent);
opacity:.95;
pointer-events:none;
user-select:none;
display:none;
}
.credits{
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
letter-spacing:.08em;
font-size:clamp(9px,1.4vmin,11px);
margin:0;
color:var(--accent);
}
#rotateOverlay{
position:fixed;
inset:0;
z-index:1000;
display:none;
align-items:center;
justify-content:center;
text-align:center;
background:#000;
color:var(--accent);
padding:40px;
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
pointer-events:auto;
}
/* ğŸ”´ SECOND SLEEP GAME í”„ë ˆì„ (iframe) */
#secondGameFrame{
position:fixed;
left:calc(var(--frame) + var(--safe-l));
top:calc(var(--frame) + var(--safe-t));
right:calc(var(--frame) + var(--safe-r));
bottom:calc(var(--frame) + var(--safe-b));
z-index:700;
display:flex;
align-items:center;
justify-content:center;
background:#000;
}
#secondGameFrame.hide{
display:none !important;
}
#secondGameFrame iframe{
width:100%;
height:100%;
border:none;
background:#000;
}
/* Gate */
#overlay{
position:fixed;
inset:0;
z-index:300;
display:flex;
align-items:center;
justify-content:center;
padding:calc(20px + var(--safe-t)) calc(20px + var(--safe-r)) calc(20px + var(--safe-b)) calc(20px + var(--safe-l));
color:var(--accent);
background:rgba(0,0,0,.85);
}
#overlayContent{
max-width:min(92vw, 72ch);
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
line-height:1.7;
text-align:center;
}
.gateLine{
display:inline-block;
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
font-size:var(--fs-small);
border:none;
background:transparent;
color:var(--accent);
cursor:pointer;
padding:6px 10px;
width:100%;
line-height:1.6;
}
.gateHint{
opacity:.7;
margin-top:6px;
font-size:clamp(9px,1.6vmin,11px);
}
/* Name */
#nameOverlay{
position:fixed;
inset:0;
z-index:260;
display:none;
align-items:center;
justify-content:center;
background:rgba(0,0,0,.5);
color:var(--accent);
}
#nameCard{
position:relative;
z-index:1;
width:min(92vw,600px);
text-align:center;
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
padding:24px 20px 20px;
border:none;
background:transparent;
box-shadow:none;
}
#nameCard h2{
margin:0 0 12px 0;
letter-spacing:.12em;
font-size:var(--fs-name);
font-weight:400;
text-shadow:0 0 12px rgba(0,0,0,.9);
color:var(--accent);
}
#nick{
width:100%;
padding:14px 14px;
background:transparent;
border:1px solid rgba(245,245,245,0.7);
color:var(--accent);
font-size:var(--fs-name);
outline:none;
box-shadow:none;
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
}
#nick::placeholder{
color:rgba(245,245,245,0.25);
}
#nameRow{
display:none;
}
/* í‚¤ë³´ë“œ : ì˜ì–´ë§Œ ì…ë ¥ */
.keyboard{
margin-top:18px;
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
width:100%;
max-width:600px;
height:50vh;
padding:10px 8px 6px;
background:transparent;
border:none;
box-shadow:none;
pointer-events:auto;
}
.keyboard-row{
display:flex;
justify-content:center;
flex:1;
width:100%;
margin-bottom:4px;
}
.keyboard-row:last-child{
margin-bottom:0;
}
.key{
flex:1;
min-width:0;
padding:6px 2px;
margin:0 2px;
border-radius:2px;
border:1px solid rgba(245,245,245,0.7);
background:rgba(0,0,0,0.5);
color:#f5f5f5;
font-size:clamp(10px,2.2vmin,14px);
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
text-align:center;
box-shadow:0 2px 0 #000;
cursor:pointer;
}
.key.wide{
flex:3 0 0;
}
/* í”„ë¦¬ì…‹ ê¿€ë ì´ */
#preset{
position:fixed;
inset:0;
z-index:30;
background:transparent;
display:none;
cursor:pointer;
}
#presetCanvas{
position:absolute;
left:0;top:0;width:100%;height:100%;
}
/* 2ì¥ ì•ˆë‚´ íŒíŠ¸ */
#presetHint{
position:fixed;
left:50%;
bottom:calc(var(--frame) + var(--ui-gap)*2 + var(--safe-b));
transform:translateX(-50%);
z-index:60;
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
font-size:clamp(9px,1.6vmin,11px);
color:#7a2020;
text-shadow:0 0 4px rgba(0,0,0,0.8);
pointer-events:none;
opacity:0;
}
/* Welcome */
#overlayWelcome{
position:fixed;
inset:0;
z-index:220;
display:none;
place-items:center;
color:var(--accent);
background:rgba(0,0,0,.55);
padding:0;
}
#welcomeCard{
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
width:100%;
max-width:min(92vw, 820px);
margin:0 auto;
text-align:center;
padding:calc(20px + var(--safe-t)) 20px calc(20px + var(--safe-b)) 20px;
gap:18px;
}
#welcomeCard .title{
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
font-size:clamp(28px, 8vmin, 72px);
font-weight:400;
letter-spacing:.12em;
line-height:1.15;
margin:0;
text-transform:uppercase;
color:var(--accent);
white-space:nowrap;
}
#goIntro{
margin-top:0;
font-size:var(--fs-small);
}
/* INTRODUCTION í™”ë©´ */
#introBig{
position:fixed;
inset:0;
display:none;
z-index:210;
background:#000;
color:var(--accent);
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
pointer-events:auto;
}
#introLayout{
position:absolute;
inset:0;
padding:calc(18px + var(--safe-t)) calc(20px + var(--safe-r)) calc(20px + var(--safe-b)) calc(20px + var(--safe-l));
display:flex;
flex-direction:column;
gap:10px;
}
.intro-topbar{display:none;}
.intro-main{
flex:0 0 auto;
display:flex;
align-items:flex-start;
justify-content:center;
margin-top:6vh;
}
/* ì¸íŠ¸ë¡œ ì¹´ë“œ */
.intro-card{
width:100%;
max-width:1120px;
height:min(40vh, 340px);
background:transparent;
box-shadow:none;
border-radius:0;
padding:0;
display:flex;
flex-direction:column;
position:relative;
color:var(--accent);
}
.intro-card-header{display:none;}
.intro-char-area{
flex:1;
background:#555555;
position:relative;
overflow:hidden;
border:none;
}
/* ì¸íŠ¸ë¡œ í…ìŠ¤íŠ¸ */
.intro-text-panel{
flex:0 0 auto;
width:100%;
max-width:1120px;
margin:10px auto 0;
display:flex;
justify-content:space-between;
}
.intro-text-box{
font-family:"Courier New",ui-monospace,monospace;
font-size:clamp(10px,1.8vmin,13px);
line-height:1.7;
color:var(--accent);
white-space:pre-wrap;
text-align:left;
}
#introTextLeft{
max-width:min(40vw, 360px);
}
#introTextCenter{
max-width:min(40vw, 360px);
}
/* ì•„ë˜ NEXT ì˜ì—­ */
.intro-bottom{
margin-top:8px;
width:100%;
max-width:1120px;
margin-left:auto;
margin-right:auto;
display:flex;
justify-content:flex-end;
gap:18px;
font-family:"Courier New",ui-monospace,monospace;
font-size:clamp(10px,1.8vmin,13px);
line-height:1.7;
color:var(--accent);
}
#introBigText{
display:none;
}
/* TITLE ì˜¤ë²„ë ˆì´: ë°°ê²½ íˆ¬ëª… */
#introTitleOverlay{
position:fixed;
inset:0;
z-index:215;
display:none;
align-items:center;
justify-content:center;
background:transparent;
color:var(--accent);
}
/* FIRST SLEEP ì œëª© */
#firstSleep{
position:fixed;
inset:0;
display:none;
align-items:center;
justify-content:center;
pointer-events:none;
z-index:850;
text-align:center;
}
#firstSleepText{}
/* NOTE íŒì—… */
#noticePopup{
position:fixed;
inset:0;
z-index:900;
display:none;
align-items:center;
justify-content:center;
background:rgba(0,0,0,.72);
}
#noticeCard{
width:min(92vw, 640px);
background:#0b0b0b;
color:var(--accent);
border:1px solid #555;
padding:18px;
box-shadow:0 10px 30px rgba(0,0,0,.6);
font-family:"Courier New",ui-monospace,monospace;
line-height:1.7;
}
#noticeCard h3{
margin:0 0 6px 0;
letter-spacing:.06em;
font-weight:700;
font-size:clamp(15px,3vmin,20px);
color:var(--accent);
}
#noticeCard p{
margin:4px 0;
font-size:clamp(12px,2.4vmin,16px);
}
#noticeActions{
margin-top:10px;
text-align:right;
}
/* 2ì¥ ë…¸í‹°ìŠ¤ */
#noticePopup2{
position:fixed;
inset:0;
z-index:900;
display:none;
align-items:center;
justify-content:center;
background:rgba(0,0,0,.72);
}
#noticeCard2{
width:min(92vw, 640px);
background:#0b0b0b;
color:var(--accent);
border:1px solid #555;
padding:18px;
box-shadow:0 10px 30px rgba(0,0,0,.6);
font-family:"Courier New",ui-monospace,monospace;
line-height:1.7;
}
#noticeCard2 h3{
margin:0 0 6px 0;
letter-spacing:.06em;
font-weight:700;
font-size:clamp(15px,3vmin,20px);
color:var(--accent);
}
#noticeCard2 p{
margin:4px 0;
font-size:clamp(12px,2.4vmin,16px);
}
#noticeActions2{
margin-top:10px;
text-align:right;
}
/* FIRST SLEEP ì•ˆë‚´ í…ìŠ¤íŠ¸ */
#chapterOverlay{
position:fixed;
inset:0;
z-index:930;
display:none;
align-items:center;
justify-content:center;
background:transparent;
color:var(--accent);
padding:24px;
pointer-events:none;
}
#chapterCenter{
max-width:min(900px, 92vw);
max-height:80vh;
display:flex;
align-items:center;
justify-content:center;
text-align:center;
overflow:hidden;
}
#chapterBox{
display:inline-block;
font-family:"Courier New",ui-monospace,monospace;
line-height:1.8;
font-size:clamp(11px,2.0vmin,15px);
text-align:center;
color:var(--accent);
padding:0;
background:transparent;
border:none;
box-shadow:none;
}
/* ê³µí†µ íƒ€ì´í‹€ */
.sleepLine{
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
letter-spacing:.16em;
font-size:clamp(32px, 12vmin, 160px);
text-transform:uppercase;
white-space:nowrap;
text-shadow:0 0 8px rgba(0,0,0,.85);
margin:6px 0;
padding:8px 16px;
background:transparent;
border:none;
display:inline-block;
text-align:center;
max-width:96vw;
box-sizing:border-box;
}
/* 1ì¥ íƒ€ì´í‹€ - ë°°ê²½ íˆ¬ëª… */
#firstTransition{
position:fixed;
inset:0;
display:none;
flex-direction:column;
align-items:center;
justify-content:center;
background:transparent;
color:var(--accent);
z-index:940;
pointer-events:none;
text-align:center;
}
#firstTransWord{ margin-bottom:10px; }
#firstTransTitle{ margin-top:10px; }
/* 2ì¥ íƒ€ì´í‹€ - ë°°ê²½ íˆ¬ëª… */
#sleepTransition{
position:fixed;
inset:0;
display:none;
flex-direction:column;
align-items:center;
justify-content:center;
background:transparent;
color:var(--accent);
z-index:940;
pointer-events:none;
text-align:center;
}
#sleepLine1,
#sleepLine2,
#sleepSecondTitle{
margin:6px 0;
}
/* 3,4ì¥ */
#thirdTransition,
#fourthTransition,
#noticePopup3,
#mapOverlay,
#mapPop{
display:none;
}
#thirdTransition{
position:fixed;
inset:0;
display:none;
flex-direction:column;
align-items:center;
justify-content:center;
background:transparent;
color:var(--accent);
z-index:940;
pointer-events:none;
text-align:center;
}
#fourthTransition{
position:fixed;
inset:0;
display:none;
flex-direction:column;
align-items:center;
justify-content:center;
background:transparent;
color:var(--accent);
z-index:940;
pointer-events:none;
text-align:center;
}
/* ğŸ”´ THE THIRD SLEEP ë³¸ë¬¸ í™”ë©´ */
#thirdSleepScreen{
position:fixed;
inset:0;
z-index:920;
display:none;
align-items:center;
justify-content:center;
background:#000;
color:var(--accent);
font-family:"Courier New",ui-monospace,monospace;
pointer-events:auto;
}
#thirdSleepInner{
max-width:min(720px, 90vw);
text-align:center;
padding:24px 20px 20px;
line-height:1.8;
}
#thirdSleepText{
white-space:pre-line;
margin-bottom:22px;
font-size:clamp(12px,2.1vmin,16px);
opacity:0;
transition:opacity 900ms ease;
}
/* 3ì¥ HUD (í”½ì…€ ê²Œì„ ëŠë‚Œ) */
#thirdSleepHUD{
margin-top:14px;
display:flex;
align-items:center;
justify-content:center;
gap:16px;
}
#thirdSleepTimer{
min-width:60px;
padding:6px 10px;
border:2px solid var(--accent);
border-radius:4px;
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
font-size:var(--fs-small);
text-align:center;
background:#000;
}
/* END í™”ë©´ */
#endOverlay{
position:fixed;
inset:0;
display:none;
align-items:center;
justify-content:center;
background:#000;
color:var(--accent);
z-index:950;
}
#endInner{
display:flex;
flex-direction:column;
align-items:center;
gap:18px;
}
#endReturn{
font-family:"Courier New",ui-monospace,monospace;
font-size:clamp(11px,2.0vmin,15px);
max-width:72ch;
line-height:1.7;
text-align:center;
}
/* ê¹œë¹¡ì´ ë ˆì´ì–´ */
#flashLayer{
position:fixed;
inset:0;
background:#ffffff;
opacity:0;
pointer-events:none;
mix-blend-mode:screen;
z-index:1200;
}
/* ëª©ì°¨ ì˜¤ë²„ë ˆì´ */
#navOverlay{
position:fixed;
inset:0;
z-index:1300;
display:none;
align-items:center;
justify-content:center;
background:rgba(0,0,0,0.86);
color:var(--accent);
font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
}
#navInner{
width:80vw;
max-width:420px;
background:rgba(0,0,0,0.95);
border:1px solid rgba(245,245,245,0.5);
padding:18px 20px 14px;
box-shadow:0 10px 30px rgba(0,0,0,0.7);
}
#navInner h3{
margin:0 0 12px 0;
font-size:clamp(14px,2.6vmin,18px);
letter-spacing:.14em;
}
.nav-list{
list-style:none;
margin:0;
padding:0;
}
.nav-list li{
margin:3px 0;
}
.nav-link{
width:100%;
text-align:left;
font-size:clamp(11px,2.1vmin,14px);
}
#navClose{
margin-top:10px;
text-align:right;
}
</style>
</head>
<body>
<canvas id="view"></canvas>
<canvas id="fg"></canvas>
<video id="layerVideo"
src="./media/firstsleep_layer.mp4"
preload="auto"
playsinline
webkit-playsinline></video>
<canvas id="freezeLayer"></canvas>
<div class="frameBox" aria-hidden="true"></div>
<div id="secondGameFrame" class="hide">
<iframe id="secondGameIframe"
src="second-sleep-game.html"
title="THE SECOND SLEEP GAME"
frameborder="0"
allow="autoplay; fullscreen"></iframe>
</div>
<div class="controls" id="controls">
<button class="uiBtn small" id="zoomOut">â€“</button>
<div class="readout"><span id="zoomVal">1.0Ã—</span></div>
<button class="uiBtn small" id="zoomIn">+</button>
</div>
<button id="captureBtn" class="uiBtn small btn-capture">CAPTURE</button>
<input
id="sleepPhotoInput"
type="file"
accept="image/*"
capture="environment"
style="display:none"
/>
<div id="sleepPhotoStatus" class="sleep-status-text"></div>
<button id="skipBtn" class="uiBtn small skip-btn" type="button">SKIP</button>
<button id="returnBtn" class="uiBtn small skip-btn" type="button" style="display:none;">RETURN</button>
<button id="menuBtn" class="uiBtn small menu-btn" type="button">â‰¡</button>
<div id="runTimer" aria-live="polite">08:00</div>
<div id="rotateOverlay" aria-live="polite">
<div>
<b>Landscape mode required</b><br/>
Please rotate your device to landscape to continue.<br/>
If the screen doesnâ€™t rotate, unlock orientation in your device settings.
</div>
</div>
<div id="flashLayer"></div>
<div id="overlay" class="fade show">
<div id="overlayContent">
<div class="credits">WELCOME TO</div>
<button id="permGateBtn" class="gateLine" type="button">
Tap anywhere to allow Camera &amp; Microphone
</button>
<div class="gateHint">After allowing, you'll move to the name screen.</div>
</div>
</div>
<div id="nameOverlay" class="fade">
<div id="nameCard">
<h2>TELL ME YOUR NAME</h2>
<input id="nick" type="text" maxlength="24" autocomplete="off" readonly inputmode="none" />
<div id="nameRow"></div>
<div class="keyboard">
<div class="keyboard-row">
<button class="key" data-key="Q">Q</button>
<button class="key" data-key="W">W</button>
<button class="key" data-key="E">E</button>
<button class="key" data-key="R">R</button>
<button class="key" data-key="T">T</button>
<button class="key" data-key="Y">Y</button>
<button class="key" data-key="U">U</button>
<button class="key" data-key="I">I</button>
<button class="key" data-key="O">O</button>
<button class="key" data-key="P">P</button>
</div>
<div class="keyboard-row">
<button class="key" data-key="A">A</button>
<button class="key" data-key="S">S</button>
<button class="key" data-key="D">D</button>
<button class="key" data-key="F">F</button>
<button class="key" data-key="G">G</button>
<button class="key" data-key="H">H</button>
<button class="key" data-key="J">J</button>
<button class="key" data-key="K">K</button>
<button class="key" data-key="L">L</button>
</div>
<div class="keyboard-row">
<button class="key" data-key="Z">Z</button>
<button class="key" data-key="X">X</button>
<button class="key" data-key="C">C</button>
<button class="key" data-key="V">V</button>
<button class="key" data-key="B">B</button>
<button class="key" data-key="N">N</button>
<button class="key" data-key="M">M</button>
</div>
<div class="keyboard-row">
<button class="key wide" data-key="space">SPACE</button>
<button class="key" data-key="go">GO</button>
</div>
</div>
</div>
</div>
<div id="preset" class="fade" title="Tap to continue">
<canvas id="presetCanvas"></canvas>
</div>
<div id="presetHint" class="fade" style="display:none;">ê¿€ë ì´ë¥¼ í´ë¦­í•´ ì•ˆë‚´ë¬¸ì„ ë°œê²¬í•˜ì„¸ìš”</div>
<div id="overlayWelcome" class="fade">
<div id="welcomeCard">
<div class="credits">WELCOME TO</div>
<div class="title">SLEEEEEEEEP,</div>
<div class="title">SLEEEEEEEEP,</div>
<div class="title">SLEEEEEEEEP,</div>
<div class="title">SLEEEEEEEEP,</div>
<button id="goIntro" class="uiBtn flat" type="button">PRESS HERE TO SLEEP</button>
</div>
</div>
<div id="introBig" class="fade">
<div id="introLayout">
<div class="intro-topbar"></div>
<div class="intro-main">
<div class="intro-card">
<div class="intro-card-header"></div>
<div class="intro-char-area" id="introPanel">
</div>
</div>
</div>
<div class="intro-text-panel">
<div id="introTextLeft" class="intro-text-box"></div>
<div id="introTextCenter" class="intro-text-box"></div>
</div>
<div class="intro-bottom">
<button id="introNext" class="uiBtn small" type="button">NEXT</button>
</div>
<div id="introBigText" class="sleepLine" style="display:none;">INTRODUCTION</div>
</div>
</div>
<div id="introTitleOverlay" class="fade">
<div id="introTitleWord" class="sleepLine"></div>
</div>
<div id="firstSleep"><div id="firstSleepText" class="sleepLine">THE FIRST SLEEP</div></div>
<div id="noticePopup" class="fade" role="dialog" aria-modal="true" aria-labelledby="noticeTitle">
<div id="noticeCard">
<h3 id="noticeTitle">NOTE</h3>
<p>â€» â€œTHE FIRST SLEEPâ€ì€ ëˆˆê³¼ ê·€ë¡œ íƒ€ìë¥¼ ì¸ì‹í•´ ë‚˜ê°€ëŠ” ì±•í„°ì…ë‹ˆë‹¤.</p>
<p>â€» ë‹¹ì‹ ì˜ íƒœë¸”ë¦¿ ìœ„ë¡œ íƒ€ìì— ê´€í•œ ëª‡ê°€ì§€ í”ì ë“¤ì´ ì œì‹œë  ê²ƒì…ë‹ˆë‹¤.</p>
<p>â€» ë”ë¶ˆì–´, ê³µê°„ ì†ì—ëŠ” ê·¸ë“¤ì˜ í”ì  (ë¶•ëŒ€, ì² ê·¼, ê¸°ë¦„, ë’¤ì§‘ê°œ, ì˜·ë”ë¯¸ì™€ ê°™ì€)ì´ ìˆ¨ê²¨ì ¸ ìˆìŠµë‹ˆë‹¤.</p>
<p>â€» ì´ëŸ¬í•œ í”ì ë“¤ì— ê·€ë¥¼ ê¸°ìš¸ì´ë©°, í™”ë©´ ì•„ë˜ â€˜CAPTUREâ€™ì™€ â€˜+â€™, â€˜-â€™ë²„íŠ¼ì„ ëˆŒëŸ¬ ê·¸ê²ƒë“¤ì„ í¬ì°©í•˜ì„¸ìš”.</p>
<p>â€» í•´ë‹¹ ì±•í„°ëŠ” 8ë¶„ ê°„ì˜ ì‹œê°„ ë™ì•ˆ ì§„í–‰ë©ë‹ˆë‹¤.</p>
<p>â€» í™•ì¸í•˜ì…¨ë‹¤ë©´, ì•„ë˜ â€˜OKâ€™ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
<div id="noticeActions">
<button id="noticeOk" class="uiBtn flat" type="button">OK</button>
</div>
</div>
</div>
<div id="noticePopup2" class="fade" role="dialog" aria-modal="true" aria-labelledby="noticeTitle2">
<div id="noticeCard2">
<h3 id="noticeTitle2">NOTE</h3>
<p>â€» â€œTHE SECOND SLEEPâ€ì€ í™”ë©´ ìœ„ ê¿€ë ì´ë“¤ì´ ì‚¬ë¼ì§„ ë’¤ë¶€í„° ì‹œì‘ë©ë‹ˆë‹¤.</p>
<p>â€» ë°©ê¸ˆ ì „ê¹Œì§€ì˜ í™”ë©´ê³¼ ì†Œë¦¬ëŠ” í•˜ë‚˜ì˜ ì”ìƒìœ¼ë¡œ ë‚¨ì•„ ìˆìŠµë‹ˆë‹¤.</p>
<p>â€» í™”ë©´ì€ ì´ì œ ë¹„ì›Œì§„ ì±„, ë‹¹ì‹ ì˜ ë‚´ë©´ì˜ ì”í–¥ë§Œì„ ë‚¨ê²¨ë‘˜ ê²ƒì…ë‹ˆë‹¤.</p>
<p>â€» í™•ì¸í•˜ì…¨ë‹¤ë©´, ì•„ë˜ â€˜OKâ€™ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
<div id="noticeActions2">
<button id="notice2Ok" class="uiBtn flat" type="button">OK</button>
</div>
</div>
</div>
<div id="chapterOverlay" class="fade">
<div id="chapterCenter">
<div id="chapterBox"></div>
</div>
</div>
<div id="firstTransition" class="fade">
<div id="firstTransWord" class="sleepLine"></div>
<div id="firstTransTitle" class="sleepLine"></div>
</div>
<div id="sleepTransition" class="fade">
<div id="sleepLine1" class="sleepLine"></div>
<div id="sleepLine2" class="sleepLine"></div>
<div id="sleepSecondTitle" class="sleepLine"></div>
</div>
<div id="thirdTransition" class="fade">
<div id="thirdSleepLine1" class="sleepLine"></div>
<div id="thirdSleepLine2" class="sleepLine"></div>
<div id="thirdSleepLine3" class="sleepLine"></div>
<div id="thirdTitle" class="sleepLine">THE THIRD SLEEP</div>
</div>
<div id="fourthTransition" class="fade">
<div id="fourthSleepLine1" class="sleepLine"></div>
<div id="fourthSleepLine2" class="sleepLine"></div>
<div id="fourthSleepLine3" class="sleepLine"></div>
<div id="fourthSleepLine4" class="sleepLine"></div>
<div id="fourthTitle" class="sleepLine">THE FOURTH SLEEP</div>
</div>
<div id="noticePopup3" class="fade"></div>
<div id="mapOverlay"><canvas id="mapCanvas"></canvas></div>
<div id="mapPop"></div>
<div id="thirdSleepScreen" class="fade">
<div id="thirdSleepInner">
<div id="thirdSleepText"></div>
<div id="thirdSleepHUD">
<div id="thirdSleepTimer">30</div>
<button id="thirdSleepStartBtn" class="uiBtn small" type="button">START</button>
<button id="thirdSleepOffBtn" class="uiBtn small" type="button" style="display:none;">OFF</button>
</div>
</div>
</div>
<div id="endOverlay" class="fade">
<div id="endInner">
<div id="endSilence" class="sleepLine"></div>
<div id="endTheEnd" class="sleepLine"></div>
<div id="endReturn"></div>
</div>
</div>
<div id="navOverlay" class="fade">
<div id="navInner">
<h3>CHAPTERS</h3>
<ul class="nav-list">
<li><button class="uiBtn small nav-link" data-target="name">NAME</button></li>
<li><button class="uiBtn small nav-link" data-target="preset">PRESET</button></li>
<li><button class="uiBtn small nav-link" data-target="welcome">WELCOME</button></li>
<li><button class="uiBtn small nav-link" data-target="intro">INTRODUCTION</button></li>
<li><button class="uiBtn small nav-link" data-target="first">THE FIRST SLEEP</button></li>
<li><button class="uiBtn small nav-link" data-target="second">THE SECOND SLEEP</button></li>
<li><button class="uiBtn small nav-link" data-target="third">THE THIRD SLEEP</button></li>
<li><button class="uiBtn small nav-link" data-target="end">THE END</button></li>
</ul>
<div id="navClose">
<button class="uiBtn small" type="button" data-target="close">CLOSE</button>
</div>
</div>
</div>
<script>
(() => {
const SLEEP_UPLOAD_SERVER = 'https://172.16.14.60:4443';
let stage = 'gate';
async function uploadSnapshotCanvas(canvas){
try{
setSleepPhotoStatus('ì„œë²„ë¡œ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...');
const blob = await new Promise((resolve) => {
canvas.toBlob((b) => resolve(b), "image/jpeg", 0.9);
});
if(!blob){
console.error("ìº¡ì²˜ Blob ìƒì„± ì‹¤íŒ¨");
setSleepPhotoStatus('ìº¡ì³ ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
return;
}
const formData = new FormData();
formData.append("image", blob, `sleep_capture_${Date.now()}.jpg`);
const base = (SLEEP_UPLOAD_SERVER && SLEEP_UPLOAD_SERVER.trim())
? SLEEP_UPLOAD_SERVER.trim()
: '';
const res = await fetch(base + "/upload", {
method: "POST",
body: formData
});
if(!res.ok){
console.error("ì—…ë¡œë“œ HTTP ì—ëŸ¬:", res.status, res.statusText);
setSleepPhotoStatus('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + res.status);
return;
}
const data = await res.json().catch(() => ({}));
console.log("ì—…ë¡œë“œ ì„±ê³µ:", data);
setSleepPhotoStatus('ì—…ë¡œë“œ ì™„ë£Œ! (ì ì‹œ í›„ í™”ë©´ì— ë°˜ì˜ë©ë‹ˆë‹¤)');
setTimeout(()=>setSleepPhotoStatus(''), 6000);
}catch(err){
console.error("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", err);
setSleepPhotoStatus('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
setTimeout(()=>setSleepPhotoStatus(''), 6000);
}
}
(function injectManifest(){
const manifest = {
"name":"SLEEEEEP",
"short_name":"SLEEEEEP",
"display":"fullscreen",
"start_url":"./",
"background_color":"#000",
"theme_color":"#000",
"icons":[]
};
const url = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"}));
const link = document.createElement('link');
link.rel='manifest';
link.href=url;
document.head.appendChild(link);
})();
async function enterFullscreen(){
try{
const el = document.documentElement;
if (!document.fullscreenElement) {
if (el.requestFullscreen) await el.requestFullscreen({ navigationUI: 'hide' });
else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
}
}catch(e){}
try{
if (screen.orientation && screen.orientation.lock) {
await screen.orientation.lock('landscape').catch(()=>{});
}
}catch(e){}
}
let wakeLock = null;
async function keepAwake(){
try{
if ('wakeLock' in navigator) {
wakeLock = await navigator.wakeLock.request('screen');
wakeLock.addEventListener('release', ()=>{});
}
}catch(e){}
}
function claimImmersive(){ enterFullscreen(); keepAwake(); }
document.addEventListener('visibilitychange', async ()=>{
if (document.visibilityState === 'visible' && wakeLock) {
try{ wakeLock = await navigator.wakeLock.request('screen'); }catch(e){}
}
});
const FADE = 1800;
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const nextFrame = () => new Promise(resolve=>requestAnimationFrame(()=>resolve()));
const qs = s => document.querySelector(s);
/* ===== ì˜¤ë””ì˜¤ ===== */
let audioCtx = null;
let audioPrimed = false;
function ensureAudio(){
if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
async function primeAudio(){
ensureAudio();
if(audioCtx.state === 'suspended'){
try{ await audioCtx.resume(); }catch(e){}
}
audioPrimed = true;
}
async function ensureResumed(){
ensureAudio();
if(audioCtx.state === 'suspended'){
try{ await audioCtx.resume(); }catch(e){}
}
}
const MASTER_BGM_GAIN = 1.26;
const MASTER_SFX_GAIN = 0.45;
document.addEventListener('contextmenu', e=>e.preventDefault());
document.addEventListener('selectstart', e=>e.preventDefault());
function fadeShow(el, dur=FADE, display='flex'){
el.style.display=display;
el.style.opacity='0';
el.style.transition=`opacity ${dur}ms ease`;
requestAnimationFrame(()=> el.style.opacity='1');
}
function fadeHide(el, dur=FADE){
el.style.transition=`opacity ${dur}ms ease`;
el.style.opacity='0';
setTimeout(()=>{ el.style.display='none'; }, dur);
}
function setAppH(){ document.documentElement.style.setProperty('--appH', window.innerHeight + 'px'); }
setAppH();
addEventListener('resize', setAppH, {passive:true});
if (window.visualViewport){
visualViewport.addEventListener('resize', ()=>setTimeout(setAppH,50));
}
const rotateOverlay = qs('#rotateOverlay');
function isPortrait(){
const vv=window.visualViewport;
const w=vv?vv.width:innerWidth, h=vv?vv.height:innerHeight;
return h>w;
}
function updateRotateOverlay(){
rotateOverlay.style.display = isPortrait() ? 'flex' : 'none';
}
['load','pageshow','resize','orientationchange','visibilitychange'].forEach(ev=>{
addEventListener(ev, updateRotateOverlay, {passive:true});
});
updateRotateOverlay();
const overlay = qs('#overlay');
const permBtn = qs('#permGateBtn');
const nameOverlay = qs('#nameOverlay');
const nickInput = qs('#nick');
const preset = qs('#preset');
const presetCanvas = qs('#presetCanvas');
const presetHint = qs('#presetHint');
const welcome = qs('#overlayWelcome');
const introBig = qs('#introBig');
const introBigText = qs('#introBigText');
const introTextLeft = qs('#introTextLeft');
const introTextCenter = qs('#introTextCenter');
const introNextBtn = qs('#introNext');
const introTitleOverlay = qs('#introTitleOverlay');
const introTitleWord = qs('#introTitleWord');
const firstSleep = qs('#firstSleep');
const firstSleepText = qs('#firstSleepText');
const controls = qs('#controls');
const zoomIn = qs('#zoomIn');
const zoomOut = qs('#zoomOut');
const zoomVal = qs('#zoomVal');
const captureBtn = qs('#captureBtn');
const view = qs('#view');
const fg = qs('#fg');
const freezeLayer = qs('#freezeLayer');
const runTimer = qs('#runTimer');
const noticePopup = qs('#noticePopup');
const noticeOk = qs('#noticeOk');
const noticePopup2 = qs('#noticePopup2');
const notice2Ok = qs('#notice2Ok');
const chapterOverlay = qs('#chapterOverlay');
const chapterBox = qs('#chapterBox');
const firstTransition = qs('#firstTransition');
const firstTransWord = qs('#firstTransWord');
const firstTransTitle = qs('#firstTransTitle');
const sleepTransition = qs('#sleepTransition');
const sleepLine1 = qs('#sleepLine1');
const sleepLine2 = qs('#sleepLine2');
const sleepSecondTitle = qs('#sleepSecondTitle');
/* ğŸ”´ THIRD SLEEP íƒ€ì´í‹€ ìš”ì†Œ */
const thirdTransition = qs('#thirdTransition');
const thirdSleepLine1 = qs('#thirdSleepLine1');
const thirdSleepLine2 = qs('#thirdSleepLine2');
const thirdSleepLine3 = qs('#thirdSleepLine3');
const thirdTitle = qs('#thirdTitle');
/* ğŸ”´ THIRD SLEEP ë³¸ë¬¸ í™”ë©´ ìš”ì†Œ */
const thirdSleepScreen = qs('#thirdSleepScreen');
const thirdSleepText = qs('#thirdSleepText');
const thirdSleepStartBtn = qs('#thirdSleepStartBtn');
const thirdSleepOffBtn = qs('#thirdSleepOffBtn');
const thirdSleepTimerEl = qs('#thirdSleepTimer');
const skipBtn = qs('#skipBtn'); // í•­ìƒ ìˆ¨ê¹€
const returnBtn = qs('#returnBtn');
const endOverlay = qs('#endOverlay');
const endSilence = qs('#endSilence');
const endTheEnd = qs('#endTheEnd');
const endReturn = qs('#endReturn');
const sleepPhotoInput = qs('#sleepPhotoInput');
const sleepPhotoStatus = qs('#sleepPhotoStatus');
const keyboardEl = document.querySelector('.keyboard');
const flashLayer = qs('#flashLayer');
const layerVideo = document.getElementById('layerVideo');
const menuBtn = qs('#menuBtn');
const navOverlay = qs('#navOverlay');
const secondGameFrame = document.getElementById('secondGameFrame');
const secondGameIframe = document.getElementById('secondGameIframe');
function setSleepPhotoStatus(msg){
if(!sleepPhotoStatus) return;
sleepPhotoStatus.textContent = msg || '';
}
/* ğŸ”´ SECOND GAME ë³´ì—¬ì£¼ê¸° / ìˆ¨ê¸°ê¸° */
function showSecondGame(){
if(secondGameFrame){
secondGameFrame.classList.remove('hide');
}
if(controls) controls.classList.remove('show');
if(captureBtn) captureBtn.classList.remove('show');
// ì¹´ë©”ë¼ / ë ˆì´ì–´ ë¹„ë””ì˜¤ëŠ” ë„ê³ , ê²Œì„ í™”ë©´ë§Œ
showCamera = false;
camFadeAlpha = 1;
stopLayerVideo();
}
function hideSecondGame(){
if(secondGameFrame){
secondGameFrame.classList.add('hide');
}
}
if (sleepPhotoInput) {
sleepPhotoInput.addEventListener('change', async () => {
const file = sleepPhotoInput.files && sleepPhotoInput.files[0];
if (!file) return;
setSleepPhotoStatus('ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...');
try{
const formData = new FormData();
formData.append('image', file);
const base = (SLEEP_UPLOAD_SERVER && SLEEP_UPLOAD_SERVER.trim())
? SLEEP_UPLOAD_SERVER.trim()
: '';
const res = await fetch(base + '/upload', {
method: 'POST',
body: formData
});
if (!res.ok) {
throw new Error('Upload failed: ' + res.status);
}
const data = await res.json();
if (!data.success) {
throw new Error(data.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
}
setSleepPhotoStatus('ì—…ë¡œë“œ ì™„ë£Œ! (ì ì‹œ í›„ í™”ë©´ì— ë°˜ì˜ë©ë‹ˆë‹¤)');
console.log('ì—…ë¡œë“œëœ íŒŒì¼ URL:', (base || window.location.origin) + (data.url || ''));
}catch(err){
console.error(err);
setSleepPhotoStatus('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
}finally{
sleepPhotoInput.value = '';
setTimeout(()=>setSleepPhotoStatus(''), 6000);
}
});
}
let vctx = view.getContext('2d', { alpha: false });
let fgctx = fg.getContext('2d', { alpha: true });
let camPermGranted=false;
let camStream=null, camVideo=null, ZOOM=1.0;
let animStarted=false, capturing=false, warmupFrames=0;
let showIntroLayer=false;
let fgAlpha=1.0;
let showCamera=false;
let camFadeAlpha=0;
let typeBuffer = null;
let lastTypeSoundTime = 0;
function buildTypeBuffer(ctx){
const duration = 0.05;
const sampleRate = ctx.sampleRate;
const length = Math.floor(sampleRate * duration);
const buffer = ctx.createBuffer(1, length, sampleRate);
const data = buffer.getChannelData(0);
const freq = 750;
for(let i=0;i<length;i++){
const t = i / sampleRate;
const env = Math.exp(-t * 10);
const phase = 2 * Math.PI * freq * t;
data[i] = Math.sin(phase) * env * 0.9;
}
return buffer;
}
function playGameInputSound(){
try{
ensureAudio();
const ctx = audioCtx;
const now = ctx.currentTime || 0;
if(now - lastTypeSoundTime < 0.06) return;
lastTypeSoundTime = now;
if(!typeBuffer) typeBuffer = buildTypeBuffer(ctx);
const src = ctx.createBufferSource();
src.buffer = typeBuffer;
const g = ctx.createGain();
g.gain.value = MASTER_SFX_GAIN * 0.8;
src.connect(g).connect(ctx.destination);
src.start();
}catch(e){}
}
function typeTick(){ playGameInputSound(); }
/* ===== ë‹‰ë„¤ì„ í‚¤ë³´ë“œ (ì˜ì–´ë§Œ) ===== */
function appendNickChar(ch){
nickInput.value += ch;
}
if(keyboardEl){
keyboardEl.addEventListener('click', (e)=>{
const keyEl = e.target.closest('.key');
if(!keyEl) return;
const code = keyEl.dataset.key;
if(!code) return;
typeTick();
if(code === 'space'){
appendNickChar(' ');
}else if(code === 'go'){
acceptName();
return;
}else{
const ch = (code || '').toUpperCase();
appendNickChar(ch);
}
});
}
function updateZoomLabel(){
zoomVal.textContent = ZOOM.toFixed(1)+'Ã—';
}
updateZoomLabel();
zoomIn.addEventListener('click', ()=>{
ZOOM=Math.min(3.0, ZOOM+0.1);
updateZoomLabel();
playWoongClick();
}, {passive:true});
zoomOut.addEventListener('click', ()=>{
ZOOM=Math.max(1.0, ZOOM-0.1);
updateZoomLabel();
playWoongClick();
}, {passive:true});
async function immediateGestureStart(e){
if(e && e.preventDefault) e.preventDefault();
claimImmersive();
await primeAudio();
try{
if (typeof DeviceOrientationEvent !== 'undefined' &&
typeof DeviceOrientationEvent.requestPermission === 'function') {
DeviceOrientationEvent.requestPermission().catch(()=>{});
}
}catch(_){}
navigator.mediaDevices.getUserMedia({
video:{
facingMode:{ideal:'environment'},
width:{min:1280,ideal:1920},
height:{min:720,ideal:1080},
aspectRatio:{ideal:16/9}
},
audio:{echoCancellation:true, noiseSuppression:true, autoGainControl:false}
})
.then((s)=>{
s.getTracks().forEach(t=>t.stop());
camPermGranted = true;
})
.catch(err=>{
console.warn('permission error:', err);
})
.finally(async ()=>{
fadeHide(overlay, FADE);
showPreset(true);
fadeShow(nameOverlay, FADE);
stage = 'name';
await ensureResumed();
Ambient.start(3.0, 1.2);
});
}
['click','touchstart','pointerdown'].forEach(type=>{
permBtn.addEventListener(type, immediateGestureStart, {passive:false});
overlay.addEventListener(type, immediateGestureStart, {passive:false});
window.addEventListener(type, (ev)=>{
if(getComputedStyle(overlay).display !== 'none'){
immediateGestureStart(ev);
}
}, {passive:false});
});
let displayName = '_____';
async function acceptName(){
claimImmersive();
await ensureResumed();
const v = (nickInput.value||'').trim();
if(v.length>0){ displayName = v; }
playWoongClick();
fadeHide(nameOverlay, FADE);
stage = 'preset';
preset.style.display = 'block';
preset.style.pointerEvents = 'auto';
}
nickInput.addEventListener('keydown', (e)=>{
if(e.key==='Enter'){ acceptName(); }
});
/* ===== í”„ë¦¬ì…‹ ë„í˜• ===== */
let saverT0 = 0;
const POLY_SEQ = [3,5,8,12,18,22,40];
const PRESET_SHAPE_COUNT = 8;
const PRESET_COLORS = [
'#000000',
'#050505',
'#0a0a0a',
'#0f0f0f',
'#141414',
'#191919',
'#1e1e1e',
'#232323'
];
let presetShapes = null;
function showPreset(shouldWarmupCamera=true){
if(preset.style.display!=='block'){
preset.style.display='block';
preset.classList.add('show');
fadeShow(preset, FADE, 'block');
initSaver();
if(shouldWarmupCamera){
startCameraFresh(true);
}
}
preset.style.pointerEvents = 'auto';
}
function createPresetShapes(w,h){
const arr=[];
const diag = Math.min(w,h);
for(let i=0;i<PRESET_SHAPE_COUNT;i++){
arr.push({
baseX: w*(0.15 + 0.7*Math.random()),
baseY: h*(0.15 + 0.7*Math.random()),
ampX: diag*(0.18 + 0.32*Math.random()),
ampY: diag*(0.16 + 0.30*Math.random()),
speed: 0.06 + 0.04*i + Math.random()*0.03,
phase: Math.random()*Math.PI*2,
sizeScale: 0.5 + Math.random()*1.4,
alive: true
});
}
return arr;
}
function initSaver(){
saverT0 = performance.now();
presetShapes = null;
requestAnimationFrame(saverLoop);
}
function saverLoop(){
if(preset.style.display==='none') {
return;
}
const now = performance.now();
const w = preset.clientWidth || 1;
const h = preset.clientHeight || 1;
const dpr = devicePixelRatio || 1;
if(!presetShapes || presetShapes.length!==PRESET_SHAPE_COUNT){
presetShapes = createPresetShapes(w,h);
}
presetCanvas.width = w * dpr;
presetCanvas.height = h * dpr;
const ctx = presetCanvas.getContext('2d');
ctx.setTransform(dpr,0,0,dpr,0,0);
ctx.clearRect(0,0,w,h);
ctx.fillStyle = '#000000';
ctx.fillRect(0,0,w,h);
const t = (now - saverT0)/1000;
const baseR = Math.min(w,h) * 0.22;
const nodesAbs = [];
presetShapes.forEach((s, idx)=>{
if(!s.alive) return;
const tt = t * s.speed + s.phase;
let nx = s.baseX + Math.cos(tt) * s.ampX;
let ny = s.baseY + Math.sin(tt*0.9) * s.ampY;
const margin = baseR*0.6;
nx = clamp(nx, margin, w-margin);
ny = clamp(ny, margin, h-margin);
const wobble = 1 + 0.35*Math.sin(t*1.1 + idx);
const r = baseR * s.sizeScale * wobble;
const seq = POLY_SEQ.concat([0]);
const cycle = seq.length;
let p = (t*0.12 + idx*0.21) % cycle;
let si = Math.floor(p);
let sides = seq[si];
ctx.save();
ctx.translate(nx, ny);
ctx.rotate(Math.sin(t*0.7 + idx)*0.4);
ctx.beginPath();
if(sides === 0){
const N = 32;
for(let i=0;i<N;i++){
const ang = (i/(N-1))*Math.PI;
const localR = r*(0.7 + 0.35*Math.sin(ang));
const x = Math.cos(ang)*localR;
const y = Math.sin(ang)*localR*(idx%2?1.4:0.6);
if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
}
for(let i=N-1;i>=0;i--){
const ang = (i/(N-1))*Math.PI;
const localR = r*(0.3 + 0.45*Math.sin(ang));
const x = Math.cos(Math.PI-ang)*localR;
const y = Math.sin(Math.PI-ang)*localR*(idx%2?1.4:0.6);
ctx.lineTo(x,y);
}
ctx.closePath();
}else{
for(let i=0;i<sides;i++){
const ang = (i/sides)*Math.PI*2 - Math.PI/2;
const localR = r*(0.8 + 0.18*Math.sin(t*1.8 + i + idx));
const x = Math.cos(ang)*localR;
const y = Math.sin(ang)*localR;
if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
}
ctx.closePath();
}
const color = PRESET_COLORS[idx % PRESET_COLORS.length];
ctx.fillStyle = color;
ctx.strokeStyle = 'rgba(245,245,245,0.6)';
ctx.lineWidth = 2.4;
ctx.fill();
ctx.stroke();
ctx.restore();
nodesAbs.push({x:nx,y:ny, idx, r});
});
if(nodesAbs.length>1){
ctx.save();
ctx.strokeStyle = '#7a2020';
ctx.lineWidth = 1.8;
ctx.beginPath();
nodesAbs.forEach((n,i)=>{
if(i===0) ctx.moveTo(n.x,n.y);
else ctx.lineTo(n.x,n.y);
});
ctx.stroke();
ctx.fillStyle = '#b03030';
nodesAbs.forEach(n=>{
ctx.beginPath();
ctx.arc(n.x, n.y, Math.min(w,h)*0.006, 0, Math.PI*2);
ctx.fill();
});
ctx.restore();
}
requestAnimationFrame(saverLoop);
}
function handlePresetClickForSecond(e){
if(stage !== 'secondIntroShapes') return;
const rect = presetCanvas.getBoundingClientRect();
const x = (e.clientX - rect.left);
const y = (e.clientY - rect.top);
const w = rect.width;
const h = rect.height;
if(!presetShapes || !presetShapes.length) return;
const now = performance.now();
const t = (now - saverT0)/1000;
const baseR = Math.min(w,h) * 0.22;
let hitSomething = false;
presetShapes.forEach((s,idx)=>{
if(!s.alive) return;
const tt = t * s.speed + s.phase;
let nx = s.baseX + Math.cos(tt) * s.ampX;
let ny = s.baseY + Math.sin(tt*0.9) * s.ampY;
const margin = baseR*0.6;
nx = clamp(nx, margin, w-margin);
ny = clamp(ny, margin, h-margin);
const dx = x - nx;
const dy = y - ny;
const dist = Math.sqrt(dx*dx + dy*dy);
const hitR = baseR * s.sizeScale * 0.9;
if(dist < hitR){
s.alive = false;
hitSomething = true;
}
});
if(hitSomething){
playWoongClick();
const anyAlive = presetShapes.some(s=>s.alive);
if(!anyAlive){
preset.style.pointerEvents = 'none';
fadeHide(presetHint, FADE);
fadeShow(noticePopup2, FADE, 'flex');
}
}
}
preset.addEventListener('click', (e)=>{
if(stage === 'preset'){
claimImmersive();
ensureResumed();
playWoongClick();
preset.style.pointerEvents = 'none';
fadeShow(welcome, FADE);
fitWelcomeTitles();
stage = 'welcome';
Ambient.start(3.0,1.2);
}else{
handlePresetClickForSecond(e);
}
});
function getFrameRect(){
const box = document.querySelector('.frameBox');
if (!box) {
return {
x: 0,
y: 0,
w: window.innerWidth,
h: window.innerHeight
};
}
const r = box.getBoundingClientRect();
return {
x: r.left,
y: r.top,
w: r.width,
h: r.height
};
}
function getProsceniumRect(){
if(stage === 'intro'){
const p = document.getElementById('introPanel');
if(p){
const r = p.getBoundingClientRect();
return { x:r.left, y:r.top, w:r.width, h:r.height };
}
}
const r = getFrameRect();
return { x:r.x, y:r.y, w:r.w, h:r.h };
}
function fitTitleLine(el){
if(!el) return;
const fr=getFrameRect();
const maxW=Math.min(window.innerWidth*0.96, fr.w*0.96);
const cs=getComputedStyle(el);
let size=parseFloat(cs.fontSize)||48;
el.style.whiteSpace='nowrap';
while(el.scrollWidth>maxW && size>16){
size*=0.94;
el.style.fontSize=size+'px';
}
}
function fitTitleLineSafe(){
fitTitleLine(introBigText);
fitTitleLine(firstSleepText);
}
window.addEventListener('load', fitTitleLineSafe);
function fitWelcomeTitles(){
const titles = document.querySelectorAll('#welcomeCard .title');
const card = document.getElementById('welcomeCard');
if(!titles.length || !card) return;
const maxW = card.clientWidth * 0.95;
titles.forEach(el=>{
el.style.whiteSpace='nowrap';
let size = parseFloat(getComputedStyle(el).fontSize) || 40;
while(el.scrollWidth>maxW && size>14){
size *= 0.94;
el.style.fontSize = size+'px';
}
});
}
window.addEventListener('resize', ()=>fitWelcomeTitles(), {passive:true});
/* ==== í”½ì…€ í† ë¼ ==== */
function drawRedRabbit(ctx, x, y, scale = 1){
ctx.fillStyle = '#ff3333';
ctx.fillRect(x + 2*scale, y + 1*scale, 4*scale, 3*scale);
ctx.fillRect(x + 1*scale, y - 1*scale, 1*scale, 3*scale);
ctx.fillRect(x + 4*scale, y - 1*scale, 1*scale, 3*scale);
ctx.fillRect(x + 2*scale, y + 4*scale, 4*scale, 3*scale);
ctx.fillRect(x + 6*scale, y + 4*scale, 2*scale, 2*scale);
}
function prosceniumWalkPos(t01){
const pr = getProsceniumRect();
const margin = Math.min(pr.w, pr.h) * 0.06;
const left = pr.x + margin;
const right = pr.x + pr.w - margin;
const top = pr.y + margin;
const bottom = pr.y + pr.h - margin;
const per = (right-left)*2 + (bottom-top)*2;
let d = ((t01%1)+1)%1 * per;
let x,y,edge;
if(d <= (right-left)){
x = left + d;
y = bottom;
edge = 'bottom';
}else if(d <= (right-left)+(bottom-top)){
d -= (right-left);
x = right;
y = bottom - d;
edge = 'right';
}else if(d <= (right-left)*2 + (bottom-top)){
d -= (right-left + (bottom-top));
x = right - d;
y = top;
edge = 'top';
}else{
d -= (right-left)*2 + (bottom-top);
x = left;
y = top + d;
edge = 'left';
}
return { x, y, baselineY:y, edge };
}
let introWalking=false;
let introStartTime=0;
const INTRO_WALK_DURATION=120_000;
function initIntroWalkers(){
introStartTime = performance.now();
}
const Ambient = (() => {
let ctx, master, delay, fb, hp, lp, mix, busGain, running=false, killers=[];
function midi(n){ return 440 * Math.pow(2, (n-69)/12); }
function setup(){
ensureAudio();
ctx = audioCtx;
master = ctx.createGain();
master.gain.value = 0.0001;
delay = ctx.createDelay(2.5);
delay.delayTime.value = 0.45;
fb = ctx.createGain();
fb.gain.value = 0.22;
delay.connect(fb).connect(delay);
hp = ctx.createBiquadFilter();
hp.type='highpass';
hp.frequency.value=150;
lp = ctx.createBiquadFilter();
lp.type='lowpass';
lp.frequency.value=4200;
lp.Q.value=0.9;
mix = ctx.createGain();
mix.gain.value = 0.55;
mix.connect(hp).connect(lp).connect(master);
busGain = ctx.createGain();
busGain.gain.value = 0.45;
busGain.connect(master);
master.connect(ctx.destination);
}
function connectDW(node){
node.connect(busGain);
node.connect(delay);
delay.connect(mix);
}
function airy(){
const b=ctx.createBuffer(1, ctx.sampleRate*2, ctx.sampleRate);
const d=b.getChannelData(0);
for(let i=0;i<d.length;i++){
d[i]=(Math.random()*2-1)*0.06;
}
const s=ctx.createBufferSource();
s.buffer=b; s.loop=true;
const g=ctx.createGain();
g.gain.value=0.015;
const f=ctx.createBiquadFilter();
f.type='bandpass';
f.frequency.value=1100;
f.Q.value=0.9;
s.connect(f).connect(g);
connectDW(g);
s.start();
killers.push(()=>{ try{s.stop();}catch{} });
}
function pad(root){
const out = ctx.createGain();
out.gain.value=0.24;
const filt=ctx.createBiquadFilter();
filt.type='lowpass';
filt.frequency.value=1200;
filt.Q.value=0.7;
const lfo=ctx.createOscillator();
const lfoG=ctx.createGain();
lfo.type='sine';
lfo.frequency.value=0.04;
lfoG.gain.value=260;
lfo.connect(lfoG).connect(filt.frequency);
lfo.start();
[0,7,12].forEach((i,k)=>{
const o=ctx.createOscillator();
o.type='triangle';
o.frequency.value=midi(root+i);
o.detune.value=(k-1)*4;
const g=ctx.createGain();
g.gain.value=0.035;
o.connect(g).connect(filt);
o.start();
killers.push(()=>{ try{g.disconnect();}catch{} });
});
filt.connect(out);
connectDW(out);
killers.push(()=>{ try{ out.disconnect(); }catch{} });
}
function plucked(root){
const now = ctx.currentTime;
const o = ctx.createOscillator();
const g = ctx.createGain();
const f = ctx.createBiquadFilter();
const steps = [0,7,12,14];
const pick = steps[Math.floor(Math.random()*steps.length)];
o.type='sine';
o.frequency.value=midi(root+pick);
g.gain.setValueAtTime(0.0001, now);
g.gain.exponentialRampToValueAtTime(MASTER_SFX_GAIN*0.4, now+0.04);
g.gain.exponentialRampToValueAtTime(0.0001, now+1.9);
f.type='bandpass';
f.frequency.value = o.frequency.value*2;
f.Q.value=4;
o.connect(f).connect(g);
connectDW(g);
o.start(now);
o.stop(now+2.1);
killers.push(()=>{ try{g.disconnect();}catch{} });
}
async function start(fadeIn=1.0, target=1.0){
await ensureResumed();
if(running) return;
setup();
running=true;
airy();
const seq=[57,52,48,43];
let i=0;
(function tick(){
if(!running) return;
const root = seq[i%seq.length];
pad(root);
if(Math.random()<0.4) plucked(root);
i++;
setTimeout(tick,9000);
})();
const t=ctx.currentTime;
const targetGain = MASTER_BGM_GAIN * target;
master.gain.cancelScheduledValues(t);
master.gain.setValueAtTime(0.0001, t);
master.gain.linearRampToValueAtTime(targetGain, t+fadeIn);
}
function stop(fade=2.0){
if(!running||!master) return;
const t=audioCtx.currentTime;
master.gain.cancelScheduledValues(t);
master.gain.setValueAtTime(master.gain.value, t);
master.gain.linearRampToValueAtTime(0.0001, t+fade);
setTimeout(()=>{
killers.forEach(fn=>{try{fn();}catch{}});
killers=[];
running=false;
}, fade*1000+200);
}
function isRunning(){ return running; }
return { start, stop, isRunning };
})();
async function playWoongClick(){
try{
ensureAudio();
const now = audioCtx.currentTime;
const o = audioCtx.createOscillator();
const g = audioCtx.createGain();
o.type='sine';
o.frequency.setValueAtTime(220, now);
o.frequency.exponentialRampToValueAtTime(110, now+0.24);
g.gain.setValueAtTime(0.0001, now);
g.gain.exponentialRampToValueAtTime(MASTER_SFX_GAIN, now+0.03);
g.gain.exponentialRampToValueAtTime(0.0001, now+0.35);
o.connect(g).connect(audioCtx.destination);
o.start(now);
o.stop(now+0.4);
}catch(e){}
}
async function playDreamWoong(){
try{
ensureAudio();
const now = audioCtx.currentTime;
const o = audioCtx.createOscillator();
const g = audioCtx.createGain();
o.type = 'sine';
o.frequency.setValueAtTime(90, now);
o.frequency.exponentialRampToValueAtTime(55, now+2.0);
g.gain.setValueAtTime(0.0001, now);
g.gain.exponentialRampToValueAtTime(MASTER_SFX_GAIN, now+0.15);
g.gain.exponentialRampToValueAtTime(0.0001, now+2.0);
o.connect(g).connect(audioCtx.destination);
o.start(now);
o.stop(now+2.05);
}catch(e){}
}
async function playDing(){
try{
ensureAudio();
const now = audioCtx.currentTime;
const o1 = audioCtx.createOscillator();
const o2 = audioCtx.createOscillator();
const g = audioCtx.createGain();
o1.type = 'sine';
o2.type = 'sine';
o1.frequency.setValueAtTime(440, now);
o2.frequency.setValueAtTime(660, now);
g.gain.setValueAtTime(0.0001, now);
g.gain.exponentialRampToValueAtTime(0.45, now+0.03);
g.gain.exponentialRampToValueAtTime(0.0001, now+0.7);
o1.connect(g);
o2.connect(g);
g.connect(audioCtx.destination);
o1.start(now);
o2.start(now);
o1.stop(now+0.75);
o2.stop(now+0.75);
}catch(e){}
}
async function flashWhoom(times=2){
await ensureResumed();
for(let i=0;i<times;i++){
await playDreamWoong();
await sleep(300);
}
}
const CHAPTER_SECONDS = 8 * 60;
let currentChapter = null;
let chapterTimer = null;
let chapterRemain = 0;
function formatMMSS(s){
const m = Math.floor(s/60);
const ss = (s%60).toString().padStart(2,'0');
return `${m.toString().padStart(2,'0')}:${ss}`;
}
function startChapterTimer(id){
if(chapterTimer){
clearInterval(chapterTimer);
chapterTimer = null;
}
currentChapter = id;
chapterRemain = CHAPTER_SECONDS;
runTimer.textContent = formatMMSS(chapterRemain);
runTimer.style.display = 'block';
chapterTimer = setInterval(()=>{
chapterRemain = Math.max(0, chapterRemain - 1);
runTimer.textContent = formatMMSS(chapterRemain);
if(chapterRemain <= 0){
clearInterval(chapterTimer);
chapterTimer = null;
runTimer.style.display = 'none';
if(id === 'first'){
onFirstSleepTimerEnd();
}else if(id === 'second'){
onSecondSleepTimerEnd();
}
}
}, 1000);
}
function stopChapterTimer(){
if(chapterTimer){
clearInterval(chapterTimer);
chapterTimer = null;
}
runTimer.style.display = 'none';
}
const INTRO_DIALOG_LINES = [
"ì•ˆë…•í•˜ì„¸ìš”.",
"í•´ë‹¹ í”„ë¡œê·¸ë¨ì— ì°¸ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.",
"ë³¸ ì‘í’ˆì€ í•œ ê°œì¸ì˜ ë‚´ë©´ ì„¸ê³„ë¥¼ íƒí—˜í•˜ëŠ” ì²´í—˜í˜• í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.",
"ê´€ê° ì—¬ëŸ¬ë¶„ì€ íƒœë¸”ë¦¿ê³¼ í—¤ë“œí°ì„ ì°©ìš©í•œ ì±„ë¡œ ê³µê°„ì„ íƒì‚¬í•˜ë©°, ì†Œë¦¬Â·ì´ë¯¸ì§€Â·ì§„ë™ì„ í†µí•´ ì‚¬ë¼ì§„ â€˜ë„ˆâ€™ì˜ í”ì ì„ ì«“ì•„ê°€ê²Œ ë©ë‹ˆë‹¤.",
"ì§€ë‚œ 6ê°œì›” ê°„ ì €í¬ëŠ” í˜„ëŒ€ ì‚¬íšŒ ì†ì—ì„œ íƒ€ìê°€ ì–´ë–»ê²Œ â€˜ë„ˆâ€™ì—ì„œ â€˜ê·¸ê²ƒâ€™ìœ¼ë¡œ ë³€í•´ê°€ëŠ”ì§€ë¥¼ íƒêµ¬í•´ì™”ìŠµë‹ˆë‹¤.",
"ê·¸ë¦¬ê³  \"ë„ˆë¥¼ í¬ì°©í•˜ë ¤ëŠ” 'ë‚˜'ì¡°ì°¨ ì´ ì„¸ê³„ì— ë“¤ì–´ì˜¨ ìˆœê°„ ë˜ í•˜ë‚˜ì˜ 'ê·¸ê²ƒ'ì´ ëœë‹¤ë©´, ìš°ë¦¬ëŠ” ì–´ë–»ê²Œ ë‹¤ì‹œ 'ë„ˆ'ë¥¼ ë§ˆì£¼í•  ìˆ˜ ìˆì„ê¹Œ?\"ë¼ëŠ” ë¬¼ìŒì— ë„ë‹¬í•˜ê²Œ ë˜ì—ˆë„¤ìš”.",
"ì§€ê¸ˆë¶€í„° ë‹¹ì‹ ì´ ê´€ì°°í•˜ê³  ê¸°ë¡í•˜ëŠ” ëª¨ë“  ì¥ë©´ì€ ì´ ì„¸ê³„ë¥¼ ì¬êµ¬ì„±í•˜ëŠ” ì¤‘ìš”í•œ ë‹¨ì„œê°€ ë©ë‹ˆë‹¤.",
"ê³µê°„ì˜ ì‚¬ì´ë¥¼ ê±°ë‹ë©°, ì´ ì„¸ê³„ê°€ ì‘ë™í•˜ëŠ” ë°©ì‹ê³¼ ê·¸ ì•ˆì—ì„œ í–‰ìœ„í•  ìˆ˜ ìˆëŠ” ìì‹ ì˜ ìœ„ì¹˜ë¥¼ ê²½í—˜í•˜ì„¸ìš”.",
"ì£¼ë³€ì˜ ì†Œë¦¬ì— ì§‘ì¤‘í•˜ê³ , íƒœë¸”ë¦¿ì˜ ì•ˆë‚´ì— ë”°ë¼ ë³´ì´ì§€ ì•ŠëŠ” í”ì , ê²½ê³„, ì‚¬ë¼ì§€ëŠ” ì´ë¯¸ì§€ë“¤ì„ í¬ì°©í•´ì£¼ì„¸ìš”.",
"ì´ ì—¬ì •ì€ ì•½ 30ë¶„ ê°„ ì´ì–´ì§€ë©°, ê° ë‹¨ê³„ëŠ” ë‹¹ì‹ ì´ â€˜ë„ˆâ€™ë¥¼ ì¸ì‹í•˜ëŠ” ë°©ì‹ì´ ì–´ë–»ê²Œ ë³€í™”ë  ìˆ˜ ìˆëŠ”ì§€ë¥¼ ì œì‹œí•©ë‹ˆë‹¤.",
"ì´ì œ ì²œì²œíˆ ê±¸ìŒì„ ë‚´ë”›ê³ , ë‚´ë©´ì˜ ë¯¸ë¡œë¡œ ì§„ì…í•´, ê·€ë¥¼ ê¸°ìš¸ì—¬ â€˜ë³´ì„¸ìš”.â€™"
];
let introLineIndex = 0;
let introTyping = false;
let introLeftLines = [];
let introCenterLines = [];
async function typeIntroLine(idx){
const text = INTRO_DIALOG_LINES[idx];
if(text == null){
introTyping = false;
introTextLeft.textContent = "";
introTextCenter.textContent = "";
fadeHide(introBig, FADE);
await sleep(FADE+80);
await startFirstSleepTransition();
return;
}
introTyping = true;
const targetIsLeft = (idx <= 5);
const targetEl = targetIsLeft ? introTextLeft : introTextCenter;
const targetArr = targetIsLeft ? introLeftLines : introCenterLines;
let currentBlock = targetArr.join("\n");
if(currentBlock.length>0) currentBlock += "\n";
let line = "";
for(let i=0;i<text.length;i++){
line += text[i];
targetEl.textContent = currentBlock + line;
typeTick();
await sleep(35);
}
targetArr.push(text);
const lines = targetArr.slice(-6);
targetEl.textContent = lines.join("\n");
introTyping = false;
}
async function typeSleepLine(el, text){
el.textContent = '';
for(let i=0;i<text.length;i++){
el.textContent += text[i];
typeTick();
await sleep(50);
}
fitTitleLine(el);
}
/* ğŸ”´ THIRD SLEEP ë³¸ë¬¸ í…ìŠ¤íŠ¸ */
const THIRD_SLEEP_LINES = [
"ì´ì œ ì €í¬ëŠ” THE THIRD SLEEPìœ¼ë¡œ ì§„ì…í•©ë‹ˆë‹¤.",
"",
"íƒœë¸”ë¦¿ì„ ë‚´ë ¤ë†“ê³ .",
"í—¤ë“œí°ì„ ë²—ê³ .",
"",
"ëˆˆì„ ê°ê³ .",
"ë§ˆìŒ ì†ìœ¼ë¡œ 30ì´ˆë¥¼ ì„¸ë©° ì ê¹ì˜ ì •ì ì„ ëŠê»´ë³¼ ê²ƒì…ë‹ˆë‹¤.",
"",
"START ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”."
];
/* ğŸ”´ THIRD SLEEP í…ìŠ¤íŠ¸: ê° ë¬¸ì¥ 2.5ì´ˆ ì •ë„ í…œí¬ë¡œ ì „í™˜ + ë§ˆì§€ë§‰ì— START ë“±ì¥ */
async function typeThirdSleepText(){
if(!thirdSleepText) return;
thirdSleepText.style.opacity = 0;
thirdSleepText.textContent = '';
const fadeInDur = 800; // 0.8ì´ˆ í˜ì´ë“œ ì¸
const holdDur = 1700; // 1.7ì´ˆ ìœ ì§€ â†’ í•© 2.5ì´ˆ
const fadeOutDur= 800;
for(let li=0; li<THIRD_SLEEP_LINES.length; li++){
const line = THIRD_SLEEP_LINES[li];
if(line.trim() === ''){
thirdSleepText.textContent = '';
await sleep(500);
continue;
}
thirdSleepText.textContent = line;
thirdSleepText.style.transition = `opacity ${fadeInDur}ms ease`;
thirdSleepText.style.opacity = 0;
await nextFrame();
typeTick();
thirdSleepText.style.opacity = 1;
await sleep(fadeInDur + holdDur);
thirdSleepText.style.opacity = 0;
await sleep(fadeOutDur);
}
// ğŸ”´ ëª¨ë“  í…ìŠ¤íŠ¸ê°€ ëë‚œ í›„ì—ì•¼ START ë²„íŠ¼ ë“±ì¥ + í™•ì‹¤íˆ í™œì„±í™”
if(thirdSleepStartBtn){
thirdSleepStartBtn.style.display = 'inline-block';
thirdSleepStartBtn.disabled = false;
thirdSleepStartBtn.style.pointerEvents = 'auto';
}
}
/* ğŸ”´ THE END í•œ ì¤„ì”© í˜ì´ë“œ ì¸ìš© í—¬í¼ */
async function fadeInLine(el, text, useHTML = false){
if(!el) return;
if(useHTML){
el.innerHTML = text;
}else{
el.textContent = text;
}
el.style.opacity = 0;
el.style.transition = 'opacity 1200ms ease';
await nextFrame();
el.style.opacity = 1;
await sleep(1600);
}
async function showIntroScreen(){
stage = 'intro';
showIntroLayer = true;
fgAlpha = 1.0;
fg.style.zIndex = '230';
showCamera = false;
camFadeAlpha = 1;
fadeShow(introBig, FADE, 'block');
introWalking = true;
initIntroWalkers();
introLeftLines = [];
introCenterLines = [];
introTextLeft.textContent = "";
introTextCenter.textContent = "";
introLineIndex = 0;
await typeIntroLine(introLineIndex);
}
async function showIntroTitleThenIntro(){
stage = 'introTitle';
introTitleWord.textContent = '';
fadeShow(introTitleOverlay, FADE, 'flex');
const word = 'INTRODUCTION';
for(let i=0;i<word.length;i++){
introTitleWord.textContent += word[i];
typeTick();
await sleep(50);
}
fitTitleLine(introTitleWord);
await flashWhoom(2);
await sleep(1800);
fadeHide(introTitleOverlay, FADE);
await sleep(FADE + 80);
await showIntroScreen();
}
const goIntroBtn = document.getElementById('goIntro');
goIntroBtn.addEventListener('click', async () => {
claimImmersive();
await ensureResumed();
playWoongClick();
fadeHide(welcome, FADE);
await sleep(FADE + 50);
await showIntroTitleThenIntro();
}, {passive:true});
introNextBtn.addEventListener('click', async () => {
claimImmersive();
await ensureResumed();
if(introTyping) return;
playWoongClick();
introLineIndex++;
await typeIntroLine(introLineIndex);
}, {passive:true});
function fadeOutIntroLayer(ms = 1500){
if(!showIntroLayer) return;
const startAlpha = fgAlpha;
const start = performance.now();
function step(){
const k = Math.min(1, (performance.now() - start) / ms);
fgAlpha = startAlpha * (1 - k);
if(k < 1){
requestAnimationFrame(step);
}else{
fgAlpha = 0;
showIntroLayer = false;
introWalking = false;
fg.style.zIndex = '40';
}
}
requestAnimationFrame(step);
}
async function startFirstSleepTransition(){
if (Ambient && Ambient.isRunning && Ambient.isRunning()){
Ambient.stop(3.0);
}
fadeOutIntroLayer(1500);
fadeHide(introBig, 600);
fadeHide(introTitleOverlay, 600);
await sleep(650);
stage = 'firstTransition';
firstTransWord.textContent = '';
firstTransTitle.textContent = '';
firstTransition.style.display = 'flex';
firstTransition.style.opacity = '0';
firstTransition.style.transition = `opacity 2000ms ease`;
await nextFrame();
firstTransition.style.opacity = '1';
const word = 'SLEEEEEEEEP,';
for(let i=0;i<word.length;i++){
firstTransWord.textContent += word[i];
typeTick();
await sleep(50);
}
fitTitleLine(firstTransWord);
await sleep(400);
firstTransTitle.textContent = '';
const title = 'THE FIRST SLEEP';
for(let i=0;i<title.length;i++){
firstTransTitle.textContent += title[i];
typeTick();
await sleep(50);
}
fitTitleLine(firstTransTitle);
await flashWhoom(2);
await sleep(1600);
firstTransition.style.transition = `opacity 1500ms ease`;
firstTransition.style.opacity = '0';
startMicFXFadeIn(3.0); // ğŸ”Š 1ì¥ì—ì„œë§Œ ë§ˆì´í¬ ë¦¬ë²„ë¸Œ
fadeInCamera(2500);
await sleep(1600);
firstTransition.style.display = 'none';
firstTransition.style.transition = '';
if(preset.style.display !== 'none'){
fadeHide(preset, 1500);
await sleep(1600);
}
stage = 'first';
controls.classList.add('show');
captureBtn.classList.add('show');
startLayerVideo();
await playDing();
fadeShow(noticePopup, FADE, 'flex');
}
noticeOk.addEventListener('click', async ()=>{
claimImmersive();
await ensureResumed();
playWoongClick();
await playDing();
fadeHide(noticePopup, FADE);
await sleep(FADE + 50);
startChapterTimer('first');
}, {passive:true});
async function onFirstSleepTimerEnd(){
if(stage !== 'first' && stage !== 'firstDone') return;
stage = 'firstDone';
await playDreamWoong();
fadeOutCamera(2500);
showPreset(false);
preset.style.pointerEvents = 'none';
sleepLine1.textContent = '';
sleepLine2.textContent = '';
sleepSecondTitle.textContent = '';
fadeShow(sleepTransition, FADE, 'flex');
await typeSleepLine(sleepLine1, 'SLEEEEEEEEP,');
await sleep(400);
await typeSleepLine(sleepLine2, 'SLEEEEEEEEP,');
await sleep(400);
await typeSleepLine(sleepSecondTitle, 'THE SECOND SLEEP');
await sleep(1200);
fadeHide(sleepTransition, FADE);
await sleep(FADE + 80);
stage = 'secondIntroShapes';
showCamera = false;
camFadeAlpha = 1;
stopLayerVideo();
// ğŸ”´ 2ì¥ë¶€í„°ëŠ” ë§ˆì´í¬ íš¨ê³¼ OFF
stopMicFXFadeOut(2.5);
preset.style.pointerEvents = 'auto';
fadeShow(presetHint, FADE, 'block');
}
notice2Ok.addEventListener('click', async ()=>{
claimImmersive();
await ensureResumed();
playWoongClick();
await playDing();
fadeHide(noticePopup2, FADE);
await sleep(FADE + 50);
stage = 'second';
showSecondGame();
startChapterTimer('second');
}, {passive:true});
async function onSecondSleepTimerEnd(){
if(stage !== 'second' && stage !== 'secondDone') return;
stage = 'secondDone';
await playDreamWoong();
}
/* ğŸ”´ THIRD SLEEP ë³¸ë¬¸: 30ì´ˆ ì •ì  íƒ€ì´ë¨¸ */
let thirdSleepTimerId = null;
let thirdSleepTimerRunning = false;
/* ğŸ”´ 3ì¥ ì•ŒëŒ ë£¨í”„ìš© ID */
let thirdAlarmIntervalId = null;
function startThirdAlarmLoop(){
if(thirdAlarmIntervalId) return;
thirdAlarmIntervalId = setInterval(()=>{
playDing();
}, 1200);
}
function stopThirdAlarmLoop(){
if(thirdAlarmIntervalId){
clearInterval(thirdAlarmIntervalId);
thirdAlarmIntervalId = null;
}
}
async function showThirdSleepScreen(){
stage = 'thirdText';
if(thirdSleepTimerId){
clearInterval(thirdSleepTimerId);
thirdSleepTimerId = null;
}
thirdSleepTimerRunning = false;
if(thirdSleepText){
thirdSleepText.textContent = '';
thirdSleepText.style.opacity = 0;
}
// ğŸ”´ ì²˜ìŒì—ëŠ” START ë²„íŠ¼ ìˆ¨ê¹€ + ë¹„í™œì„±í™”
if(thirdSleepStartBtn){
thirdSleepStartBtn.style.display = 'none';
thirdSleepStartBtn.disabled = true;
thirdSleepStartBtn.style.pointerEvents = 'none';
}
if(thirdSleepOffBtn){
thirdSleepOffBtn.style.display = 'none';
}
if(thirdSleepTimerEl){
thirdSleepTimerEl.style.display = 'none';
thirdSleepTimerEl.textContent = '30';
}
fadeShow(thirdSleepScreen, 1500, 'flex');
await sleep(200);
await typeThirdSleepText(); // ì—¬ê¸°ì„œ ë§ˆì§€ë§‰ì— START ë“±ì¥
}
/* ğŸ”´ THIRD SLEEP 30ì´ˆ íƒ€ì´ë¨¸ (HUD í‘œì‹œ) */
async function startThirdSleepTimer(){
if(thirdSleepTimerRunning) return;
thirdSleepTimerRunning = true;
stage = 'thirdTimer';
// START ë²„íŠ¼ì€ ì‚¬ë¼ì§
if(thirdSleepStartBtn){
thirdSleepStartBtn.disabled = true;
thirdSleepStartBtn.style.display = 'none';
thirdSleepStartBtn.style.pointerEvents = 'none';
}
// í…ìŠ¤íŠ¸ë¥¼ "SILENCE"ë¡œ ë°”ê¾¸ê³  í˜ì´ë“œ ì¸
if(thirdSleepText){
thirdSleepText.style.transition = 'opacity 500ms ease';
thirdSleepText.style.opacity = 0;
await nextFrame();
thirdSleepText.textContent = 'SILENCE';
typeTick();
thirdSleepText.style.opacity = 1;
}
if(thirdSleepTimerId){
clearInterval(thirdSleepTimerId);
thirdSleepTimerId = null;
}
let remain = 30;
if(thirdSleepTimerEl){
thirdSleepTimerEl.style.display = 'inline-block';
thirdSleepTimerEl.textContent = remain.toString().padStart(2,'0');
}
thirdSleepTimerId = setInterval(()=>{
remain--;
if(thirdSleepTimerEl){
thirdSleepTimerEl.textContent = remain.toString().padStart(2,'0');
}
if(remain <= 0){
clearInterval(thirdSleepTimerId);
thirdSleepTimerId = null;
thirdSleepTimerRunning = false;
// ğŸ”´ íƒ€ì´ë¨¸ ì¢…ë£Œ â†’ ì•ŒëŒ ë£¨í”„ ì‹œì‘ + OFF ì•ˆë‚´
if(thirdSleepTimerEl){
thirdSleepTimerEl.style.display = 'none';
}
if(thirdSleepText){
thirdSleepText.style.transition = 'opacity 500ms ease';
thirdSleepText.style.opacity = 0;
setTimeout(()=>{
thirdSleepText.textContent = 'OFF ë²„íŠ¼ì„ ëˆŒëŸ¬ ì•ŒëŒì„ ë„ì„¸ìš”.';
thirdSleepText.style.opacity = 1;
}, 520);
}
if(thirdSleepOffBtn){
thirdSleepOffBtn.style.display = 'inline-block';
}
startThirdAlarmLoop();
}
}, 1000);
}
// ğŸ”´ 3ì¥ START ë²„íŠ¼: í„°ì¹˜Â·í´ë¦­ ëª¨ë‘ ì•ˆì •ì ìœ¼ë¡œ ë°›ë„ë¡ ë³„ë„ í•¸ë“¤ëŸ¬
function handleThirdStart(e){
if(e && e.preventDefault) e.preventDefault();
if(thirdSleepTimerRunning) return;
claimImmersive();
ensureResumed().then(()=>{
playWoongClick();
startThirdSleepTimer();
});
}
if(thirdSleepStartBtn){
['click','touchstart','pointerdown'].forEach(ev=>{
// passive:falseë¥¼ ì‚¬ìš©í•˜ì—¬ preventDefaultê°€ ì‘ë™í•˜ë„ë¡ ë³´ì¥
thirdSleepStartBtn.addEventListener(ev, handleThirdStart, {passive:false});
});
}
if(thirdSleepOffBtn){
thirdSleepOffBtn.addEventListener('click', async (e)=>{
if(e && e.preventDefault) e.preventDefault();
claimImmersive();
await ensureResumed();
playWoongClick();
if(thirdSleepTimerId){
clearInterval(thirdSleepTimerId);
thirdSleepTimerId = null;
}
thirdSleepTimerRunning = false;
// ğŸ”´ ì•ŒëŒ ë„ê¸°
stopThirdAlarmLoop();
fadeHide(thirdSleepScreen, 1500);
await sleep(1600);
await showEndingSequence();
}, {passive:false});
}
/* ğŸ”´ 3ì¥ íƒ€ì´í‹€: 2ì¥ ê²Œì„ ëë‚˜ë©´ ì—¬ê¸°ë¡œ */
async function startThirdSleepTransitionFromGame(){
stopChapterTimer();
hideSecondGame();
stage = 'thirdTransition';
if (Ambient && Ambient.isRunning && Ambient.isRunning()){
Ambient.stop(3.0);
}
stopMicFXFadeOut(2.5);
stopLayerVideo();
if(presetHint) fadeHide(presetHint, FADE);
if(thirdTransition){
if(thirdSleepLine1) thirdSleepLine1.textContent = '';
if(thirdSleepLine2) thirdSleepLine2.textContent = '';
if(thirdSleepLine3) thirdSleepLine3.textContent = '';
if(thirdTitle) thirdTitle.textContent = '';
fadeShow(thirdTransition, FADE, 'flex');
await typeSleepLine(thirdSleepLine1, 'SLEEEEEEEEP,');
await sleep(400);
await typeSleepLine(thirdSleepLine2, 'SLEEEEEEEEP,');
await sleep(400);
await typeSleepLine(thirdTitle, 'THE THIRD SLEEP');
await sleep(1200);
await flashWhoom(2);
await sleep(1400);
fadeHide(thirdTransition, FADE);
await sleep(FADE + 100);
}
await showThirdSleepScreen();
}
/* ğŸ”´ iframe â†’ window.parent.goToThirdSleep() ë¸Œë¦¬ì§€ */
window.goToThirdSleep = async function(){
await startThirdSleepTransitionFromGame();
};
window.goToThirdSleepBridge = function(){
if(window.goToThirdSleep){
window.goToThirdSleep();
}
};
/* ğŸ”´ THE END ì±•í„° */
async function startTheEndChapter(){
stage = 'theEnd';
if (skipBtn) skipBtn.style.display = 'none';
if (returnBtn) returnBtn.style.display = 'block';
if(endSilence){
endSilence.textContent = '';
endSilence.style.opacity = 0;
}
if(endTheEnd){
endTheEnd.textContent = '';
endTheEnd.style.opacity = 0;
}
if(endReturn){
endReturn.innerHTML = '';
endReturn.style.opacity = 0;
}
fadeShow(endOverlay, 2000, 'flex');
await sleep(2200);
// ğŸ”´ SILENCE ì œê±°, ë°”ë¡œ THE ENDë§Œ ì¶œë ¥
await fadeInLine(endTheEnd, 'THE END');
const endHtml =
"ëª¨ë“  í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br/>" +
"í—¤ë“œí°ê³¼ íƒœë¸”ë¦¿ì„ ì§€ì •ëœ ìœ„ì¹˜ì— ë°˜ë‚©í•´ ì£¼ì„¸ìš”.<br/>" +
"í•¨ê»˜ ì ì†ì„ ê±¸ì–´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.<br/><br/>" +
"ë³¸ ì‘í’ˆì€ ì¡°ìœ¤ìƒì˜ ì·¨ì¬ ìë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ê¿ˆì† ì„¸ê³„ì—ì„œ â€˜ê·¸ê²ƒâ€™ìœ¼ë¡œ ì „ë½í•œ â€˜ë„ˆâ€™ë¥¼ ì°¾ì•„ê°€ëŠ” ê°•í•˜ì •ì˜ ìŠ¤í† ë¦¬í…”ë§ì„ ì¤‘ì‹¬ì— ë‘”ë‹¤. " +
"ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì†í¬ë²”ì´ ì „ì²´ ê³µê°„ì˜ ì½˜ì…‰íŠ¸ì™€ êµ¬ì„±ì„ ì„¤ê³„í•˜ê³ , " +
"ê°•ëŒ€ê²½Â·ê¹€ì±„ìš´Â·ê¹€ì§„ì„ Â·ì •ë¯¼ì¬ê°€ ê·¸ êµ¬ì„±ì„ êµ¬í˜„í•˜ê¸° ìœ„í•œ ê¸°ìˆ ì  ì‹œìŠ¤í…œ êµ¬ì¡°ë¥¼ êµ¬ì¶•í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì‘ì—…ì´ ì§„í–‰ë˜ì—ˆë‹¤.";
await fadeInLine(endReturn, endHtml, true);
}
async function showEndingSequence(){
claimImmersive();
await ensureResumed();
hideSecondGame();
if (Ambient && Ambient.isRunning && Ambient.isRunning()){
Ambient.stop(5.0);
}
stopMicFXFadeOut(2.5);
stopLayerVideo();
endSilence.textContent = '';
endTheEnd.textContent = '';
if(endReturn) endReturn.innerHTML = '';
await startTheEndChapter();
}
/* ===== ë§ˆì´í¬ ë¦¬ë²„ë¸Œ ===== */
let micStream=null, micSrc=null, panNode=null, lpf=null, lowshelf=null, highshelf=null, revConvolver=null, dryGain=null, wetGain=null, micPreGain=null;
function makeImpulse(ctx, seconds=6.0, decay=8.0){
const rate=ctx.sampleRate;
const len=rate*seconds;
const ir=ctx.createBuffer(2, len, rate);
for(let ch=0; ch<2; ch++){
const data=ir.getChannelData(ch);
for(let i=0;i<len;i++){
const t=i/len;
data[i]=(Math.random()*2-1)*Math.pow(1-t,decay);
}
}
return ir;
}
async function startMicFXFadeIn(fadeSec=2.5){
try{
await ensureResumed();
if(!micStream){
micStream = await navigator.mediaDevices.getUserMedia({
audio:{echoCancellation:true, noiseSuppression:true, autoGainControl:false},
video:false
});
}
if(!micSrc){
micSrc = audioCtx.createMediaStreamSource(micStream);
}
micPreGain = audioCtx.createGain();
micPreGain.gain.value = 1.4;
lowshelf = audioCtx.createBiquadFilter();
highshelf = audioCtx.createBiquadFilter();
lpf = audioCtx.createBiquadFilter();
panNode = audioCtx.createStereoPanner();
lpf.type='lowpass';
lpf.frequency.value=2800;
lpf.Q.value=0.3;
lowshelf.type='lowshelf';
lowshelf.frequency.value=350;
lowshelf.gain.value=0;
highshelf.type='highshelf';
highshelf.frequency.value=3500;
highshelf.gain.value=0;
revConvolver = audioCtx.createConvolver();
revConvolver.buffer = makeImpulse(audioCtx, 8.0, 10.0);
dryGain = audioCtx.createGain();
wetGain = audioCtx.createGain();
dryGain.gain.value = 0.0;
wetGain.gain.value = 0.0;
const out = audioCtx.createGain();
out.gain.value = 1.4;
micSrc.connect(micPreGain);
micPreGain.connect(lowshelf)
.connect(highshelf)
.connect(lpf)
.connect(panNode);
panNode.connect(dryGain);
panNode.connect(revConvolver);
revConvolver.connect(wetGain);
dryGain.connect(out);
wetGain.connect(out);
out.connect(audioCtx.destination);
window.addEventListener('deviceorientation', onTiltAudio, {passive:true});
const t = audioCtx.currentTime;
dryGain.gain.linearRampToValueAtTime(1.0, t+fadeSec);
wetGain.gain.linearRampToValueAtTime(1.0, t+fadeSec);
}catch(e){
console.warn('startMicFX error', e);
}
}
function stopMicFXFadeOut(sec=2.5){
try{
if(!audioCtx) return;
const t=audioCtx.currentTime;
if(dryGain) dryGain.gain.linearRampToValueAtTime(0.0001, t+sec);
if(wetGain) wetGain.gain.linearRampToValueAtTime(0.0001, t+sec);
if(micPreGain) micPreGain.gain.linearRampToValueAtTime(0.0001, t+sec);
setTimeout(()=>{
try{
if(micStream){
micStream.getTracks().forEach(tr=>tr.stop());
}
}catch(e){}
micStream=null;
micSrc=null;
panNode=null;
lpf=null;
lowshelf=null;
highshelf=null;
revConvolver=null;
dryGain=null;
wetGain=null;
micPreGain=null;
window.removeEventListener('deviceorientation', onTiltAudio);
}, sec*1000+200);
}catch(e){}
}
function onTiltAudio(e){
if(!audioCtx || !panNode) return;
const gamma = clamp(e.gamma ?? 0, -90, 90);
panNode.pan.value = gamma / 90;
const beta = clamp(e.beta ?? 0, -90, 90);
if(lowshelf) {
lowshelf.gain.value = (beta < 0) ? (beta / 90) * 10 : 0;
}
if(highshelf) {
highshelf.gain.value = (beta > 0) ? (beta / 90) * 10 : 0;
}
if(lpf) {
let cutoff;
if(beta >= 0) {
cutoff = 2800 + (beta / 90) * (4500 - 2800);
} else {
cutoff = 2800 + (beta / 90) * (2800 - 900);
}
lpf.frequency.value = clamp(cutoff, 900, 4500);
lpf.Q.value = 0.2 + (Math.abs(beta) / 90) * 0.3;
}
if(wetGain && dryGain) {
const tilt = Math.abs(beta) / 90;
const wetBase = 0.42;
const wetAmount = wetBase + tilt * 0.25;
wetGain.gain.value = clamp(wetAmount, 0.35, 0.67);
dryGain.gain.value = clamp(1.0 - wetGain.gain.value * 0.5, 0.5, 0.85);
}
}
function startCameraFresh(warmupOnly=false){
navigator.mediaDevices.getUserMedia({
video:{
facingMode:{ideal:'environment'},
width:{min:1280,ideal:1920},
height:{min:720,ideal:1080},
aspectRatio:{ideal:16/9}
},
audio:false
})
.then(async s=>{
camStream = s;
if(!camVideo){
camVideo=document.createElement('video');
camVideo.setAttribute('playsinline','');
camVideo.autoplay=true;
camVideo.playsInline=true;
camVideo.muted=true;
}
camVideo.srcObject=camStream;
await camVideo.play().catch(()=>{});
if (camVideo.readyState < 1){
await new Promise(res=>camVideo.addEventListener('loadedmetadata', res, {once:true}));
}
resizeAll();
warmupFrames=0;
if(!vctx){
vctx=view.getContext('2d',{alpha:false});
}
if(!fgctx){
fgctx=fg.getContext('2d',{alpha:true});
}
document.querySelectorAll('.uiBtn').forEach(b=>{
b.addEventListener('click', ()=>{
primeAudio();
}, {passive:true});
});
})
.catch(e=>{
console.warn('startCameraFresh error:', e);
});
}
function resizeAll(){
const dpr=window.devicePixelRatio||1;
const w=window.innerWidth;
const h=window.innerHeight;
view.width=w*dpr;
view.height=h*dpr;
if(vctx) vctx.setTransform(dpr,0,0,dpr,0,0);
fg.width=w*dpr;
fg.height=h*dpr;
if(fgctx) fgctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', resizeAll, {passive:true});
window.addEventListener('orientationchange', resizeAll, {passive:true});
resizeAll();
/* ===== ì¹´ë©”ë¼ í˜ì´ë“œ ì¸/ì•„ì›ƒ ===== */
function fadeInCamera(dur=2000){
showCamera = true;
const start = performance.now();
camFadeAlpha = 0;
function step(){
const t = (performance.now() - start) / dur;
camFadeAlpha = clamp(t, 0, 1);
if(t < 1 && showCamera){
requestAnimationFrame(step);
}
}
requestAnimationFrame(step);
}
function fadeOutCamera(dur=2000){
const startAlpha = camFadeAlpha;
const start = performance.now();
function step(){
const t = (performance.now() - start) / dur;
camFadeAlpha = startAlpha * (1 - clamp(t,0,1));
if(t < 1){
requestAnimationFrame(step);
}else{
camFadeAlpha = 0;
showCamera = false;
}
}
requestAnimationFrame(step);
}
/* ===== ë ˆì´ì–´ ë¹„ë””ì˜¤ ì¬ìƒ/ì •ì§€ ===== */
function startLayerVideo(){
if(!layerVideo) return;
try{
layerVideo.currentTime = 0;
layerVideo.loop = true;
layerVideo.play().catch(()=>{});
}catch(e){
console.warn('layerVideo play error', e);
}
}
function stopLayerVideo(){
if(!layerVideo) return;
try{
layerVideo.pause();
}catch(e){}
}
/* ===== ë©”ì¸ ë Œë”ë§ ë£¨í”„ ===== */
const rabbits = [
{offset:0.0},
{offset:0.35},
{offset:0.7}
];
function drawCameraAndLayer(){
if(!vctx) return;
const w = view.clientWidth || window.innerWidth;
const h = view.clientHeight || window.innerHeight;
vctx.clearRect(0,0,w,h);
// ë°°ê²½ ê²€ì •
vctx.save();
vctx.globalAlpha = 1;
vctx.fillStyle = '#000';
vctx.fillRect(0,0,w,h);
vctx.restore();
// ì¹´ë©”ë¼ - ì „ì²´ í™”ë©´ ì±„ìš°ê¸° ë¡œì§ (cover)
if(showCamera && camVideo && camVideo.readyState >= 2){
const vw = camVideo.videoWidth;
const vh = camVideo.videoHeight;
if(vw && vh){
const fw = w; // ìº”ë²„ìŠ¤ ë„ˆë¹„
const fh = h; // ìº”ë²„ìŠ¤ ë†’ì´
const videoRatio = vw / vh;
const frameRatio = fw / fh;
let dw, dh;
// ì „ì²´ í™”ë©´ì„ ì»¤ë²„í•˜ë„ë¡ (contain ëŒ€ì‹  cover)
if(videoRatio > frameRatio){
// ë¹„ë””ì˜¤ê°€ ë” ë„“ë‹¤: ë†’ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë§ì¶”ê³  ë„ˆë¹„ëŠ” ì˜ë¦¼
dh = fh;
dw = dh * videoRatio;
}else{
// ìº”ë²„ìŠ¤ê°€ ë” ë„“ë‹¤: ë„ˆë¹„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë§ì¶”ê³  ë†’ì´ëŠ” ì˜ë¦¼
dw = fw;
dh = dw / videoRatio;
}
dw *= ZOOM;
dh *= ZOOM;
// ì¤‘ì•™ ì •ë ¬
const dx = (fw - dw)/2;
const dy = (fh - dh)/2;
vctx.save();
vctx.globalAlpha = camFadeAlpha;
// ìº¡ì²˜ì™€ ë™ì¼í•˜ê²Œ x, y, w, h ì¸ìë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬
vctx.drawImage(camVideo, dx,dy,dw,dh);
vctx.restore();
}
}
// ë ˆì´ì–´ ë¹„ë””ì˜¤ (screen ëŠë‚Œìœ¼ë¡œ ì„ê¸°)
if(layerVideo && !layerVideo.paused && layerVideo.readyState >= 2){
const vw = layerVideo.videoWidth;
const vh = layerVideo.videoHeight;
if(vw && vh){
const frame = getFrameRect();
const fw = frame.w;
const fh = frame.h;
const videoRatio = vw / vh;
const frameRatio = fw / fh;
let dw, dh;
if(videoRatio > frameRatio){
dh = fh;
dw = dh * videoRatio;
}else{
dw = fw;
dh = dw / videoRatio;
}
const dx = frame.x + (fw - dw)/2;
const dy = frame.y + (fh - dh)/2;
vctx.save();
vctx.globalAlpha = 0.35;
vctx.globalCompositeOperation = 'screen';
vctx.drawImage(layerVideo, 0,0,vw,vh, dx,dy,dw,dh);
vctx.restore();
}
}
}
function drawFG(){
if(!fgctx) return;
const w = fg.clientWidth || window.innerWidth;
const h = fg.clientHeight || window.innerHeight;
fgctx.clearRect(0,0,w,h);
if(!showIntroLayer || !introWalking) return;
const now = performance.now();
const baseT = (now - introStartTime) / 8000;
fgctx.save();
fgctx.globalAlpha = fgAlpha;
rabbits.forEach((r, idx)=>{
const t01 = baseT + r.offset;
const pos = prosceniumWalkPos(t01);
const size = Math.min(w,h) * 0.05;
const scale = size / 8;
drawRedRabbit(
fgctx,
pos.x - size * 0.5,
pos.y - size * 0.5,
scale
);
});
fgctx.restore();
}
function renderLoop(){
if(!animStarted){
animStarted = true;
}
drawCameraAndLayer();
drawFG();
requestAnimationFrame(renderLoop);
}
requestAnimationFrame(renderLoop);
/* ===== ìº¡ì²˜ ì²˜ë¦¬ ===== */
async function captureCurrentView(){
if(capturing) return;
capturing = true;
try{
setSleepPhotoStatus('ìº¡ì²˜ ì¤‘ì…ë‹ˆë‹¤...');
// view ìº”ë²„ìŠ¤ì˜ ì‹¤ì œ í”½ì…€ í¬ê¸°ë¥¼ ê°€ì ¸ì˜´
const w = view.width;
const h = view.height;
// freezeLayer ìº”ë²„ìŠ¤ëŠ” view ìº”ë²„ìŠ¤ì™€ ë™ì¼í•œ í¬ê¸°ë¡œ ì„¤ì • (í”½ì…€ í¬ê¸°)
freezeLayer.width = w;
freezeLayer.height = h;
const ctx = freezeLayer.getContext('2d');
// ìº¡ì²˜ ë¡œì§: view ìº”ë²„ìŠ¤ ì „ì²´ ë‚´ìš©ì„ freezeLayerì— ë³µì‚¬
ctx.setTransform(1,0,0,1,0,0);
ctx.clearRect(0,0,w,h);
ctx.drawImage(view, 0,0, w, h);

// ğŸ”´ í”Œë˜ì‹œ íš¨ê³¼ ë° freezeLayer í‘œì‹œ ë¡œì§ ì œê±° (ìš”ì²­ ì‚¬í•­ ë°˜ì˜)
// if(flashLayer){ ... }
// freezeLayer.style.display = 'block';

await uploadSnapshotCanvas(freezeLayer);
}catch(e){
console.error('capture error', e);
setSleepPhotoStatus('ìº¡ì²˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
setTimeout(()=>setSleepPhotoStatus(''), 6000);
}finally{
freezeLayer.style.display = 'none';
capturing = false;
}
}
if(captureBtn){
captureBtn.addEventListener('click', async (e)=>{
e.preventDefault();
claimImmersive();
await ensureResumed();
playWoongClick();
captureCurrentView();
}, {passive:false});
}
/* ===== ëª©ì°¨ ë©”ë‰´ ===== */
function openNavOverlay(){
if(!navOverlay) return;
navOverlay.style.display = 'flex';
navOverlay.style.opacity = '0';
navOverlay.style.transition = `opacity ${FADE}ms ease`;
requestAnimationFrame(()=> navOverlay.style.opacity = '1');
}
function closeNavOverlay(){
if(!navOverlay) return;
navOverlay.style.transition = `opacity ${FADE}ms ease`;
navOverlay.style.opacity = '0';
setTimeout(()=>{ navOverlay.style.display = 'none'; }, FADE);
}
function jumpToChapter(target){
switch(target){
case 'name':
fadeShow(nameOverlay, FADE);
stage = 'name';
break;
case 'preset':
showPreset(true);
stage = 'preset';
break;
case 'welcome':
fadeShow(welcome, FADE);
stage = 'welcome';
break;
case 'intro':
showIntroTitleThenIntro();
break;
case 'first':
startFirstSleepTransition();
break;
case 'second':
stage = 'second';
showSecondGame();
break;
case 'third':
startThirdSleepTransitionFromGame();
break;
case 'end':
showEndingSequence();
break;
case 'close':
default:
break;
}
}
if(menuBtn){
['click','touchstart','pointerdown'].forEach(ev=>{
menuBtn.addEventListener(ev, (e)=>{
e.preventDefault();
playWoongClick();
openNavOverlay();
}, {passive:false});
});
}
if(navOverlay){
navOverlay.addEventListener('click', (e)=>{
const btn = e.target.closest('button');
if(!btn) return;
const target = btn.dataset.target;
if(!target) return;
playWoongClick();
closeNavOverlay();
if(target !== 'close'){
setTimeout(()=> jumpToChapter(target), FADE + 80);
}
});
}
/* RETURN ë²„íŠ¼ â†’ ëª©ì°¨ ì—´ê¸° */
if(returnBtn){
['click','touchstart','pointerdown'].forEach(ev=>{
returnBtn.addEventListener(ev, (e)=>{
e.preventDefault();
playWoongClick();
openNavOverlay();
}, {passive:false});
});
}
/* ===== ì´ˆê¸° ì„¤ì • ===== */
// ì´ˆê¸°ì—ëŠ” ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì€ PRESETì—ì„œ warmup
// ì˜¤ë²„ë ˆì´ íšŒì „ ì•ˆë‚´ëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì„¤ì •ë¨
})();
</script>
</body>
</html>

ì´ ì½”ë“œì—ì„œ ë‹¤ë¥¸ê±´ ì§€ìš°ê³  1ì¥ì˜ UIì™€ ì—…ë¡œë“œ ì‹œìŠ¤í…œë§Œ ë‚¨ê²¨ì¤˜.
