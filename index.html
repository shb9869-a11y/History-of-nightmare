<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LIMEN â€“ iPhone Camera Boxes + Audio Lines (FIXED)</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden;touch-action:none;}
  /* âœ… ì¹´ë©”ë¼ë¥¼ í™•ì‹¤íˆ â€œë³´ì´ê²Œâ€ + ë°ê¸°/ëŒ€ë¹„ ìŠ¬ë¼ì´ë”ë¡œ ì¡°ì ˆ */
  #camVideo{
    position:fixed; inset:0;
    width:100vw; height:100vh;
    object-fit:cover;
    pointer-events:none;
    z-index:1;
    /* ê¸°ë³¸ê°’: ë„ˆë¬´ ì–´ë‘ìš°ë©´ ì—¬ê¸°ì„œë„ ì‚´ë¦´ ìˆ˜ ìˆìŒ */
    filter: brightness(1.15) contrast(1.05) saturate(1.05);
  }
  canvas{
    position:fixed; inset:0;
    width:100vw; height:100vh;
    z-index:2;
  }

  /* Entry */
  #hint{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.72);
    color:#ddd; font-family:system-ui, -apple-system, sans-serif;
    padding:20px;
    z-index:50;
  }
  #hint .box{
    width:min(820px, 94vw);
    border:1px solid rgba(255,255,255,.12);
    border-radius:14px;
    padding:18px 16px;
    background:rgba(0,0,0,.55);
    text-align:left;
  }
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0;}
  .label{font-size:12px; color:#aaa; width:120px;}
  .grow{flex:1; min-width:220px;}
  .small{font-size:11px; color:#9aa; line-height:1.45;}

  button, select, input[type="range"], input[type="file"]{
    background:#0f0f0f; color:#eee;
    border:1px solid rgba(255,255,255,.16);
    border-radius:10px;
    padding:10px 12px;
    font-weight:650;
    outline:none;
  }
  button:hover, select:hover{border-color:rgba(255,255,255,.32)}
  button:disabled, select:disabled{opacity:.5; cursor:not-allowed}

  #top{
    position:fixed; left:12px; top:12px;
    display:flex; gap:8px; flex-wrap:wrap;
    z-index:40;
  }
  .pill{
    font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
    font-size:11px; color:#bbb;
    padding:8px 10px;
    border:1px solid rgba(255,255,255,.12);
    border-radius:999px;
    background:rgba(0,0,0,.28);
    backdrop-filter: blur(10px);
    max-width:min(92vw, 780px);
    white-space:pre-wrap;
  }
  .btn{
    height:38px;
    display:inline-flex; align-items:center; gap:8px;
    background:rgba(0,0,0,.38);
    color:#eee;
    border:1px solid rgba(255,255,255,.14);
    border-radius:12px;
    backdrop-filter: blur(10px);
    cursor:pointer;
    user-select:none;
    padding:0 12px;
    font-size:13px;
  }
  .btn:active{transform:translateY(1px)}

  #hud{
    position:fixed; left:12px; bottom:12px;
    z-index:40;
    color:#ddd;
    font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
    font-size:11px;
    background:rgba(0,0,0,.28);
    border:1px solid rgba(255,255,255,.10);
    border-radius:12px;
    padding:8px 10px;
    backdrop-filter: blur(10px);
    pointer-events:none;
    max-width:min(92vw, 760px);
    white-space:pre-wrap;
  }
</style>
</head>
<body>

<video id="camVideo" playsinline autoplay muted></video>
<canvas id="c"></canvas>

<div id="hint">
  <div class="box">
    <div style="font-weight:900;font-size:16px;margin-bottom:10px;">LIMEN â€“ iPhone FIXED (Camera + Boxes + Lines)</div>
    <div class="small" style="margin-bottom:12px;">
      âœ… ë°˜ë“œì‹œ <b>HTTPS</b>ì—ì„œ ì—´ê¸° (GitHub Pages OK)<br/>
      âœ… ìˆœì„œ: <b>Start Audio</b> â†’ <b>Start Camera</b> â†’ <b>Live Detect ON</b><br/>
      âœ… iPhoneì—ì„œ ë°•ìŠ¤ ì•ˆ ëœ¨ë©´: <b>DetectW 240</b> + <b>Score 0.25</b>ë¡œ ë‚®ì¶”ê¸°
    </div>

    <div class="row">
      <button id="btnStartAudio">Start Audio</button>
      <button id="btnStartCam" disabled>Start Camera</button>
      <button id="btnEnter" disabled>Enter (Hide Entry)</button>
      <button id="btnFS">Fullscreen</button>
    </div>

    <div class="row">
      <div class="label">Audio input</div>
      <select id="selAudioSrc" class="grow">
        <option value="mic" selected>Mic (Live)</option>
        <option value="file">File (MP3/WAV)</option>
      </select>
    </div>

    <div class="row" id="rowMic">
      <div class="label">Mic device</div>
      <select id="selMic" class="grow" disabled><option>Start Audio í›„ ë¡œë“œ</option></select>
    </div>

    <div class="row" id="rowFile" style="display:none;">
      <div class="label">Audio file</div>
      <input id="fileAudio" class="grow" type="file" accept="audio/*">
    </div>

    <div class="row">
      <div class="label">Live detect</div>
      <button id="btnLive" disabled>Live Detect: OFF</button>
      <button id="btnCapture" disabled>ğŸ“¸ Capture+Detect</button>
      <button id="btnClear" disabled>Clear Boxes</button>
    </div>

    <div class="row">
      <div class="label">DetectW</div>
      <div class="grow">
        <input id="rngDetectW" type="range" min="200" max="420" step="10" value="240" style="width:100%;">
        <div class="small" id="txtDetectW">detect width: 240px (ì•„ì´í° ì¶”ì²œ)</div>
      </div>
    </div>

    <div class="row">
      <div class="label">Score Th</div>
      <div class="grow">
        <input id="rngScore" type="range" min="0.10" max="0.70" step="0.01" value="0.25" style="width:100%;">
        <div class="small" id="txtScore">score threshold: 0.25</div>
      </div>
    </div>

    <div class="row">
      <div class="label">Cam Bright</div>
      <div class="grow">
        <input id="rngBright" type="range" min="0.70" max="2.20" step="0.01" value="1.15" style="width:100%;">
        <div class="small" id="txtBright">brightness: 1.15</div>
      </div>
    </div>

    <div class="row">
      <div class="label">Cam Contrast</div>
      <div class="grow">
        <input id="rngContrast" type="range" min="0.70" max="1.80" step="0.01" value="1.05" style="width:100%;">
        <div class="small" id="txtContrast">contrast: 1.05</div>
      </div>
    </div>

    <div class="row">
      <div class="label">Line Sens</div>
      <div class="grow">
        <input id="rngLineSens" type="range" min="0.6" max="3.0" step="0.01" value="1.55" style="width:100%;">
        <div class="small" id="txtLineSens">line sens: 1.55Ã—</div>
      </div>
    </div>

    <div class="row">
      <div class="label">Amp Sens</div>
      <div class="grow">
        <input id="rngAmpSens" type="range" min="1" max="12" step="0.1" value="7.0" style="width:100%;">
        <div class="small" id="txtAmpSens">amp sens: 7.0Ã—</div>
      </div>
    </div>

    <div class="small" id="status">ëŒ€ê¸° ì¤‘â€¦</div>
  </div>
</div>

<div id="top">
  <div class="btn" id="btnMute">ğŸ”ˆ Mute</div>
  <div class="btn" id="btnReset">âŸ² RESET</div>
  <div class="pill" id="pill">audio:off | cam:off | model:loading | boxes:0 | amp:0.000</div>
</div>

<div id="hud">hudâ€¦</div>

<!-- TFJS + COCO-SSD -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>

<script>
/* ==========================================================
   CANVAS / DPR
========================================================== */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d', { alpha:true });

let W=0,H=0,DPR=1;
function resize(){
  DPR = Math.max(1, Math.min(2, devicePixelRatio||1));
  W = innerWidth|0; H = innerHeight|0;
  canvas.width  = (W*DPR)|0;
  canvas.height = (H*DPR)|0;
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize', resize);
resize();

/* ==========================================================
   UI
========================================================== */
const statusEl = document.getElementById('status');
const pillEl = document.getElementById('pill');
const hudEl = document.getElementById('hud');

const btnStartAudio = document.getElementById('btnStartAudio');
const btnStartCam   = document.getElementById('btnStartCam');
const btnEnter      = document.getElementById('btnEnter');
const btnFS         = document.getElementById('btnFS');

const selAudioSrc = document.getElementById('selAudioSrc');
const rowMic = document.getElementById('rowMic');
const rowFile = document.getElementById('rowFile');
const selMic = document.getElementById('selMic');
const fileAudioInp = document.getElementById('fileAudio');

const btnLive = document.getElementById('btnLive');
const btnCapture = document.getElementById('btnCapture');
const btnClear = document.getElementById('btnClear');
const btnMute = document.getElementById('btnMute');
const btnReset = document.getElementById('btnReset');

const camVideo = document.getElementById('camVideo');

const rngDetectW = document.getElementById('rngDetectW');
const txtDetectW = document.getElementById('txtDetectW');

const rngScore = document.getElementById('rngScore');
const txtScore = document.getElementById('txtScore');

const rngBright = document.getElementById('rngBright');
const txtBright = document.getElementById('txtBright');
const rngContrast = document.getElementById('rngContrast');
const txtContrast = document.getElementById('txtContrast');

const rngLineSens = document.getElementById('rngLineSens');
const txtLineSens = document.getElementById('txtLineSens');

const rngAmpSens = document.getElementById('rngAmpSens');
const txtAmpSens = document.getElementById('txtAmpSens');

function setStatus(t){ statusEl.textContent = t; }

function toggleFullscreen(){
  const el = document.documentElement;
  if(!document.fullscreenElement) el.requestFullscreen?.();
  else document.exitFullscreen?.();
}
btnFS.addEventListener('click', toggleFullscreen);

function applyAudioUI(){
  const v = selAudioSrc.value;
  rowMic.style.display = (v==="mic") ? "" : "none";
  rowFile.style.display = (v==="file") ? "" : "none";
}
selAudioSrc.addEventListener('change', applyAudioUI);
applyAudioUI();

function getDetectW(){ return Math.max(200, Math.min(420, parseInt(rngDetectW.value,10)||240)); }
function getScoreTh(){ return Math.max(0.10, Math.min(0.70, parseFloat(rngScore.value)||0.25)); }
function getLineSens(){ return Math.max(0.6, Math.min(3.0, parseFloat(rngLineSens.value)||1.55)); }
function getAmpSens(){ return Math.max(1, Math.min(12, parseFloat(rngAmpSens.value)||7)); }

function updateCamFilter(){
  const b = Math.max(0.7, Math.min(2.2, parseFloat(rngBright.value)||1.15));
  const c = Math.max(0.7, Math.min(1.8, parseFloat(rngContrast.value)||1.05));
  camVideo.style.filter = `brightness(${b}) contrast(${c}) saturate(1.05)`;
  txtBright.textContent = `brightness: ${b.toFixed(2)}`;
  txtContrast.textContent = `contrast: ${c.toFixed(2)}`;
}
rngBright.addEventListener('input', updateCamFilter);
rngContrast.addEventListener('input', updateCamFilter);
updateCamFilter();

rngDetectW.addEventListener('input', ()=>{ txtDetectW.textContent = `detect width: ${getDetectW()}px (ì•„ì´í° ì¶”ì²œ)`; });
rngScore.addEventListener('input', ()=>{ txtScore.textContent = `score threshold: ${getScoreTh().toFixed(2)}`; });
rngLineSens.addEventListener('input', ()=>{ txtLineSens.textContent = `line sens: ${getLineSens().toFixed(2)}Ã—`; });
rngAmpSens.addEventListener('input', ()=>{ txtAmpSens.textContent = `amp sens: ${getAmpSens().toFixed(1)}Ã—`; });

/* ==========================================================
   AUDIO â†’ amp
========================================================== */
let audioCtx=null, analyser=null, timeData=null;
let masterGain=null, preGain=null;
let micStream=null, micNode=null;
let fileEl=null, fileNode=null;
let isMuted=false;

let amp=0, ampSmooth=0;

function ensureAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  timeData = new Uint8Array(analyser.fftSize);

  masterGain = audioCtx.createGain();
  masterGain.gain.value = 0.9;

  preGain = audioCtx.createGain();
  preGain.gain.value = 1.0;

  preGain.connect(analyser);
  analyser.connect(masterGain);
  masterGain.connect(audioCtx.destination);
}

function updateAmp(){
  if(!analyser) { amp=0; return; }
  analyser.getByteTimeDomainData(timeData);
  let sum=0;
  for(let i=0;i<timeData.length;i++){
    const v=(timeData[i]-128)/128;
    sum+=v*v;
  }
  const rms=Math.sqrt(sum/timeData.length);
  const boosted = Math.min(1, Math.pow(Math.max(0, rms * getAmpSens()), 0.85));
  ampSmooth += (boosted - ampSmooth) * 0.15;
  amp = ampSmooth;
}

async function listMics(){
  let devices=[];
  try{ devices = await navigator.mediaDevices.enumerateDevices(); }catch(e){}
  const mics = devices.filter(d=>d.kind==="audioinput");
  selMic.innerHTML="";
  if(!mics.length){
    selMic.disabled=true;
    selMic.innerHTML = "<option>ë§ˆì´í¬ ì—†ìŒ</option>";
    return;
  }
  selMic.disabled=false;
  for(const d of mics){
    const opt=document.createElement('option');
    opt.value=d.deviceId;
    opt.textContent=d.label || `Mic (${d.deviceId.slice(0,6)}â€¦)`;
    selMic.appendChild(opt);
  }
}

function stopMic(){
  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
  if(micNode){ try{ micNode.disconnect(); }catch(e){} micNode=null; }
}
function stopFile(){
  if(fileEl){ try{ fileEl.pause(); }catch(e){} }
  if(fileNode){ try{ fileNode.disconnect(); }catch(e){} fileNode=null; }
}

async function startMic(deviceId){
  ensureAudio();
  await audioCtx.resume();
  stopFile();
  stopMic();
  micStream = await navigator.mediaDevices.getUserMedia({
    audio:{
      deviceId: deviceId ? { exact: deviceId } : undefined,
      echoCancellation:false,
      noiseSuppression:false,
      autoGainControl:false
    }
  });
  micNode = audioCtx.createMediaStreamSource(micStream);
  micNode.connect(preGain);
}

function ensureFileEl(){
  if(fileEl) return;
  fileEl = new Audio();
  fileEl.loop = true;
  fileEl.playsInline = true;
  fileEl.crossOrigin = "anonymous";
}
async function loadFile(file){
  ensureAudio();
  await audioCtx.resume();
  stopMic();
  ensureFileEl();
  const url = URL.createObjectURL(file);
  fileEl.src = url;

  if(fileNode){ try{ fileNode.disconnect(); }catch(e){} fileNode=null; }
  fileNode = audioCtx.createMediaElementSource(fileEl);
  fileNode.connect(preGain);

  try{ await fileEl.play(); }catch(e){
    setStatus("íŒŒì¼ ì¬ìƒì´ ë§‰í˜: í™”ë©´ í•œë²ˆ í„°ì¹˜ í›„ ë‹¤ì‹œ");
  }
}

/* ==========================================================
   CAMERA
========================================================== */
let camOn=false;
async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{
      facingMode:{ ideal:"environment" },
      width:{ ideal:1280 },
      height:{ ideal:720 }
    },
    audio:false
  });
  camVideo.srcObject = stream;
  await camVideo.play();
  camOn=true;
}

/* ==========================================================
   DETECTION (COCO-SSD)
========================================================== */
let model=null;
let modelReady=false;

const capCanvas = document.createElement('canvas');
const capCtx = capCanvas.getContext('2d', { willReadFrequently:true });

let liveOn=false;
let liveTimer=null;

let nodes=[]; // {bx,by,bw,bh,x,y,vx,vy,cls,score,seed}

async function loadModel(){
  try{
    // iPhone ì•ˆì •: CPU backend
    await tf.setBackend('cpu');
    await tf.ready();
    model = await cocoSsd.load({ base:'lite_mobilenet_v2' });
    modelReady=true;
    setStatus("ëª¨ë¸ ë¡œë“œ ì™„ë£Œ. Start Camera â†’ Live Detect ON");
  }catch(e){
    console.error(e);
    setStatus("ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨. HTTPS/ë„¤íŠ¸ì›Œí¬ í™•ì¸");
  }
}

async function captureFrame(){
  if(!camOn || !camVideo.videoWidth) return false;

  const dw = getDetectW();
  const vw = camVideo.videoWidth;
  const vh = camVideo.videoHeight;
  const dh = Math.round(dw * (vh/vw));

  capCanvas.width = dw;
  capCanvas.height = dh;
  capCtx.drawImage(camVideo, 0, 0, dw, dh);
  return true;
}

function detectionsToNodes(dets){
  const dw = capCanvas.width, dh = capCanvas.height;
  const sx = W / dw, sy = H / dh;
  const th = getScoreTh();

  const filtered = dets
    .filter(d => (d.score ?? 0) >= th)
    .slice(0, 18);

  const newNodes = [];
  for(const d of filtered){
    const [x,y,w,h] = d.bbox;
    const bx = x*sx, by = y*sy, bw = w*sx, bh = h*sy;
    const cx = bx + bw*0.5;
    const cy = by + bh*0.5;
    newNodes.push({
      cls:d.class, score:d.score,
      bx,by,bw,bh,
      x:cx, y:cy,
      vx:0, vy:0,
      seed: Math.random()*9999
    });
  }

  // ê°„ë‹¨ íŠ¸ë˜í‚¹: class ê°™ê³  ê°€ê¹Œìš°ë©´ ì†ë„/seed ìœ ì§€
  for(const nn of newNodes){
    let best=null, bestD=1e9;
    for(const on of nodes){
      if(on.cls !== nn.cls) continue;
      const dx=on.x-nn.x, dy=on.y-nn.y;
      const d=dx*dx+dy*dy;
      if(d<bestD){ bestD=d; best=on; }
    }
    if(best && bestD < (140*140)){
      nn.x = best.x*0.65 + nn.x*0.35;
      nn.y = best.y*0.65 + nn.y*0.35;
      nn.vx = best.vx*0.7;
      nn.vy = best.vy*0.7;
      nn.seed = best.seed;
    }
  }
  nodes = newNodes;
}

async function runDetect(){
  if(!modelReady || !model) return;
  const dets = await model.detect(capCanvas);
  detectionsToNodes(dets);
}

async function captureAndDetect(){
  if(!camOn){ setStatus("ì¹´ë©”ë¼ OFF"); return; }
  if(!modelReady){ setStatus("ëª¨ë¸ ë¡œë”© ì¤‘â€¦"); return; }
  const ok = await captureFrame();
  if(!ok){ setStatus("ìº¡ì²˜ ì‹¤íŒ¨(ë¹„ë””ì˜¤ ì¤€ë¹„ ì•ˆë¨)"); return; }
  await runDetect();
}

function setLive(on){
  liveOn = on;
  btnLive.textContent = `Live Detect: ${on ? "ON" : "OFF"}`;
  if(liveTimer){ clearInterval(liveTimer); liveTimer=null; }
  if(on){
    // iPhone ì•ˆì „: 900ms
    liveTimer = setInterval(async ()=>{
      if(!camOn || !modelReady) return;
      try{
        const ok = await captureFrame();
        if(!ok) return;
        await runDetect();
      }catch(e){ console.warn(e); }
    }, 900);
  }
}

/* ==========================================================
   BUTTON WIRING
========================================================== */
btnMute.addEventListener('click', ()=>{
  if(!audioCtx) return;
  isMuted = !isMuted;
  masterGain.gain.setTargetAtTime(isMuted?0:0.9, audioCtx.currentTime, 0.02);
  btnMute.textContent = isMuted ? "ğŸ”‡ Mute" : "ğŸ”ˆ Mute";
});

btnReset.addEventListener('click', ()=>{
  setLive(false);
  nodes = [];
  amp=ampSmooth=0;
  setStatus("RESET ì™„ë£Œ. ë‹¤ì‹œ Live Detect ì¼œê±°ë‚˜ ğŸ“¸ í•˜ì„¸ìš”.");
});

btnEnter.addEventListener('click', ()=>{
  document.getElementById('hint').style.display='none';
});

btnStartAudio.addEventListener('click', async ()=>{
  try{
    ensureAudio();
    await audioCtx.resume();
    await listMics();

    if(selAudioSrc.value==="mic"){
      const dev = selMic.disabled ? null : selMic.value;
      await startMic(dev);
      setStatus("Audio OK (mic). Start Camera â†’ Live Detect ON");
    }else{
      setStatus("Audio OK. íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
    }

    btnStartCam.disabled = false;
    btnEnter.disabled = false;
    btnCapture.disabled = false;
    btnClear.disabled = false;
    btnLive.disabled = false;
  }catch(e){
    console.error(e);
    setStatus("Start Audio ì‹¤íŒ¨. HTTPS/ê¶Œí•œ í™•ì¸");
  }
});

selMic.addEventListener('change', async ()=>{
  if(!audioCtx) return;
  if(selAudioSrc.value!=="mic") return;
  try{ await startMic(selMic.value); }catch(e){ console.warn(e); }
});

fileAudioInp.addEventListener('change', async ()=>{
  if(!audioCtx) { setStatus("Start Audio ë¨¼ì €!"); return; }
  if(selAudioSrc.value!=="file") return;
  const f = fileAudioInp.files && fileAudioInp.files[0];
  if(!f) return;
  await loadFile(f);
  setStatus(`íŒŒì¼ ë¡œë“œë¨: ${f.name}. Start Camera â†’ Live Detect ON`);
});

btnStartCam.addEventListener('click', async ()=>{
  try{
    await startCamera();
    setStatus("ì¹´ë©”ë¼ ON. Live Detect ON ë˜ëŠ” ğŸ“¸ ë²„íŠ¼");
    // âœ… ì¹´ë©”ë¼ ì¼œìë§ˆì í•œë²ˆ ìº¡ì²˜ë¡œ ì›Œë°ì—…(ì•„ì´í° ì²« í”„ë ˆì„ ê²€ì¶œ ì•ˆì •)
    setTimeout(()=>{ captureAndDetect(); }, 350);
  }catch(e){
    console.error(e);
    setStatus("ì¹´ë©”ë¼ ON ì‹¤íŒ¨. HTTPS/ê¶Œí•œ í™•ì¸");
  }
});

btnCapture.addEventListener('click', captureAndDetect);

btnClear.addEventListener('click', ()=>{
  nodes = [];
  setStatus("ë°•ìŠ¤/ë…¸ë“œ ì´ˆê¸°í™”");
});

btnLive.addEventListener('click', ()=> setLive(!liveOn));

/* iOS ì˜¤ë””ì˜¤ ì ê¸ˆ í•´ì œ */
addEventListener('pointerdown', async ()=>{
  try{ if(audioCtx && audioCtx.state==='suspended') await audioCtx.resume(); }catch(e){}
},{passive:true});

/* ==========================================================
   DRAW (âœ… ì¹´ë©”ë¼ ìœ„ë¥¼ â€œê²€ê²Œ ë®ì§€ ì•ŠìŒâ€: ë°ê¸° ë¬¸ì œ í•´ê²°)
   - ë°•ìŠ¤/ë¼ë²¨/ì /ë¼ì¸ì„ ìº”ë²„ìŠ¤ì—ì„œ ê·¸ë¦¼
   - nodesê°€ 0ì´ë©´ ë””ë²„ê·¸ìš© ë”ë¯¸ ë…¸ë“œ 1ê°œë¡œ ë¼ì¸/ì ì´ â€œë¬´ì¡°ê±´â€ ë³´ì´ê²Œ
========================================================== */
function draw(){
  requestAnimationFrame(draw);

  // âœ… ì”ìƒ/í˜ì´ë“œ ìµœì†Œ (ì¹´ë©”ë¼ê°€ ì–´ë‘ì›Œì§€ëŠ” ë¬¸ì œ ë°©ì§€)
  ctx.clearRect(0,0,W,H);

  if(audioCtx) updateAmp(); else amp = 0;

  const t = performance.now()*0.001;
  const a = amp;
  const lineSens = getLineSens();

  // âœ… ë””ë²„ê·¸: ë°•ìŠ¤ê°€ 0ì´ì–´ë„ â€œì /ë¼ì¸ì´ ë³´ì´ë„ë¡â€ (íŒŒì´í”„ë¼ì¸ ì²´í¬)
  // (ì›í•˜ë©´ ì•„ë˜ ë¸”ë¡ ì§€ì›Œë„ ë¨)
  if(nodes.length === 0){
    const x = W*0.5 + Math.sin(t*0.7)*140;
    const y = H*0.5 + Math.cos(t*0.9)*140;
    // ë°•ìŠ¤ê°€ ì—†ì„ ë•ŒëŠ” ì•„ì£¼ ì•½í•˜ê²Œë§Œ í‘œì‹œ
    ctx.save();
    ctx.globalAlpha = 0.35;
    ctx.fillStyle = "#fff";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, monospace";
    ctx.fillText("boxes:0 (debug node active) â†’ Live Detect ON / ğŸ“¸", 14, 64);
    ctx.restore();

    // ë”ë¯¸ ë…¸ë“œ 1ê°œ
    // (ë¼ì¸ì€ 2ê°œ ì´ìƒì´ í•„ìš”í•˜ë‹ˆ, 2ê°œë¥¼ ë§Œë“¤ì–´ì¤Œ)
    const x2 = W*0.5 + Math.sin(t*0.7+1.3)*180;
    const y2 = H*0.5 + Math.cos(t*0.9+1.1)*180;
    nodes = [
      {bx:x-40, by:y-60, bw:80, bh:120, x, y, vx:0, vy:0, cls:"debug", score:1, seed:1234},
      {bx:x2-40, by:y2-60, bw:80, bh:120, x:x2, y:y2, vx:0, vy:0, cls:"debug", score:1, seed:5678},
    ];
  }

  // node physics (ê¿€ë )
  for(const n of nodes){
    const wob = (Math.sin(t*1.7 + n.seed)*0.5 + 0.5);
    const wob2 = (Math.cos(t*1.2 + n.seed*1.7)*0.5 + 0.5);
    const push = (0.6 + a*3.2) * 22;

    const fx = (wob-0.5) * push;
    const fy = (wob2-0.5) * push;

    const cx = n.bx + n.bw*0.5;
    const cy = n.by + n.bh*0.5;
    const pull = 0.014 + a*0.034;

    n.vx += fx;
    n.vy += fy;
    n.vx += (cx - n.x) * pull;
    n.vy += (cy - n.y) * pull;

    n.vx *= 0.82 - a*0.08;
    n.vy *= 0.82 - a*0.08;

    n.x += n.vx;
    n.y += n.vy;

    n.x = Math.max(8, Math.min(W-8, n.x));
    n.y = Math.max(8, Math.min(H-8, n.y));
  }

  // lines
  const maxDist = (120 + a*520*lineSens);
  const maxDist2 = maxDist*maxDist;
  let lines=0;
  const maxLines = Math.floor(80 + a*320*lineSens);

  for(let i=0;i<nodes.length;i++){
    for(let j=i+1;j<nodes.length;j++){
      if(lines>=maxLines) break;
      const A = nodes[i], B = nodes[j];
      const dx=A.x-B.x, dy=A.y-B.y;
      const d2=dx*dx+dy*dy;
      if(d2<maxDist2){
        const d = Math.sqrt(d2);
        const k = 1 - d/maxDist;
        const alpha = Math.min(1, (0.12 + a*0.95) * k);

        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.strokeStyle = "rgba(255,255,255,0.95)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(A.x, A.y);
        ctx.lineTo(B.x, B.y);
        ctx.stroke();
        ctx.restore();
        lines++;
      }
    }
  }

  // boxes + labels + node dots
  for(const n of nodes){
    // âœ… ë°•ìŠ¤ê°€ í™•ì‹¤íˆ ë³´ì´ë„ë¡ ë¼ì„
    ctx.save();
    ctx.globalAlpha = Math.min(1, 0.25 + a*0.95);
    ctx.strokeStyle = "rgba(0,255,120,0.95)";
    ctx.lineWidth = 2;
    ctx.strokeRect(n.bx, n.by, n.bw, n.bh);

    // dot (red)
    ctx.globalAlpha = Math.min(1, 0.35 + a*0.95);
    ctx.fillStyle = "#ff3b3b";
    const r = 3 + a*10;
    ctx.beginPath();
    ctx.arc(n.x, n.y, r, 0, Math.PI*2);
    ctx.fill();

    // label
    ctx.globalAlpha = 0.85;
    ctx.fillStyle = "#fff";
    ctx.font = "11px ui-monospace, SFMono-Regular, Menlo, monospace";
    const txt = `${n.cls} ${(n.score*100).toFixed(0)}%`;
    ctx.fillText(txt, n.bx+4, Math.max(12, n.by-6));
    ctx.restore();
  }

  const aud = audioCtx ? audioCtx.state : "off";
  const cam = camOn ? "on" : "off";
  const mdl = modelReady ? "ready" : "loading";
  pillEl.textContent = `audio:${aud} | cam:${cam} | model:${mdl} | boxes:${nodes.length} | amp:${amp.toFixed(3)} | th:${getScoreTh().toFixed(2)} | w:${getDetectW()}`;

  hudEl.textContent =
`amp:${amp.toFixed(3)}  lineSens:${getLineSens().toFixed(2)}  detectW:${getDetectW()}  scoreTh:${getScoreTh().toFixed(2)}
liveDetect:${liveOn?"ON":"OFF"}  nodes:${nodes.length}
TIP: ì•„ì´í°ì€ detectW=240, scoreTh=0.20~0.30 ê¶Œì¥. Live ONì´ ëŠë¦¬ë©´ OFF í›„ ğŸ“¸ ê°„í— ìº¡ì²˜`;
}

/* ==========================================================
   STARTUP
========================================================== */
setStatus("ëª¨ë¸ ë¡œë”© ì¤‘â€¦");
loadModel();
draw();

/* âœ… ì´ˆê¸°ê°’: ì•„ì´í°ì—ì„œ ë°•ìŠ¤ê°€ ì•ˆ ì¡íˆëŠ” ê²½ìš°ê°€ ë§ì•„ì„œ,
   - detectW=240
   - scoreTh=0.25
   - (ì›í•˜ë©´ ì—¬ê¸°ì„œ Live Detectë¥¼ ìë™ ONìœ¼ë¡œ ê°•ì œí•  ìˆ˜ë„ ìˆìŒ) */
(function initLabels(){
  txtDetectW.textContent = `detect width: ${getDetectW()}px (ì•„ì´í° ì¶”ì²œ)`;
  txtScore.textContent = `score threshold: ${getScoreTh().toFixed(2)}`;
  txtLineSens.textContent = `line sens: ${getLineSens().toFixed(2)}Ã—`;
  txtAmpSens.textContent = `amp sens: ${getAmpSens().toFixed(1)}Ã—`;
})();

window.addEventListener('pagehide', ()=>{
  try{ setLive(false); }catch(e){}
  try{
    if(camVideo.srcObject){
      camVideo.srcObject.getTracks().forEach(t=>t.stop());
    }
  }catch(e){}
  try{ stopMic(); }catch(e){}
  try{ stopFile(); }catch(e){}
});
</script>
</body>
</html>