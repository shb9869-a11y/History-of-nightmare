<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LIMEN WORKSHOP â€“ Camera Boxes + Audio Reactive Lines (iPhone Test)</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden;touch-action:none;}
  #camVideo{
    position:fixed; inset:0;
    width:100vw; height:100vh;
    object-fit:cover;
    opacity:1;            /* âœ… ì¹´ë©”ë¼ ë³´ì´ê²Œ */
    pointer-events:none;
    z-index:1;
  }
  canvas{
    position:fixed; inset:0;
    display:block;width:100vw;height:100vh;
    z-index:2;
  }

  /* Entry */
  #hint{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.72);
    color:#ddd; font-family:system-ui, -apple-system, sans-serif;
    text-align:center; padding:20px;
    z-index:50;
  }
  #hint .box{
    width:min(760px, 94vw);
    border:1px solid rgba(255,255,255,.12);
    border-radius:14px;
    padding:18px 16px;
    background:rgba(0,0,0,.55);
    text-align:left;
  }
  button, select, input[type="range"]{
    background:#0f0f0f; color:#eee;
    border:1px solid rgba(255,255,255,.16);
    border-radius:10px;
    padding:10px 12px;
    font-weight:650;
    outline:none;
  }
  button:hover, select:hover{border-color:rgba(255,255,255,.32)}
  button:disabled, select:disabled{opacity:.5; cursor:not-allowed}

  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0;}
  .label{font-size:12px; color:#aaa; width:120px;}
  .grow{flex:1; min-width:220px;}
  .small{font-size:11px; color:#9aa; line-height:1.45;}

  /* Top controls */
  #top{
    position:fixed; left:12px; top:12px;
    display:flex; gap:8px; flex-wrap:wrap;
    z-index:40;
  }
  .pill{
    font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
    font-size:11px; color:#bbb;
    padding:8px 10px;
    border:1px solid rgba(255,255,255,.12);
    border-radius:999px;
    background:rgba(0,0,0,.28);
    backdrop-filter: blur(10px);
  }
  .iconBtn{
    height:38px;
    display:inline-flex; align-items:center; gap:8px;
    background:rgba(0,0,0,.38);
    color:#eee;
    border:1px solid rgba(255,255,255,.14);
    border-radius:12px;
    backdrop-filter: blur(10px);
    cursor:pointer;
    user-select:none;
    padding:0 12px;
    font-size:13px;
  }
  .iconBtn:active{transform:translateY(1px)}

  #hud{
    position:fixed; left:12px; bottom:12px;
    z-index:40;
    color:#ddd;
    font-family:ui-monospace, SFMono-Regular, Menlo, monospace;
    font-size:11px;
    background:rgba(0,0,0,.28);
    border:1px solid rgba(255,255,255,.10);
    border-radius:12px;
    padding:8px 10px;
    backdrop-filter: blur(10px);
    pointer-events:none;
    max-width:min(92vw, 520px);
    white-space:pre-wrap;
  }
</style>
</head>
<body>

<!-- Camera (visible) -->
<video id="camVideo" playsinline autoplay muted></video>
<canvas id="c"></canvas>

<!-- Entry -->
<div id="hint">
  <div class="box">
    <div style="font-weight:900;font-size:16px;margin-bottom:10px;">LIMEN WORKSHOP â€“ iPhone Test</div>
    <div class="small" style="margin-bottom:12px;">
      âœ… ì´ í˜ì´ì§€ëŠ” <b>HTTPS</b>ì—ì„œ ì—´ì–´ì•¼ ì¹´ë©”ë¼/ë§ˆì´í¬ê°€ ì •ìƒ ë™ì‘í•©ë‹ˆë‹¤.<br/>
      âœ… ìˆœì„œ: <b>Start Audio</b> â†’ <b>Start Camera</b> â†’ <b>Live Detect ON</b> (ë˜ëŠ” Capture í•œë²ˆ)<br/>
      âœ… ê²€ì¶œëœ ì‚¬ë¬¼/ì‚¬ëŒ ë°•ìŠ¤ê°€ ìƒê¸°ë©´, ê·¸ ì¤‘ì‹¬ì ë“¤ì´ <b>í˜„ì¥ ìˆ˜ìŒ(amp)</b>ì— ë°˜ì‘í•˜ë©° ê¿€ë  + ë¼ì¸ì´ ì—°ê²°ë©ë‹ˆë‹¤.
    </div>

    <div class="row">
      <button id="btnStartAudio">Start Audio</button>
      <button id="btnStartCam" disabled>Start Camera</button>
      <button id="btnEnter" disabled>Enter (Hide Entry)</button>
      <button id="btnFS">Fullscreen</button>
    </div>

    <div class="row">
      <div class="label">Audio input</div>
      <select id="selAudioSrc" class="grow">
        <option value="mic" selected>Mic (Live)</option>
        <option value="file">File (MP3/WAV)</option>
      </select>
    </div>

    <div class="row" id="rowMic">
      <div class="label">Mic device</div>
      <select id="selMic" class="grow" disabled><option>Start Audio í›„ ë¡œë“œ</option></select>
    </div>

    <div class="row" id="rowFile" style="display:none;">
      <div class="label">Audio file</div>
      <input id="fileAudio" class="grow" type="file" accept="audio/*">
    </div>

    <div class="row">
      <div class="label">Detect</div>
      <button id="btnLive" disabled>Live Detect: OFF</button>
      <button id="btnCapture" disabled>ğŸ“¸ Capture + Detect</button>
      <button id="btnClear" disabled>Clear Boxes</button>
    </div>

    <div class="row">
      <div class="label">Quality</div>
      <div class="grow">
        <input id="rngDetectW" type="range" min="240" max="640" step="10" value="320" style="width:100%;">
        <div class="small" id="txtDetectW">detect width: 320px (ì•„ì´í°ì´ë©´ 320~420 ì¶”ì²œ)</div>
      </div>
    </div>

    <div class="row">
      <div class="label">Line sens</div>
      <div class="grow">
        <input id="rngLineSens" type="range" min="0.6" max="3.0" step="0.01" value="1.55" style="width:100%;">
        <div class="small" id="txtLineSens">line sens: 1.55Ã—</div>
      </div>
    </div>

    <div class="row">
      <div class="label">Amp sens</div>
      <div class="grow">
        <input id="rngAmpSens" type="range" min="1" max="12" step="0.1" value="7.0" style="width:100%;">
        <div class="small" id="txtAmpSens">amp sens: 7.0Ã—</div>
      </div>
    </div>

    <div class="small" id="status">ëŒ€ê¸° ì¤‘â€¦</div>
  </div>
</div>

<!-- Top bar -->
<div id="top">
  <div class="iconBtn" id="btnMute">ğŸ”ˆ Mute</div>
  <div class="iconBtn" id="btnReset">âŸ² RESET</div>
  <div class="pill" id="pill">audio:off | cam:off | model:loading | boxes:0 | amp:0.000</div>
</div>

<div id="hud" id="hudText">hudâ€¦</div>

<!-- TFJS + COCO-SSD (ê°€ë²¼ìš´ í¸ / iPhoneì—ì„œ ê°„í—ì ìœ¼ë¡œ ëŠë¦´ ìˆ˜ ìˆìŒ) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>

<script>
/* =========================
   CANVAS / DPR
========================= */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d', { alpha:true });

let W=0,H=0,DPR=1;
function resize(){
  DPR = Math.max(1, Math.min(2, devicePixelRatio||1));
  W = innerWidth|0; H = innerHeight|0;
  canvas.width  = (W*DPR)|0;
  canvas.height = (H*DPR)|0;
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize', resize);
resize();

/* =========================
   UI refs
========================= */
const statusEl = document.getElementById('status');
const pillEl = document.getElementById('pill');
const hudEl = document.getElementById('hud');

const btnStartAudio = document.getElementById('btnStartAudio');
const btnStartCam   = document.getElementById('btnStartCam');
const btnEnter      = document.getElementById('btnEnter');
const btnFS         = document.getElementById('btnFS');

const selAudioSrc = document.getElementById('selAudioSrc');
const rowMic = document.getElementById('rowMic');
const rowFile = document.getElementById('rowFile');
const selMic = document.getElementById('selMic');
const fileAudioInp = document.getElementById('fileAudio');

const btnLive = document.getElementById('btnLive');
const btnCapture = document.getElementById('btnCapture');
const btnClear = document.getElementById('btnClear');
const btnMute = document.getElementById('btnMute');
const btnReset = document.getElementById('btnReset');

const rngDetectW = document.getElementById('rngDetectW');
const txtDetectW = document.getElementById('txtDetectW');

const rngLineSens = document.getElementById('rngLineSens');
const txtLineSens = document.getElementById('txtLineSens');

const rngAmpSens = document.getElementById('rngAmpSens');
const txtAmpSens = document.getElementById('txtAmpSens');

function setStatus(t){ statusEl.textContent = t; }

/* =========================
   FULLSCREEN
========================= */
function toggleFullscreen(){
  const el = document.documentElement;
  if(!document.fullscreenElement) el.requestFullscreen?.();
  else document.exitFullscreen?.();
}
btnFS.addEventListener('click', toggleFullscreen);

/* =========================
   AUDIO (mic or file) â†’ amp
========================= */
let audioCtx=null, analyser=null, timeData=null;
let masterGain=null, preGain=null;
let micStream=null, micNode=null;
let fileEl=null, fileNode=null;

let isMuted=false;
let amp=0, ampSmooth=0;

function ensureAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  timeData = new Uint8Array(analyser.fftSize);

  masterGain = audioCtx.createGain();
  masterGain.gain.value = 0.9;

  preGain = audioCtx.createGain();
  preGain.gain.value = 1.0;

  preGain.connect(analyser);
  analyser.connect(masterGain);
  masterGain.connect(audioCtx.destination);
}

function getAmpSens(){ return Math.max(1, Math.min(12, parseFloat(rngAmpSens.value)||7)); }

function updateAmp(){
  if(!analyser) { amp=0; return; }
  analyser.getByteTimeDomainData(timeData);
  let sum=0;
  for(let i=0;i<timeData.length;i++){
    const v=(timeData[i]-128)/128;
    sum+=v*v;
  }
  const rms=Math.sqrt(sum/timeData.length);
  const boosted = Math.min(1, Math.pow(Math.max(0, rms * getAmpSens()), 0.85));
  ampSmooth += (boosted - ampSmooth) * 0.15;
  amp = ampSmooth;
}

async function listMics(){
  let devices=[];
  try{ devices = await navigator.mediaDevices.enumerateDevices(); }catch(e){}
  const mics = devices.filter(d=>d.kind==="audioinput");
  selMic.innerHTML="";
  if(!mics.length){
    selMic.disabled=true;
    selMic.innerHTML = "<option>ë§ˆì´í¬ ì—†ìŒ</option>";
    return;
  }
  selMic.disabled=false;
  for(const d of mics){
    const opt=document.createElement('option');
    opt.value=d.deviceId;
    opt.textContent=d.label || `Mic (${d.deviceId.slice(0,6)}â€¦)`;
    selMic.appendChild(opt);
  }
}

function stopMic(){
  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
  if(micNode){ try{ micNode.disconnect(); }catch(e){} micNode=null; }
}

function stopFile(){
  if(fileEl){ try{ fileEl.pause(); }catch(e){} }
  if(fileNode){ try{ fileNode.disconnect(); }catch(e){} fileNode=null; }
}

async function startMic(deviceId){
  ensureAudio();
  await audioCtx.resume();
  stopFile();
  stopMic();
  micStream = await navigator.mediaDevices.getUserMedia({
    audio:{
      deviceId: deviceId ? { exact: deviceId } : undefined,
      echoCancellation:false,
      noiseSuppression:false,
      autoGainControl:false
    }
  });
  micNode = audioCtx.createMediaStreamSource(micStream);
  micNode.connect(preGain);
}

function ensureFileEl(){
  if(fileEl) return;
  fileEl = new Audio();
  fileEl.loop = true;
  fileEl.playsInline = true;
  fileEl.crossOrigin = "anonymous";
}

async function loadFile(file){
  ensureAudio();
  await audioCtx.resume();
  stopMic();
  ensureFileEl();
  const url = URL.createObjectURL(file);
  fileEl.src = url;

  if(fileNode){ try{ fileNode.disconnect(); }catch(e){} fileNode=null; }
  fileNode = audioCtx.createMediaElementSource(fileEl);
  fileNode.connect(preGain);

  try{ await fileEl.play(); }catch(e){
    setStatus("íŒŒì¼ ì¬ìƒì´ ë§‰í˜: í™”ë©´ì„ í•œë²ˆ í„°ì¹˜/í´ë¦­ í›„ ë‹¤ì‹œ ì‹œë„");
  }
}

/* audio source ui */
function applyAudioUI(){
  const v = selAudioSrc.value;
  rowMic.style.display = (v==="mic") ? "" : "none";
  rowFile.style.display = (v==="file") ? "" : "none";
}
selAudioSrc.addEventListener('change', applyAudioUI);
applyAudioUI();

/* =========================
   CAMERA
========================= */
const camVideo = document.getElementById('camVideo');
let camOn=false;

async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{
      facingMode:{ ideal:"environment" },
      width:{ ideal:1280 },
      height:{ ideal:720 }
    },
    audio:false
  });
  camVideo.srcObject = stream;
  await camVideo.play();
  camOn=true;
}

/* =========================
   DETECTION (COCO-SSD)
========================= */
let model=null;
let modelReady=false;
let liveOn=false;
let liveTimer=null;

const capCanvas = document.createElement('canvas');
const capCtx = capCanvas.getContext('2d', { willReadFrequently:true });

function getDetectW(){
  return Math.max(240, Math.min(640, parseInt(rngDetectW.value,10)||320));
}

rngDetectW.addEventListener('input', ()=>{
  txtDetectW.textContent = `detect width: ${getDetectW()}px (ì•„ì´í°ì´ë©´ 320~420 ì¶”ì²œ)`;
});
rngLineSens.addEventListener('input', ()=>{
  txtLineSens.textContent = `line sens: ${parseFloat(rngLineSens.value).toFixed(2)}Ã—`;
});
rngAmpSens.addEventListener('input', ()=>{
  txtAmpSens.textContent = `amp sens: ${parseFloat(rngAmpSens.value).toFixed(1)}Ã—`;
});

function getLineSens(){ return Math.max(0.6, Math.min(3.0, parseFloat(rngLineSens.value)||1.55)); }

async function loadModel(){
  try{
    // iPhoneì—ì„œ CPU backendê°€ ë” ì•ˆì •ì ì¸ ê²½ìš°ê°€ ë§ìŒ (ëŠë¦¬ì§€ë§Œ í„°ì§ ë°©ì§€)
    await tf.setBackend('cpu');
    await tf.ready();
    model = await cocoSsd.load({ base:'lite_mobilenet_v2' }); // liteê°€ ë” ê°€ë²¼ì›€
    modelReady=true;
    setStatus("ëª¨ë¸ ë¡œë“œ ì™„ë£Œ. Start Camera â†’ Live Detect ON");
  }catch(e){
    console.error(e);
    setStatus("ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬/HTTPS í™•ì¸");
    modelReady=false;
  }
}

async function captureFrameToCanvas(){
  if(!camOn || !camVideo.videoWidth) return false;

  const dw = getDetectW();
  const vh = camVideo.videoHeight;
  const vw = camVideo.videoWidth;
  const dh = Math.round(dw * (vh/vw));

  capCanvas.width = dw;
  capCanvas.height = dh;

  capCtx.drawImage(camVideo, 0, 0, dw, dh);
  return true;
}

let nodes = []; // detected objects as moving nodes

function detectionsToNodes(dets){
  // dets: {bbox:[x,y,w,h], class, score}
  // normalize to screen coords
  const dw = capCanvas.width, dh = capCanvas.height;
  const sx = W / dw, sy = H / dh;

  const filtered = dets
    .filter(d => (d.score ?? 0) >= 0.45)
    .slice(0, 18);

  const newNodes = [];
  for(const d of filtered){
    const [x,y,w,h] = d.bbox;
    const cx = (x + w*0.5) * sx;
    const cy = (y + h*0.5) * sy;
    newNodes.push({
      cls: d.class,
      score: d.score,
      // box in screen coords
      bx: x*sx, by: y*sy, bw: w*sx, bh: h*sy,
      // moving center (start at center)
      x: cx, y: cy,
      vx: 0, vy: 0,
      seed: Math.random()*9999,
      born: performance.now(),
    });
  }

  // ì•ˆì •ì ìœ¼ë¡œ â€œíŠ¸ë˜í‚¹â€ ëŠë‚Œ: classê°€ ê°™ê³  ê°€ê¹Œìš´ ë…¸ë“œëŠ” ê¸°ì¡´ ì†ë„/ìœ„ì¹˜ ì¼ë¶€ ìœ ì§€
  for(const nn of newNodes){
    let best=null, bestD=1e9;
    for(const on of nodes){
      if(on.cls !== nn.cls) continue;
      const dx=on.x-nn.x, dy=on.y-nn.y;
      const d=dx*dx+dy*dy;
      if(d<bestD){ bestD=d; best=on; }
    }
    if(best && bestD < (120*120)){
      nn.x = best.x*0.6 + nn.x*0.4;
      nn.y = best.y*0.6 + nn.y*0.4;
      nn.vx = best.vx*0.7;
      nn.vy = best.vy*0.7;
      nn.seed = best.seed;
    }
  }

  nodes = newNodes;
}

async function detectOnCapturedFrame(){
  if(!modelReady || !model) return;
  const dets = await model.detect(capCanvas);
  detectionsToNodes(dets);
}

async function captureAndDetect(){
  if(!camOn) { setStatus("ì¹´ë©”ë¼ê°€ êº¼ì ¸ìˆìŒ"); return; }
  if(!modelReady) { setStatus("ëª¨ë¸ ë¡œë”© ì¤‘â€¦"); return; }
  const ok = await captureFrameToCanvas();
  if(!ok){ setStatus("ìº¡ì²˜ ì‹¤íŒ¨(ë¹„ë””ì˜¤ ì¤€ë¹„ ì•ˆë¨)"); return; }
  await detectOnCapturedFrame();
}

function setLive(on){
  liveOn = on;
  btnLive.textContent = `Live Detect: ${on ? "ON" : "OFF"}`;
  if(liveTimer){ clearInterval(liveTimer); liveTimer=null; }
  if(on){
    // ë„ˆë¬´ ìì£¼ ëŒë¦¬ë©´ iPhone í„°ì§ˆ ìˆ˜ ìˆìŒ (ê¸°ë³¸ 900ms)
    liveTimer = setInterval(async ()=>{
      if(!camOn || !modelReady) return;
      try{
        const ok = await captureFrameToCanvas();
        if(!ok) return;
        await detectOnCapturedFrame();
      }catch(e){
        console.warn(e);
      }
    }, 900);
  }
}

/* =========================
   ENTRY / BUTTON WIRING
========================= */
btnMute.addEventListener('click', ()=>{
  if(!audioCtx) return;
  isMuted = !isMuted;
  masterGain.gain.setTargetAtTime(isMuted?0:0.9, audioCtx.currentTime, 0.02);
  btnMute.textContent = isMuted ? "ğŸ”‡ Mute" : "ğŸ”ˆ Mute";
});

btnReset.addEventListener('click', ()=>{
  // â€œì™„ì „ ìƒˆë¡œê³ ì¹¨â€ ëŒ€ì‹  ì•ˆì „ ë¦¬ì…‹
  setLive(false);
  nodes = [];
  amp=ampSmooth=0;
  setStatus("RESET ì™„ë£Œ. Start Audio/Camera ë‹¤ì‹œ ì§„í–‰ ê°€ëŠ¥");
});

btnEnter.addEventListener('click', ()=>{
  document.getElementById('hint').style.display='none';
});

btnStartAudio.addEventListener('click', async ()=>{
  try{
    ensureAudio();
    await audioCtx.resume();
    await listMics();

    // ê¸°ë³¸: mic ì„ íƒì´ë©´ ë°”ë¡œ mic ì—°ê²°
    if(selAudioSrc.value==="mic"){
      const dev = selMic.disabled ? null : selMic.value;
      await startMic(dev);
      setStatus("Audio unlocked. Mic running. ì´ì œ Start Camera â†’ Live Detect ON");
    }else{
      setStatus("Audio unlocked. íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
    }

    btnStartCam.disabled = false;
    btnEnter.disabled = false;
    btnCapture.disabled = false;
    btnClear.disabled = false;
    btnLive.disabled = false;
  }catch(e){
    console.error(e);
    setStatus("Start Audio ì‹¤íŒ¨. HTTPS/ê¶Œí•œ í™•ì¸");
  }
});

selMic.addEventListener('change', async ()=>{
  if(!audioCtx) return;
  if(selAudioSrc.value!=="mic") return;
  try{ await startMic(selMic.value); }catch(e){ console.warn(e); }
});

fileAudioInp.addEventListener('change', async ()=>{
  if(!audioCtx) { setStatus("Start Audio ë¨¼ì €!"); return; }
  if(selAudioSrc.value!=="file") return;
  const f = fileAudioInp.files && fileAudioInp.files[0];
  if(!f) return;
  await loadFile(f);
  setStatus(`íŒŒì¼ ë¡œë“œë¨: ${f.name}. ì´ì œ Start Camera â†’ Live Detect ON`);
});

btnStartCam.addEventListener('click', async ()=>{
  try{
    await startCamera();
    setStatus("ì¹´ë©”ë¼ ON. Live Detect ON ë˜ëŠ” Capture ë²„íŠ¼ ëˆ„ë¥´ì„¸ìš”.");
  }catch(e){
    console.error(e);
    setStatus("ì¹´ë©”ë¼ ON ì‹¤íŒ¨. HTTPS/ê¶Œí•œ í™•ì¸");
  }
});

btnCapture.addEventListener('click', async ()=>{
  await captureAndDetect();
});

btnClear.addEventListener('click', ()=>{
  nodes = [];
  setStatus("ë°•ìŠ¤/ë…¸ë“œ ì´ˆê¸°í™”");
});

btnLive.addEventListener('click', ()=>{
  setLive(!liveOn);
});

/* iOSì—ì„œ ì˜¤ë””ì˜¤/ë¹„ë””ì˜¤ ì ê¸ˆ í’€ê¸°ìš© */
addEventListener('pointerdown', async ()=>{
  try{ if(audioCtx && audioCtx.state==='suspended') await audioCtx.resume(); }catch(e){}
},{passive:true});

/* =========================
   DRAW: boxes + wobble nodes + lines (audio reactive)
========================= */
function draw(){
  requestAnimationFrame(draw);

  // background fade (ê°€ë²¼ìš´ ì”ìƒ)
  ctx.fillStyle = "rgba(0,0,0,0.08)";
  ctx.fillRect(0,0,W,H);

  // audio amp update
  if(audioCtx) updateAmp(); else { amp=0; }

  // nodes physics (ê¿€ë )
  const t = performance.now()*0.001;
  const a = amp;
  const lineSens = getLineSens();

  // ë°•ìŠ¤/ë…¸ë“œ ì—†ìœ¼ë©´ ì•ˆë‚´ í…ìŠ¤íŠ¸ë§Œ
  if(nodes.length===0){
    ctx.save();
    ctx.globalAlpha = 0.75;
    ctx.fillStyle = "#fff";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, monospace";
    ctx.fillText("no boxes. Start Camera â†’ Live Detect ON (or ğŸ“¸)", 14, 64);
    ctx.restore();
  }

  // node update
  for(const n of nodes){
    const wob = (Math.sin(t*1.7 + n.seed)*0.5 + 0.5);
    const wob2 = (Math.cos(t*1.2 + n.seed*1.7)*0.5 + 0.5);
    const push = (0.6 + a*3.2) * 24;

    // noise-like force
    const fx = (wob-0.5) * push;
    const fy = (wob2-0.5) * push;

    // center pull to its current detected box center (box center)
    const cx = n.bx + n.bw*0.5;
    const cy = n.by + n.bh*0.5;
    const pull = 0.015 + a*0.035;

    n.vx += fx;
    n.vy += fy;
    n.vx += (cx - n.x) * pull;
    n.vy += (cy - n.y) * pull;

    // damping
    n.vx *= 0.82 - a*0.10;
    n.vy *= 0.82 - a*0.10;

    n.x += n.vx;
    n.y += n.vy;

    // screen bounds
    n.x = Math.max(8, Math.min(W-8, n.x));
    n.y = Math.max(8, Math.min(H-8, n.y));
  }

  // lines between nodes
  const maxDist = (120 + a*480*lineSens);
  const maxDist2 = maxDist*maxDist;
  let lines=0;
  const maxLines = Math.floor(60 + a*260*lineSens);

  for(let i=0;i<nodes.length;i++){
    for(let j=i+1;j<nodes.length;j++){
      if(lines>=maxLines) break;
      const A = nodes[i], B = nodes[j];
      const dx=A.x-B.x, dy=A.y-B.y;
      const d2=dx*dx+dy*dy;
      if(d2<maxDist2){
        const d = Math.sqrt(d2);
        const k = 1 - d/maxDist;
        const alpha = Math.min(1, (0.12 + a*0.9) * k);

        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.strokeStyle = "rgba(255,255,255,0.95)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(A.x, A.y);
        ctx.lineTo(B.x, B.y);
        ctx.stroke();
        ctx.restore();

        lines++;
      }
    }
  }

  // draw boxes + labels + node points
  for(const n of nodes){
    // box
    const glow = 0.20 + a*0.85;
    ctx.save();
    ctx.globalAlpha = glow;
    ctx.strokeStyle = "rgba(255,255,0,0.95)"; // ë…¸ë€ ë°•ìŠ¤ ëŠë‚Œ
    ctx.lineWidth = 2;
    ctx.strokeRect(n.bx, n.by, n.bw, n.bh);

    // node point (red)
    ctx.globalAlpha = Math.min(1, 0.35 + a*0.95);
    ctx.fillStyle = "#ff3b3b";
    const r = 3 + a*10;
    ctx.beginPath();
    ctx.arc(n.x, n.y, r, 0, Math.PI*2);
    ctx.fill();

    // label
    ctx.globalAlpha = 0.8;
    ctx.fillStyle = "#fff";
    ctx.font = "11px ui-monospace, SFMono-Regular, Menlo, monospace";
    const txt = `${n.cls} ${(n.score*100).toFixed(0)}%`;
    ctx.fillText(txt, n.bx+4, Math.max(12, n.by-6));
    ctx.restore();
  }

  // pill/hud
  const aud = audioCtx ? audioCtx.state : "off";
  const cam = camOn ? "on" : "off";
  const mdl = modelReady ? "ready" : "loading";
  pillEl.textContent = `audio:${aud} | cam:${cam} | model:${mdl} | boxes:${nodes.length} | amp:${amp.toFixed(3)}`;

  hudEl.textContent =
`amp: ${amp.toFixed(3)}   lineSens: ${getLineSens().toFixed(2)}   detectW: ${getDetectW()}px
liveDetect: ${liveOn ? "ON" : "OFF"}   nodes:${nodes.length}
tip: iPhone ëŠë¦¬ë©´ detectWë¥¼ 320~280ìœ¼ë¡œ ë‚®ì¶”ê³  Live Detectë¥¼ OFF í›„ ğŸ“¸ë¡œ ê°„í— ìº¡ì²˜`;
}

/* =========================
   MODEL LOAD AT START
========================= */
setStatus("ëª¨ë¸ ë¡œë”© ì¤‘â€¦ (ì²˜ìŒ 1íšŒ ë¡œë“œ)");
loadModel();
draw();

/* safety */
window.addEventListener('pagehide', ()=>{
  try{ setLive(false); }catch(e){}
  try{
    if(camVideo.srcObject){
      camVideo.srcObject.getTracks().forEach(t=>t.stop());
    }
  }catch(e){}
  try{ stopMic(); }catch(e){}
  try{ stopFile(); }catch(e){}
});
</script>
</body>
</html>