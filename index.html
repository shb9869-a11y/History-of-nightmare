<!DOCTYPE html>

<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì£¼ë¨¸ë‹ˆ ì† í”„ë¡œì‹œë‹ˆì—„</title>
<style>
/* CSS ìŠ¤íƒ€ì¼ /
body { margin: 0; background-color: black; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif; }
#video-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
#remoteVideo { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s; opacity: 0; / ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */ }
#message-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2em; text-align: center; }
</style>
</head>
<body>
<div id="video-container">
<video id="remoteVideo" autoplay playsinline></video>
<div id="message-overlay">ì—°ê²° ì¤‘...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/janus-gateway/docs/janus.js"></script>
<script>
    // =======================================================================
    // ğŸš¨ 1. ì„œë²„ ì£¼ì†Œ ì„¤ì • (ì—¬ê¸°ë¥¼ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤!)
    // =======================================================================
    const PUBLIC_IP = "34.64.231.115";

    // Node.js WebSocket ì œì–´ ì„œë²„ ì£¼ì†Œ (ON/OFF ì œì–´ ì‹ í˜¸ ìˆ˜ì‹ ìš©)
    const WS_SERVER_URL = "ws://" + PUBLIC_IP + ":8080"; 

    // Janus WebRTC ì‹œê·¸ë„ë§ URL (ì˜ìƒ í†µì‹ ìš©)
    // Janusì˜ WebSockets í¬íŠ¸ 8188ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    const JANUS_SERVER_URL = "ws://" + PUBLIC_IP + ":8188/janus"; 

    // OBSì—ì„œ ì„¤ì •í•  ìŠ¤íŠ¸ë¦¼ í‚¤ (OBSì—ì„œ ì„¤ì •í•  ì´ë¦„ê³¼ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤)
    const STREAM_KEY = "my_live_stream"; 
    // =======================================================================
    
    let janus = null;
    let streamingHandle = null;
    let ws = null;
    let videoElement = document.getElementById('remoteVideo');
    let messageOverlay = document.getElementById('message-overlay');
    let currentStatus = 'OFF';

    // --- WebSocket (ON/OFF ì œì–´) ì—°ê²° ---
    function setupWebSocket() {
        if (ws) ws.close();
        
        ws = new WebSocket(WS_SERVER_URL);

        ws.onopen = () => {
            console.log("[WS] Connected to control server.");
            messageOverlay.textContent = "ì˜ìƒì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";
            // ì—°ê²° í›„ Janus ì—°ê²° ì‹œì‘ (ì œì–´ ì„œë²„ê°€ ì¼œì ¸ ìˆì„ ë•Œë§Œ ì˜ìƒ ì—°ê²° ì‹œë„)
            Janus.init({ callback: initJanus });
        };

        ws.onmessage = (event) => {
            const message = event.data;
            console.log("[WS] Received:", message);
            
            if (message === 'PROJECTION_ON' && currentStatus !== 'ON') {
                startStreaming();
                currentStatus = 'ON';
            } else if (message === 'PROJECTION_OFF' && currentStatus !== 'OFF') {
                stopStreaming();
                currentStatus = 'OFF';
            }
        };

        ws.onclose = () => {
            console.log("[WS] Disconnected. Retrying in 3s...");
            messageOverlay.textContent = "ì„œë²„ ì—°ê²° ëŠê¹€. ì¬ì—°ê²° ì¤‘...";
            setTimeout(setupWebSocket, 3000);
        };

        ws.onerror = (error) => {
            console.error("[WS ERROR]", error);
            messageOverlay.textContent = "ì œì–´ ì„œë²„ ì˜¤ë¥˜.";
        };
    }
    
    // --- Janus ì´ˆê¸°í™” ë° ì—°ê²° ---
    function initJanus() {
        janus = new Janus({
            server: JANUS_SERVER_URL,
            success: () => {
                console.log("[Janus] Connected.");
                janus.attach({
                    plugin: "janus.plugin.streaming",
                    success: (handle) => {
                        streamingHandle = handle;
                        console.log("[Janus] Attached to Streaming Plugin.");
                        // WebSocketì´ ì—´ë ¤ìˆë‹¤ë©´, ì´ˆê¸° ìƒíƒœì—ì„œ ìŠ¤íŠ¸ë¦¬ë°ì„ ë°”ë¡œ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        if (currentStatus === 'ON') {
                            startStreaming();
                        }
                    },
                    error: (error) => {
                        console.error("[Janus Error] Error attaching plugin:", error);
                        messageOverlay.textContent = "ì˜ìƒ ì„œë²„ ì˜¤ë¥˜.";
                    },
                    onmessage: handleJanusMessage,
                    onremotestream: (stream) => {
                        console.log("[Janus] Remote Stream received.");
                        videoElement.srcObject = stream;
                        videoElement.play();
                        videoElement.style.opacity = 1; 
                        messageOverlay.style.display = 'none';
                    },
                    oncleanup: () => {
                        console.log("[Janus] Cleanup finished.");
                        videoElement.srcObject = null;
                        videoElement.style.opacity = 0;
                        messageOverlay.style.display = 'block';
                        messageOverlay.textContent = "ì—°ê²° í•´ì œë¨.";
                    }
                });
            },
            error: (error) => {
                console.error("[Janus Error] Failed to connect:", error);
                messageOverlay.textContent = "ì˜ìƒ ì„œë²„ ì—°ê²° ì˜¤ë¥˜. 5ì´ˆ í›„ ì¬ì‹œë„...";
                setTimeout(initJanus, 5000);
            },
            destroyed: () => {
                console.log("[Janus] Destroyed. Reinitializing...");
                setTimeout(setupWebSocket, 1000);
            }
        });
    }
    
    function handleJanusMessage(msg, jsep) {
        if (jsep) {
            streamingHandle.createAnswer({
                jsep: jsep,
                media: { audioSend: false, videoSend: false, data: false },
                success: (answer) => {
                    streamingHandle.send({ message: { request: "start" }, jsep: answer });
                    console.log("[Janus] Answer sent.");
                },
                error: (error) => {
                    console.error("[Janus Error] WebRTC Answer creation failed:", error);
                }
            });
        }
    }

    // --- ìŠ¤íŠ¸ë¦¬ë° ì œì–´ í•¨ìˆ˜ ---
    function startStreaming() {
        if (streamingHandle) {
            const body = {
                request: "watch",
                id: STREAM_KEY 
            };
            streamingHandle.send({ message: body });
            messageOverlay.textContent = "ì˜ìƒ ìˆ˜ì‹  ì¤‘...";
            messageOverlay.style.display = 'block'; 
        }
    }

    function stopStreaming() {
        if (streamingHandle) {
            streamingHandle.send({ message: { request: "stop" } });
            videoElement.style.opacity = 0; 
            messageOverlay.style.display = 'block';
            messageOverlay.textContent = "ì˜ìƒ êº¼ì§.";
        }
    }

    // ì´ˆê¸° ì‹œì‘
    setupWebSocket();
</script>

</body>
</html>
