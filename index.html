<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>BOX DETECT</title>

<!-- iOS 홈화면 앱처럼 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BOX DETECT">
<meta name="theme-color" content="#000000">

<!-- TFJS + COCO-SSD -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>

<style>
html,body{
  margin:0; height:100%;
  background:#000; color:#ddd;
  font-family:system-ui,-apple-system,sans-serif;
  overflow:hidden;
}
#wrap{position:fixed; inset:0;}
video,canvas{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit:cover;
}

/* 카메라 흑백 */
#video{
  filter: grayscale(1) contrast(1.15) brightness(1.05);
}

/* UI 패널 */
#ui{
  position:fixed; top:12px; left:12px; right:12px;
  display:flex; flex-wrap:wrap; gap:10px; align-items:center;
  z-index:10;
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px;
  padding:10px 12px;
  backdrop-filter: blur(8px);
  transition:.2s;
}
#ui.hidden{
  opacity:0; pointer-events:none;
  transform:translateY(-10px);
}
.pill{
  display:flex; gap:8px; align-items:center;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.1);
  border-radius:999px;
  padding:8px 10px;
}

button{
  appearance:none;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.08);
  color:#fff;
  padding:8px 12px;
  border-radius:12px;
  font-weight:600;
}
button:active{transform:translateY(1px);}
input[type=range]{width:120px}

/* 메뉴 토글 버튼 */
#toggleUI{
  position:fixed; top:12px; right:12px;
  z-index:11;
  border-radius:999px;
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.12);
  padding:10px 12px;
  backdrop-filter: blur(8px);
}

/* 시작 게이트 */
#gate{
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.78);
  z-index:20;
}
#gate .box{
  width:min(720px,94vw);
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.12);
  border-radius:16px;
  padding:16px;
}
#gate h1{margin:0 0 6px; font-size:18px;}
#gate p{margin:6px 0; font-size:14px; color:#ccc;}

#log{
  position:fixed; left:12px; bottom:12px;
  z-index:10;
  font-size:12px;
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.12);
  border-radius:12px;
  padding:8px 10px;
  backdrop-filter: blur(8px);
}
</style>
</head>

<body>
<div id="wrap">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
</div>

<button id="toggleUI">☰ 메뉴</button>

<div id="ui">
  <div class="pill">
    <b>감도</b>
    <input id="conf" type="range" min="0.05" max="0.8" step="0.05" value="0.15">
    <span id="confVal">0.15</span>
  </div>

  <div class="pill">
    <label><input id="links" type="checkbox" checked> 선 연결</label>
  </div>

  <div class="pill">
    <b>N</b>
    <input id="topN" type="range" min="3" max="30" value="14">
    <span id="topNVal">14</span>
  </div>

  <div class="pill">
    <button id="flip">전/후면</button>
    <button id="restart">재시작</button>
  </div>

  <div class="pill">
    <span id="status">대기</span>
    <span id="fps">FPS -</span>
  </div>
</div>

<div id="log">ready</div>

<div id="gate">
  <div class="box">
    <h1>BOX DETECT</h1>
    <p>흑백 카메라 · 예민한 사물 인식 · 박스 연결</p>
    <button id="start">카메라 시작</button>
    <p style="font-size:12px;opacity:.8">
      iPhone: Safari → 공유 → 홈 화면에 추가
    </p>
  </div>
</div>

<script>
let model, stream, running=false;
let facingMode="environment";

const v = video, c = canvas, ctx = c.getContext("2d");

function resize(){
  c.width = v.videoWidth || innerWidth;
  c.height = v.videoHeight || innerHeight;
}

function center(b){ return {x:b[0]+b[2]/2, y:b[1]+b[3]/2}; }

function linkPoints(pts){
  const links=[];
  for(let i=0;i<pts.length;i++){
    let d=[];
    for(let j=0;j<pts.length;j++){
      if(i===j) continue;
      let dx=pts[i].x-pts[j].x, dy=pts[i].y-pts[j].y;
      d.push({j,dist:dx*dx+dy*dy});
    }
    d.sort((a,b)=>a.dist-b.dist);
    if(d[0] && i<d[0].j) links.push([i,d[0].j,d[0].dist]);
  }
  return links;
}

async function startCam(){
  stream && stream.getTracks().forEach(t=>t.stop());
  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:{ideal:facingMode}}, audio:false
  });
  v.srcObject = stream;
  await v.play();
  resize();
}

async function loop(){
  if(!running) return;
  let preds = await model.detect(v);
  const conf = +confEl.value;
  confVal.textContent = conf.toFixed(2);

  preds = preds.filter(p=>p.score>=conf)
               .sort((a,b)=>b.score-a.score)
               .slice(0,+topN.value);

  ctx.clearRect(0,0,c.width,c.height);

  const pts = preds.map(p=>center(p.bbox));

  if(links.checked){
    linkPoints(pts).forEach(([i,j,d])=>{
      const a=pts[i], b=pts[j];
      ctx.strokeStyle="rgba(255,255,255,.4)";
      ctx.beginPath();
      ctx.moveTo(a.x,a.y);
      ctx.lineTo(b.x,b.y);
      ctx.stroke();
    });
  }

  preds.forEach(p=>{
    const [x,y,w,h]=p.bbox;
    ctx.strokeStyle="yellow";
    ctx.strokeRect(x,y,w,h);
    ctx.fillStyle="#fff";
    ctx.beginPath();
    ctx.arc(x+w/2,y+h/2,3,0,Math.PI*2);
    ctx.fill();
  });

  requestAnimationFrame(loop);
}

start.onclick = async ()=>{
  gate.style.display="none";
  status.textContent="로딩";
  model = await cocoSsd.load({base:"lite_mobilenet_v2"});
  await startCam();
  running=true;
  status.textContent="실행중";
  loop();
};

flip.onclick = async ()=>{
  facingMode = facingMode==="environment"?"user":"environment";
  await startCam();
};

restart.onclick = ()=>{ running=false; running=true; loop(); };

toggleUI.onclick = ()=>{
  ui.classList.toggle("hidden");
  toggleUI.textContent = ui.classList.contains("hidden") ? "☰ 메뉴" : "✕ 닫기";
};

window.onresize = resize;
</script>
</body>
</html>