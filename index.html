<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>History of Nightmare — PWA + Rez 65% + Proscenium</title>

<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#000000">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --vwpx:100vw;--vhpx:100vh;
    --gap:32px;
    --line-color:rgba(255,255,255,.9);--line-w:1px;--line-r:2px;
    --ff-ui:"Courier New",Courier,monospace;
    --stage-fs:clamp(14px,2vmax,22px);
    --sub-fs:clamp(11px,1.5vmax,16px);
    --body-fs:clamp(12px,1.7vmax,18px);
    --btn-pad-y:.45em;--btn-pad-x:1em;--btn-border:1px;
    --letter-space:.03em;--line-height:1.45;
  }
  html,body{
    margin:0;height:100%;background:#000;color:#fff;overflow:hidden;
    font-family:var(--ff-ui);line-height:var(--line-height);
    -webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;
  }
  *,*::before,*::after{box-sizing:border-box}
  button{font:inherit;color:inherit;background:none;border:none;cursor:pointer}

  #view{position:fixed;left:0;top:0;width:var(--vwpx);height:var(--vhpx);z-index:0}
  #ninjaOverlay{position:fixed;left:50%;top:50%;width:var(--vwpx);height:var(--vhpx);
    transform:translate(-50%,-50%) scale(1);border:0;z-index:10;
    pointer-events:none;opacity:0;transition:opacity .35s ease;background:transparent}
  .proscenium{position:fixed;left:var(--gap);right:var(--gap);top:var(--gap);bottom:var(--gap);
    border:var(--line-w) solid var(--line-color);border-radius:var(--line-r);z-index:90}
  .controls{position:fixed;right:16px;bottom:16px;z-index:100;display:flex;gap:8px}
  .uiBtn{padding:.4em .8em;text-transform:uppercase;letter-spacing:var(--letter-space)}

  #overlay{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center}
  #overlayContent{text-align:center;transition:opacity .45s ease;
    display:flex;flex-direction:column;gap:12px;align-items:center;max-width:90vw}
  .hidden{opacity:0}
  .stageBtn{display:none;padding:var(--btn-pad-y) var(--btn-pad-x);
    border:var(--btn-border) solid #fff;text-transform:uppercase;font-size:var(--stage-fs)}
  .stageText{font-size:var(--stage-fs);letter-spacing:var(--letter-space)}
  .subText{font-size:var(--sub-fs);opacity:.95}

  #introWrap{display:none;text-align:left}
  #introWrap h2{text-align:center;margin:6px 0 10px}
  #introWrap ol{padding-left:1.2em;font-size:var(--body-fs)}
  #introWrap li{margin:.3em 0}
  #sleepBtn{margin-top:14px}

  #goodNight{display:none;margin-top:8px;font-size:var(--stage-fs)}
</style>
</head>
<body>
<canvas id="view"></canvas>
<iframe id="ninjaOverlay" allow="autoplay;fullscreen;camera;microphone" allowtransparency="true" src="about:blank"></iframe>
<div class="proscenium"></div>

<div class="controls">
  <button class="uiBtn" id="btnIn">IN</button>
  <button class="uiBtn" id="btnOut">OUT</button>
</div>

<div id="overlay">
  <div id="overlayContent">
    <div id="tapAnywhere" class="subText">화면을 가볍게 탭하여 <b>카메라 허용</b>을 진행해주세요</div>
    <button id="allowBtn" class="stageBtn">허용 버튼</button>
    <div id="allowSub" class="subText" style="display:none;">버튼을 눌러 브라우저의 카메라 권한 창을 띄우세요</div>
    <button id="welcomeBtn" class="stageBtn stageText">WELCOME TO HISTORY OF NIGHTMARE</button>
    <div id="welcomeSub" class="subText" style="display:none;">악몽의 역사에 오신 것을 환영합니다</div>

    <div id="introWrap">
      <h2 class="stageText">INTRODUCTION</h2>
      <ol>
        <li>안녕하세요. <b>크리에이티브 허브 모임</b>입니다.</li>
        <li>이 작품은 연출가 <b>손희범</b>이 2024년 11월 이후 지속된 악몽의 원인을 추적하는 여정입니다.</li>
        <li>여러분은 ‘악몽의 역사’를 함께 따라가는 <b>공동 발굴자</b>가 됩니다.</li>
      </ol>
      <ul class="tips">
        <li>휴대폰은 <b>가로 모드</b> 사용을 추천합니다.</li>
        <li>세 번 울린 뒤 아래 버튼을 눌러 <b>악몽 속으로</b> 진입하세요.</li>
      </ul>
      <button id="sleepBtn" class="stageBtn">PRESS&nbsp;HERE&nbsp;TO&nbsp;SLEEP</button>
    </div>

    <div id="goodNight" class="stageText">GOOD NIGHT. HAVE A NICE DREAM.</div>
  </div>
</div>

<script>
if("serviceWorker" in navigator)navigator.serviceWorker.register("/sw.js").catch(console.warn);

async function goFullscreen(){
  const el=document.documentElement;
  if(el.requestFullscreen)await el.requestFullscreen();
  else if(el.webkitRequestFullscreen)await el.webkitRequestFullscreen();
}

(()=>{

const CONFIG={ROOM_ID:"YOURROOMID",BLEND:0.5,REZ_SCALE:0.65};
const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)|| (navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1);

const view=document.getElementById('view'),vctx=view.getContext('2d',{alpha:false});
const ninja=document.getElementById('ninjaOverlay');
const btnIn=document.getElementById('btnIn'),btnOut=document.getElementById('btnOut');
const overlay=document.getElementById('overlay'),overlayContent=document.getElementById('overlayContent');
const tapAnywhere=document.getElementById('tapAnywhere');
const allowBtn=document.getElementById('allowBtn'),allowSub=document.getElementById('allowSub');
const welcomeBtn=document.getElementById('welcomeBtn'),welcomeSub=document.getElementById('welcomeSub');
const introWrap=document.getElementById('introWrap'),sleepBtn=document.getElementById('sleepBtn');
const goodNight=document.getElementById('goodNight');

function setStep(step){
  tapAnywhere.style.display=(step===1)?'block':'none';
  const showAllow=(step===2)&&!isIOS;
  allowBtn.style.display=showAllow?'inline-block':'none';
  allowSub.style.display=showAllow?'block':'none';
  welcomeBtn.style.display=(step===3)?'inline-block':'none';
  welcomeSub.style.display=(step===3)?'block':'none';
  introWrap.style.display=(step===4)?'block':'none';
  sleepBtn.style.display=(step===4)?'inline-block':'none'; /* fix */
}

function fadeOutOverlay(afterMs=0){
  setTimeout(()=>{overlayContent.classList.add('hidden');
    setTimeout(()=>{overlay.style.display='none';},450);},afterMs);
}

let inputLock=false;
function lockInput(ms=300){inputLock=true;setTimeout(()=>inputLock=false,ms);}
function addTap(el,fn){el.addEventListener('pointerup',e=>{if(!inputLock)fn(e);},{passive:true});}

/* cam */
const cam=document.createElement('video');cam.autoplay=cam.muted=cam.playsInline=true;
const proc=document.createElement('canvas');const pctx=proc.getContext('2d',{willReadFrequently:true});
const PROC_SCALE=.6;
async function startCamera(){
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
  cam.srcObject=s;await cam.play();
}
function fitCamera(){
  const dpr=devicePixelRatio||1;view.width=innerWidth*dpr;view.height=innerHeight*dpr;
  proc.width=innerWidth*PROC_SCALE;proc.height=innerHeight*PROC_SCALE;
}
let looping=false;
function loop(){
  requestAnimationFrame(loop);
  const PW=proc.width,PH=proc.height; if(!PW)return;
  if(cam.readyState>=2){pctx.drawImage(cam,0,0,PW,PH);
    const img=pctx.getImageData(0,0,PW,PH),d=img.data;
    for(let i=0;i<d.length;i+=4){const g=(.3*d[i]+.59*d[i+1]+.11*d[i+2])|0;d[i]=d[i+1]=d[i+2]=g;}
    pctx.putImageData(img,0,0);
    vctx.drawImage(proc,0,0,innerWidth,innerHeight);
  }
}

/* overlay control */
function setOverlay(on){ninja.style.opacity=on?String(CONFIG.BLEND):'0';}

setStep(1);
addTap(tapAnywhere,async()=>{
  if(isIOS){await startCamera();fitCamera();if(!looping){looping=true;loop();}setStep(3);}
  else setStep(2);
});
addTap(allowBtn,async()=>{await startCamera();fitCamera();if(!looping){looping=true;loop();}setStep(3);});
addTap(welcomeBtn,()=>setStep(4));

addTap(sleepBtn,async()=>{
  await goFullscreen();
  setOverlay(true);
  introWrap.style.display='none';
  goodNight.style.display='block';
  fadeOutOverlay(3000);
});

})();
</script>
</body>
</html>
