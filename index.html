<script>
/* ===== PWA SW 등록 등은 기존 그대로 두세요 ===== */

/* ===== 전체화면 (Start 시도) ===== */
async function goFullscreen() {
  const el = document.documentElement;
  try {
    if (el.requestFullscreen) await el.requestFullscreen();
    else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
    else if (el.msRequestFullscreen) await el.msRequestFullscreen();
  } catch (e) {}
}

(()=> {
/* ===== Config ===== */
const CONFIG = { ROOM_ID:"YOURROOMID", HTTPS_ORIGIN:"", BLEND:0.5, REZ_SCALE:0.65 };

/* ===== iOS 판별 ===== */
const isIOS = (() => {
  const ua = navigator.userAgent || "";
  const touchMac = navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1;
  return /iPad|iPhone|iPod/.test(ua) || touchMac;
})();

/* ===== Refs ===== */
const view=document.getElementById('view');
const vctx=view.getContext('2d',{alpha:false});
const ninja=document.getElementById('ninjaOverlay');
const btnIn=document.getElementById('btnIn');
const btnOut=document.getElementById('btnOut');
const overlay=document.getElementById('overlay');
const overlayContent=document.getElementById('overlayContent');
const tapAnywhere=document.getElementById('tapAnywhere');
const allowBtn=document.getElementById('allowBtn');
const allowSub=document.getElementById('allowSub');
const startBtn=document.getElementById('startBtn');
const startSub=document.getElementById('startSub');
const msg=document.getElementById('msg');
const msgSub=document.getElementById('msgSub');
const diag=document.getElementById('diag');

/* ===== Viewport / HTTPS / VDO.Ninja / Camera 함수들은 기존 코드 유지 ===== */
function setViewportVars(){ /* ... 기존 코드 ... */ }
function scheduleLayoutRefresh(d=60){ /* ... 기존 코드 ... */ }
function fitCamera(){ /* ... 기존 코드 ... */ }
async function startCamera(){ /* ... 기존 코드 ... */ }
let _loop=false; function ensureLoop(){ /* ... 기존 코드 ... */ }
function applyRezScale(){ /* ... 기존 코드 ... */ }
const injectedCss=encodeURIComponent(`/* ... 기존 코드 ... */`);
const ninjaBase=`/* ... 기존 코드 ... */`;
const ninjaUrl=()=>`${ninjaBase}&ts=${Date.now()}`;
(function preloadOverlay(){ ninja.src=ninjaUrl(); })();
function setOverlay(on){ /* ... 기존 코드 ... */ }
/* HTTPS tryRedirect, copy/open 버튼 등 기존 코드 유지 */

/* ===== 입력 유틸 (pointerup만 사용 + 입력잠금) ===== */
let inputLock=false;
let userInteracted=false; // 👈 탭 발생 여부
function lockInput(ms=500){ inputLock=true; setTimeout(()=>{ inputLock=false; }, ms); }
function addTap(el, handler){
  el.addEventListener('pointerup', (e)=>{
    if(inputLock) return;
    userInteracted = true;      // 👈 최초 탭 기록
    handler(e);
  }, {passive:true});
}

/* ===== 단계 표시 ===== */
function setStep(step){
  tapAnywhere.style.display = (step===1)? 'block':'none';
  const showAllow = (step===2) && !isIOS;
  allowBtn.style.display     = showAllow ? 'inline-block':'none';
  allowSub.style.display     = showAllow ? 'block':'none';
  startBtn.style.display     = (step===3)? 'inline-block':'none';
  startSub.style.display     = (step===3)? 'block':'none';
  msg.style.display          = (step===4)? 'inline-block':'none';
  msgSub.style.display       = (step===4)? 'block':'none';
}
function fadeOutOverlay(afterMs=0){
  setTimeout(()=>{ overlayContent.classList.add('hidden'); setTimeout(()=>{ overlay.style.display='none'; }, 450); }, afterMs);
}

/* ===== 초기 단계는 무조건 1로 고정 (자동 진행 없음) ===== */
setStep(1);

/* ===== STEP 1: 안내 문구 "자체" 탭해야 진행 ===== */
addTap(tapAnywhere, async ()=>{
  if (getComputedStyle(tapAnywhere).display==='none') return;
  lockInput();
  // iOS는 탭하면 즉시 권한 팝업, 안드로이드는 허용 버튼 단계로
  if (isIOS){
    try{
      await startCamera(); fitCamera(); ensureLoop();
      setTimeout(()=>{ setStep(3); }, 50);
    }catch{
      tapAnywhere.innerHTML = '카메라 접근이 거부되었습니다. <b>설정 > 사파리 > 카메라</b>에서 허용 후 다시 시도하세요.';
    }
  }else{
    setTimeout(()=>{ setStep(2); }, 50);
  }
});

/* ===== STEP 2: 안드로이드 전용 허용 버튼 ===== */
addTap(allowBtn, async (e)=>{
  e.stopPropagation();
  if (getComputedStyle(allowBtn).display==='none') return;
  lockInput();
  try{
    await startCamera(); fitCamera(); ensureLoop();
    setTimeout(()=>{ setStep(3); }, 50);
  }catch{
    allowSub.innerHTML = '권한 요청이 거부되었습니다. <b>브라우저 설정에서 카메라 허용</b> 후 다시 시도하세요.';
  }
});

/* ===== STEP 3: Start → 전체화면 → STEP 4 ===== */
addTap(startBtn, async (e)=>{
  e.stopPropagation();
  if (getComputedStyle(startBtn).display==='none') return;
  lockInput();
  await goFullscreen();
  setTimeout(()=>{ setStep(4); }, 50);
  fadeOutOverlay(1200);
  setOverlay(true);
});

/* ===== 안드로이드 자동 진행 방지: 페이지 로드만으로는 어떤 것도 실행하지 않음 ===== */
/* (중요) 아래와 같은 '사전 권한 확인' 또는 '자동 카메라 시작' 코드는 제거했습니다.
(async function precheckPermission(){ ... })();  // ❌ 삭제
// 또한 startCamera()는 오직 위의 addTap 핸들러 내에서만 호출되도록 유지합니다.
*/

/* ===== 나머지(뷰포트, 가시성, HUD)는 기존 그대로 ===== */
})();
</script>
