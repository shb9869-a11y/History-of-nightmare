<!DOCTYPE html>

<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>주머니 속 프로시니엄</title>
<style>
/* CSS 스타일 /
body { margin: 0; background-color: black; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif; }
#video-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
#remoteVideo { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s; opacity: 0; / 초기에는 숨김 */ }
#message-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2em; text-align: center; }
</style>
</head>
<body>
<div id="video-container">
<video id="remoteVideo" autoplay playsinline></video>
<div id="message-overlay">연결 중...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/janus-gateway/docs/janus.js"></script>
<script>
    // =======================================================================
    // 🚨 1. 서버 주소 설정 (여기를 수정해야 합니다!)
    // =======================================================================
    const PUBLIC_IP = "34.64.231.115";

    // Node.js WebSocket 제어 서버 주소 (ON/OFF 제어 신호 수신용)
    const WS_SERVER_URL = "ws://" + PUBLIC_IP + ":8080"; 

    // Janus WebRTC 시그널링 URL (영상 통신용)
    // Janus의 WebSockets 포트 8188을 사용합니다.
    const JANUS_SERVER_URL = "ws://" + PUBLIC_IP + ":8188/janus"; 

    // OBS에서 설정할 스트림 키 (OBS에서 설정할 이름과 동일해야 합니다)
    const STREAM_KEY = "my_live_stream"; 
    // =======================================================================
    
    let janus = null;
    let streamingHandle = null;
    let ws = null;
    let videoElement = document.getElementById('remoteVideo');
    let messageOverlay = document.getElementById('message-overlay');
    let currentStatus = 'OFF';

    // --- WebSocket (ON/OFF 제어) 연결 ---
    function setupWebSocket() {
        if (ws) ws.close();
        
        ws = new WebSocket(WS_SERVER_URL);

        ws.onopen = () => {
            console.log("[WS] Connected to control server.");
            messageOverlay.textContent = "영상을 기다리는 중...";
            // 연결 후 Janus 연결 시작 (제어 서버가 켜져 있을 때만 영상 연결 시도)
            Janus.init({ callback: initJanus });
        };

        ws.onmessage = (event) => {
            const message = event.data;
            console.log("[WS] Received:", message);
            
            if (message === 'PROJECTION_ON' && currentStatus !== 'ON') {
                startStreaming();
                currentStatus = 'ON';
            } else if (message === 'PROJECTION_OFF' && currentStatus !== 'OFF') {
                stopStreaming();
                currentStatus = 'OFF';
            }
        };

        ws.onclose = () => {
            console.log("[WS] Disconnected. Retrying in 3s...");
            messageOverlay.textContent = "서버 연결 끊김. 재연결 중...";
            setTimeout(setupWebSocket, 3000);
        };

        ws.onerror = (error) => {
            console.error("[WS ERROR]", error);
            messageOverlay.textContent = "제어 서버 오류.";
        };
    }
    
    // --- Janus 초기화 및 연결 ---
    function initJanus() {
        janus = new Janus({
            server: JANUS_SERVER_URL,
            success: () => {
                console.log("[Janus] Connected.");
                janus.attach({
                    plugin: "janus.plugin.streaming",
                    success: (handle) => {
                        streamingHandle = handle;
                        console.log("[Janus] Attached to Streaming Plugin.");
                        // WebSocket이 열려있다면, 초기 상태에서 스트리밍을 바로 시도할 수 있습니다.
                        if (currentStatus === 'ON') {
                            startStreaming();
                        }
                    },
                    error: (error) => {
                        console.error("[Janus Error] Error attaching plugin:", error);
                        messageOverlay.textContent = "영상 서버 오류.";
                    },
                    onmessage: handleJanusMessage,
                    onremotestream: (stream) => {
                        console.log("[Janus] Remote Stream received.");
                        videoElement.srcObject = stream;
                        videoElement.play();
                        videoElement.style.opacity = 1; 
                        messageOverlay.style.display = 'none';
                    },
                    oncleanup: () => {
                        console.log("[Janus] Cleanup finished.");
                        videoElement.srcObject = null;
                        videoElement.style.opacity = 0;
                        messageOverlay.style.display = 'block';
                        messageOverlay.textContent = "연결 해제됨.";
                    }
                });
            },
            error: (error) => {
                console.error("[Janus Error] Failed to connect:", error);
                messageOverlay.textContent = "영상 서버 연결 오류. 5초 후 재시도...";
                setTimeout(initJanus, 5000);
            },
            destroyed: () => {
                console.log("[Janus] Destroyed. Reinitializing...");
                setTimeout(setupWebSocket, 1000);
            }
        });
    }
    
    function handleJanusMessage(msg, jsep) {
        if (jsep) {
            streamingHandle.createAnswer({
                jsep: jsep,
                media: { audioSend: false, videoSend: false, data: false },
                success: (answer) => {
                    streamingHandle.send({ message: { request: "start" }, jsep: answer });
                    console.log("[Janus] Answer sent.");
                },
                error: (error) => {
                    console.error("[Janus Error] WebRTC Answer creation failed:", error);
                }
            });
        }
    }

    // --- 스트리밍 제어 함수 ---
    function startStreaming() {
        if (streamingHandle) {
            const body = {
                request: "watch",
                id: STREAM_KEY 
            };
            streamingHandle.send({ message: body });
            messageOverlay.textContent = "영상 수신 중...";
            messageOverlay.style.display = 'block'; 
        }
    }

    function stopStreaming() {
        if (streamingHandle) {
            streamingHandle.send({ message: { request: "stop" } });
            videoElement.style.opacity = 0; 
            messageOverlay.style.display = 'block';
            messageOverlay.textContent = "영상 꺼짐.";
        }
    }

    // 초기 시작
    setupWebSocket();
</script>

</body>
</html>
